<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temp Tracker Pro v1.10.54 | Cristy's Pizza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #e9ecef 0%, #ced4da 50%, #adb5bd 100%);
            background-attachment: fixed;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        /* Mobile touch optimizations */
        .touch-manipulation {
            touch-action: manipulation;
        }
        
        /* Improve mobile text readability */
        @media (max-width: 640px) {
            h1, h2, h3 {
                line-height: 1.2;
            }
            
            /* Improve card spacing on mobile */
            .space-y-4 > * + * {
                margin-top: 1.5rem;
            }
            
            /* Better mobile padding */
            .glass-strong {
                padding: 1.5rem;
            }
        }
        
        /* Ensure buttons have proper touch targets */
        button, input[type="button"], input[type="number"] {
            min-height: 44px;
        }
        
        /* Mobile-specific button improvements */
        @media (max-width: 640px) {
            .glow-button {
                font-size: 1rem;
                font-weight: 600;
            }
            
            .btn-secondary {
                font-size: 0.95rem;
                font-weight: 500;
            }
        }
        
        body.dark { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #404040 100%);
        }
        
        .dark .glass-strong {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        .dark .dropdown-bg {
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark h1, .dark h2, .dark h3 {
            color: #f8f9fa !important;
        }
        
        /* Keep user names light in dark mode */
        .dark #dropdown-user-name,
        .dark #user-display-name {
            color: #f8f9fa !important;
        }
        
        /* Store modal background overlay - proper light/dark mode */
        #store-selection-modal {
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .dark #store-selection-modal {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        /* Store modal container - light mode: #fafbfb, dark mode: dark */
        #store-selection-modal > div {
            background-color: #fafbfb !important;
            border-color: #d1d5db !important;
        }
        
        .dark #store-selection-modal > div {
            background-color: #1f1f1f !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        /* Profile Settings Modal - proper light/dark mode */
        #profile-settings-modal {
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .dark #profile-settings-modal {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        /* Profile Settings Modal container - light mode: white background, dark mode: dark */
        #profile-settings-modal > div {
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }
        
        .dark #profile-settings-modal > div {
            background-color: #1f1f1f !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Store modal title and close button text */
        #store-selection-modal h3 {
            color: #111827 !important;
        }
        
        .dark #store-selection-modal h3 {
            color: #f9fafb !important;
        }
        
        /* Store modal items - proper light mode styling */
        #store-selection-modal .store-modal-item {
            background-color: #ffffff !important;
            border: 2px solid #d1d5db !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
        }
        
        #store-selection-modal .store-modal-item:hover {
            background-color: #f9fafb !important;
            border-color: #9ca3af !important;
        }
        
        /* Store modal items - dark mode styling */
        .dark #store-selection-modal .store-modal-item {
            background-color: rgb(52, 52, 52) !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark #store-selection-modal .store-modal-item:hover {
            background-color: #4b5563 !important;
        }
        
        /* Fix text contrast - use exact hex colors requested */
        #store-selection-modal .store-modal-item h4 {
            color: #111827 !important;
        }
        
        #store-selection-modal .store-modal-item p {
            color: #111827 !important;
        }
        
        .dark #store-selection-modal .store-modal-item h4 {
            color: #f9fafb !important;
        }
        
        .dark #store-selection-modal .store-modal-item p {
            color: #d1d5db !important;
        }
        
        /* Theme Consistency - Proper contrast across light/dark modes */
        
        /* Store selector hover - text should remain visible on hover backgrounds */
        .store-selector-btn:hover #selected-store-name {
            color: #1f2937 !important; /* dark gray text on light hover background */
        }
        
        /* Notification z-index fix - appear above modal blur */
        #notification-container {
            z-index: 999999 !important;
        }
        
        /* Stats card numbers - dark mode only color fix */
        .dark #total-stores,
        .dark #equipment-count,
        .dark #in-range-count,
        .dark #alert-count {
            color: #a9b0b8 !important;
        }
        
        .dark .store-selector-btn:hover #selected-store-name {
            color: #f9fafb !important; /* light text on dark hover background */
        }
        
        .store-selector-btn:hover #selected-store-address {
            color: #4b5563 !important; /* medium gray text on light hover background */
        }
        
        .dark .store-selector-btn:hover #selected-store-address {
            color: #d1d5db !important; /* light gray text on dark hover background */
        }
        
        /* General theme consistency improvements */
        
        /* Consistent hover contrast for all elements */
        .hover-contrast:hover {
            color: #1f2937 !important;
        }
        
        .dark .hover-contrast:hover {
            color: #f9fafb !important;
        }
        
        /* User dropdown buttons - proper contrast */
        #user-dropdown button:hover {
            background-color: #f3f4f6 !important;
            color: #1f2937 !important;
        }
        
        .dark #user-dropdown button:hover {
            background-color: #374151 !important;
            color: #f9fafb !important;
        }
        
        /* Equipment management buttons - consistent theming */
        .equipment-item:hover {
            background-color: #f3f4f6;
        }
        
        .dark .equipment-item:hover {
            background-color: #374151;
        }
        
        .equipment-item:hover .equipment-name {
            color: #1f2937 !important;
        }
        
        .dark .equipment-item:hover .equipment-name {
            color: #f9fafb !important;
        }
        
        /* Store dropdown items - consistent theming */
        .store-item:hover {
            background-color: #f3f4f6;
        }
        
        .dark .store-item:hover {
            background-color: #374151;
        }
        
        .store-item:hover .store-name {
            color: #1f2937 !important;
        }
        
        .dark .store-item:hover .store-name {
            color: #f9fafb !important;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            /* Header font size optimized for mobile - already using text-xl */
            h1.text-xl {
                font-size: 1rem !important; /* Compact for mobile */
                line-height: 1.3 !important;
            }
            
            /* Header icon already optimized in HTML - mobile responsive */
            .header-icon {
                width: 1.25rem !important; /* h-5 equivalent for mobile */
                height: 1.25rem !important;
            }
            
            /* Reduce card padding on mobile */
            .equipment-card, .p-6 {
                padding: 0.75rem !important; /* p-3 equivalent */
            }
            
            /* Hide Select button on mobile */
            .store-select-btn {
                display: none !important;
            }
            
            /* Bottom Navigation Bar */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                z-index: 50;
                display: flex;
                justify-content: space-around;
                align-items: center;
                padding: 0.75rem 1rem;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
            }
            
            .dark .bottom-nav {
                background: rgba(17, 24, 39, 0.95);
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.3);
            }
            
            .bottom-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 0.5rem;
                border-radius: 0.75rem;
                transition: all 0.3s ease;
                min-width: 44px;
                min-height: 44px;
                cursor: pointer;
            }
            
            .bottom-nav-item:hover, .bottom-nav-item.active {
                background: rgba(58, 109, 55, 0.1);
                transform: translateY(-2px);
            }
            
            .bottom-nav-icon {
                width: 1.5rem;
                height: 1.5rem;
                padding: 0.25rem;
                border-radius: 0.5rem;
                margin-bottom: 0.25rem;
                background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));
                color: white;
            }
            
            .bottom-nav-text {
                font-size: 0.75rem;
                font-weight: 500;
                color: #6b7280;
            }
            
            .dark .bottom-nav-text {
                color: #9ca3af;
            }
            
            .bottom-nav-item.active .bottom-nav-text {
                color: rgb(58, 109, 55);
            }
            
            .dark .bottom-nav-item.active .bottom-nav-text {
                color: rgb(74, 135, 69);
            }
            
            /* Add bottom padding to main content when bottom nav is visible */
            main {
                padding-bottom: 6rem !important;
            }
            
        }
        
        /* Hide bottom navigation on desktop */
        @media (min-width: 769px) {
            .bottom-nav {
                display: none !important;
            }
            
            main {
                padding-bottom: 2rem !important;
            }
        }
        
        /* Floating Action Button (FAB) */
        @media (max-width: 768px) {
            .fab {
                position: fixed;
                bottom: 5.5rem; /* Above bottom nav */
                right: 1.5rem;
                z-index: 60;
                width: 3.5rem;
                height: 3.5rem;
                border-radius: 50%;
                background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));
                box-shadow: 0 8px 25px rgba(58, 109, 55, 0.4);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
                border: none;
                outline: none;
            }
            
            .fab:hover {
                transform: scale(1.1);
                box-shadow: 0 12px 35px rgba(58, 109, 55, 0.6);
            }
            
            .fab:active {
                transform: scale(0.95);
            }
            
            .fab svg {
                width: 1.75rem;
                height: 1.75rem;
                color: white;
            }
        }
        
        /* Hide FAB on desktop */
        @media (min-width: 769px) {
            .fab {
                display: none !important;
            }
        }
        
        /* Text contrast improvements - Headers and important text */
        
        /* Main header text - TempTracker Pro and subtitle */
        h1.text-xl {
            color: #111827 !important; /* very dark gray in light mode */
        }
        
        .dark h1.text-xl {
            color: #f9fafb !important; /* very light in dark mode */
        }
        
        /* Subtitle - Cristy's Pizza Modern Edition */
        .text-base.text-gray-600 {
            color: #374151 !important; /* darker gray for better visibility */
        }
        
        .dark .text-base.text-gray-600 {
            color: #e5e7eb !important; /* lighter gray in dark mode */
        }
        
        /* User dropdown text - name and store */
        #user-display-name {
            color: #111827 !important;
        }
        
        .dark #user-display-name {
            color: #f9fafb !important;
        }
        
        #user-current-store {
            color: #374151 !important;
        }
        
        .dark #user-current-store {
            color: #e5e7eb !important;
        }
        
        /* Profile Settings Modal - Light Mode Only Improvements */
        /* Only apply these styles in light mode, not dark mode */
        #profile-settings-modal:not(.dark) h3 {
            color: #111827 !important;
        }
        
        #profile-settings-modal:not(.dark) h4 {
            color: #111827 !important;
        }
        
        #profile-settings-modal:not(.dark) label {
            color: #374151 !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="text"],
        #profile-settings-modal:not(.dark) input[type="email"],
        #profile-settings-modal:not(.dark) select {
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
            color: #111827 !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="text"]:focus,
        #profile-settings-modal:not(.dark) input[type="email"]:focus,
        #profile-settings-modal:not(.dark) select:focus {
            border-color: #059669 !important;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important;
        }
        
        #profile-settings-modal:not(.dark) .bg-gray-50 {
            background-color: #f9fafb !important;
        }
        
        #profile-settings-modal:not(.dark) .text-gray-500 {
            color: #6b7280 !important;
        }
        
        #profile-settings-modal:not(.dark) .text-gray-600 {
            color: #4b5563 !important;
        }
        
        #profile-settings-modal:not(.dark) .text-gray-700 {
            color: #374151 !important;
        }
        
        #profile-settings-modal:not(.dark) .border-gray-200 {
            border-color: #e5e7eb !important;
        }
        
        #profile-settings-modal:not(.dark) .border-gray-300 {
            border-color: #d1d5db !important;
        }
        
        /* Profile Settings Modal - Light Mode Button and Tab Fixes */
        #profile-settings-modal:not(.dark) .profile-tab.active {
            border-color: #059669 !important;
            color: #059669 !important;
        }
        
        #profile-settings-modal:not(.dark) .profile-tab:hover {
            color: #047857 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="saveProfileSettings"] {
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="saveProfileSettings"]:hover {
            background-color: #047857 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="openProfileCamera"] {
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="openProfileCamera"]:hover {
            background-color: #047857 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="document.getElementById('profile-picture-input')"] {
            background-color: #6b7280 !important;
            border-color: #6b7280 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="document.getElementById('profile-picture-input')"]:hover {
            background-color: #4b5563 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="resetPassword"] {
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
            color: #374151 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="resetPassword"]:hover {
            background-color: #f9fafb !important;
            color: #111827 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="closeProfileModal"] {
            background-color: #ffffff !important;
            border-color: #d1d5db !important;
            color: #374151 !important;
        }
        
        #profile-settings-modal:not(.dark) button[onclick*="closeProfileModal"]:hover {
            background-color: #f9fafb !important;
            color: #111827 !important;
        }
        
        /* Checkbox and Radio Button Fixes - Light Mode Only */
        #profile-settings-modal:not(.dark) input[type="checkbox"] {
            accent-color: #059669 !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="radio"] {
            accent-color: #059669 !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="checkbox"]:checked {
            background-color: #059669 !important;
            border-color: #059669 !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e") !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="radio"]:checked {
            background-color: #059669 !important;
            border-color: #059669 !important;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e") !important;
        }
        
        #profile-settings-modal:not(.dark) input[type="checkbox"]:focus,
        #profile-settings-modal:not(.dark) input[type="radio"]:focus {
            border-color: #059669 !important;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1) !important;
        }
        
        /* Reset Password Notification - Higher Z-Index */
        #notification-container {
            z-index: 9999999 !important;
        }
        
        /* Override Browser Default Purple Colors for Form Elements */
        input[type="checkbox"]:checked {
            accent-color: #059669 !important;
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        input[type="radio"]:checked {
            accent-color: #059669 !important;
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        /* Profile Settings Specific Overrides */
        #profile-settings-modal input[type="checkbox"]:checked {
            accent-color: #059669 !important;
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        #profile-settings-modal input[type="radio"]:checked {
            accent-color: #059669 !important;
            background-color: #059669 !important;
            border-color: #059669 !important;
        }
        
        /* Store Access Items - Light Mode Colors */
        #profile-settings-modal:not(.dark) .store-access-item {
            background-color: #ffffff !important;
            border-color: #e5e7eb !important;
        }
        
        #profile-settings-modal:not(.dark) .store-access-item h5 {
            color: #111827 !important;
        }
        
        #profile-settings-modal:not(.dark) .store-access-item p {
            color: #4b5563 !important;
        }
        
        #profile-settings-modal:not(.dark) .store-access-item .store-address {
            color: #6b7280 !important;
        }
        
        /* Profile Settings Modal - Dark Mode Text Improvements */
        .dark #profile-settings-modal h3 {
            color: #f9fafb !important;
        }
        
        .dark #profile-settings-modal h4 {
            color: #f9fafb !important;
        }
        
        .dark #profile-settings-modal label {
            color: #e5e7eb !important;
        }
        
        .dark #profile-settings-modal input[type="text"],
        .dark #profile-settings-modal input[type="email"],
        .dark #profile-settings-modal select {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        .dark #profile-settings-modal input[type="text"]:focus,
        .dark #profile-settings-modal input[type="email"]:focus,
        .dark #profile-settings-modal select:focus {
            border-color: #059669 !important;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2) !important;
        }
        
        .dark #profile-settings-modal .text-gray-500 {
            color: #9ca3af !important;
        }
        
        .dark #profile-settings-modal .text-gray-600 {
            color: #d1d5db !important;
        }
        
        .dark #profile-settings-modal .text-gray-700 {
            color: #e5e7eb !important;
        }
        
        .dark #profile-settings-modal .border-gray-200 {
            border-color: #4b5563 !important;
        }
        
        .dark #profile-settings-modal .border-gray-300 {
            border-color: #4b5563 !important;
        }
        
        .dark #profile-settings-modal .bg-gray-50 {
            background-color: #374151 !important;
        }
        
        .dark #profile-settings-modal .bg-gray-800 {
            background-color: #1f2937 !important;
        }
        
        .dark #profile-settings-modal .border-gray-700 {
            border-color: #4b5563 !important;
        }
        
        /* Profile Settings Modal - Dark Mode Button Fixes */
        .dark #profile-settings-modal button[onclick*="resetPassword"] {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e7eb !important;
        }
        
        .dark #profile-settings-modal button[onclick*="resetPassword"]:hover {
            background-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        .dark #profile-settings-modal button[onclick*="closeProfileModal"] {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e7eb !important;
        }
        
        .dark #profile-settings-modal button[onclick*="closeProfileModal"]:hover {
            background-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        /* Profile Settings Modal - Dark Mode Store Access Fixes */
        .dark #profile-settings-modal .store-access-item {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
        }
        
        .dark #profile-settings-modal .store-access-item h5 {
            color: #f9fafb !important;
        }
        
        .dark #profile-settings-modal .store-access-item p {
            color: #d1d5db !important;
        }
        
        .dark #profile-settings-modal .store-access-item .store-address {
            color: #9ca3af !important;
        }
        
        /* Section headers - Select Store Location, Temperature Logging */
        h2.text-xl {
            color: #111827 !important;
        }
        
        .dark h2.text-xl {
            color: #f9fafb !important;
        }
        
        /* Temperature logging section text */
        #selected-store-temperature {
            color: #374151 !important;
        }
        
        .dark #selected-store-temperature {
            color: #e5e7eb !important;
        }
        
        /* Store details text */
        #selected-store-name {
            color: #111827 !important;
        }
        
        .dark #selected-store-name {
            color: #f9fafb !important;
        }
        
        #selected-store-address {
            color: #374151 !important;
        }
        
        .dark #selected-store-address {
            color: #e5e7eb !important;
        }
        
        /* Profile Settings and Admin Settings text fix */
        .text-gray-700.dark\:text-gray-200 {
            color: #374151 !important;
        }
        
        .dark .text-gray-700.dark\:text-gray-200 {
            color: #e5e7eb !important;
        }
        
        /* Better store selector hover - subtle and clean */
        .store-selector-btn:hover {
            background-color: rgba(59, 130, 246, 0.05) !important; /* very subtle blue tint */
        }
        
        .dark .store-selector-btn:hover {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        /* Icon hover effects - no background, just icon color change */
        button[onclick="toggleDarkMode()"]:hover {
            background-color: transparent !important;
        }
        
        button[onclick="toggleDarkMode()"]:hover svg {
            color: #059669 !important; /* green color on hover */
        }
        
        .dark button[onclick="toggleDarkMode()"]:hover svg {
            color: #10b981 !important;
        }
        
        /* Edit button hover - icon color only */
        button[title="Edit Store"]:hover,
        button[title="Edit Equipment"]:hover {
            background-color: transparent !important;
        }
        
        button[title="Edit Store"]:hover svg,
        button[title="Edit Equipment"]:hover svg {
            color: #0ea5e9 !important; /* blue color on hover */
        }
        
        .dark button[title="Edit Store"]:hover svg,
        .dark button[title="Edit Equipment"]:hover svg {
            color: #38bdf8 !important;
        }
        
        /* Chevron/dropdown arrow hover - icon color only */
        button[title="Select Store"]:hover {
            background-color: transparent !important;
        }
        
        button[title="Select Store"]:hover svg {
            color: #059669 !important;
        }
        
        .dark button[title="Select Store"]:hover svg {
            color: #10b981 !important;
        }
        
        /* General icon hover pattern override */
        .p-2.hover\:bg-gray-100:hover,
        .p-2.hover\:bg-gray-200:hover {
            background-color: transparent !important;
        }
        
        .dark .p-2.hover\:bg-gray-700:hover {
            background-color: transparent !important;
        }
        
        /* Trash/Delete button - icon color only on hover */
        button[title="Delete Equipment"]:hover,
        button[title="Delete Store"]:hover,
        .p-2.hover\:bg-red-100:hover {
            background-color: transparent !important;
        }
        
        button[title="Delete Equipment"]:hover svg,
        button[title="Delete Store"]:hover svg {
            color: #dc2626 !important; /* darker red on hover */
        }
        
        .dark button[title="Delete Equipment"]:hover svg,
        .dark button[title="Delete Store"]:hover svg {
            color: #ef4444 !important;
        }
        
        /* Keep Sign Out text red in both themes - more specific selector */
        button[onclick="handleLogout()"].text-red-600 {
            color: #dc2626 !important;
        }
        
        button[onclick="handleLogout()"].dark\:text-red-400 {
            color: #dc2626 !important;
        }
        
        .dark button[onclick="handleLogout()"] {
            color: #ef4444 !important;
        }
        
        /* Dark mode store dropdown improvements - make it look like light mode */
        
        /* Store dropdown background in dark mode - white like light mode */
        .dark #store-dropdown {
            background-color: #ffffff !important;
            color: #374151 !important;
        }
        
        /* Store items in dark mode - white background by default */
        .dark .store-item {
            background-color: #ffffff !important;
            color: #374151 !important;
            border-color: #e5e7eb !important;
        }
        
        /* Store item text in dark mode */
        .dark .store-item .store-name {
            color: #111827 !important;
        }
        
        .dark .store-item .text-gray-500 {
            color: #6b7280 !important;
        }
        
        /* Store item hover in dark mode - light green like light mode */
        .dark .store-item:hover {
            background-color: #f0f9ff !important; /* very light blue/green */
        }
        
        /* Store item hover text in dark mode */
        .dark .store-item:hover .store-name {
            color: #111827 !important;
        }
        
        .dark .store-item:hover .text-gray-500 {
            color: #6b7280 !important;
        }
        
        /* Drag handle in dark mode */
        .dark .store-item .drag-handle {
            color: #9ca3af !important;
        }
        
        .dark .store-item .drag-handle:hover {
            color: #6b7280 !important;
        }
        
        /* Store action buttons in dark mode */
        .dark .store-item button svg {
            color: #6b7280 !important;
        }
        
        .dark .store-item button:hover svg {
            color: #374151 !important;
        }
        
        /* Disable hover effects on temperature logging equipment cards */
        #temperature-list .card-hover:hover {
            transform: none !important;
            box-shadow: inherit !important;
            background: inherit !important;
        }
        
        .dark .text-gray-600 {
            color: #adb5bd !important;
        }
        
        .dark .text-gray-500 {
            color: #868e96 !important;
        }
        
        .dark .text-gray-700 {
            color: #e9ecef !important;
        }
        
        /* Legacy dark mode input styles - now handled by .form-input class */
        
        .dark .hover\\:bg-gray-50:hover {
            background-color: #495057 !important;
        }
        
        .dark .hover\\:bg-gray-100:hover {
            background-color: #495057 !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #495057 !important;
        }
        
        .dark #user-dropdown {
            background: rgba(30, 30, 30, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            z-index: 999999999 !important;
        }
        
        #user-dropdown {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            z-index: 999999999 !important;
            position: absolute !important;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }
        
        .dropdown-bg {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .floating {
            /* Removed floating animation */
        }
        
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Primary Button (Green) */
        .btn-primary {
            background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));
            box-shadow: 0 4px 15px rgba(58, 109, 55, 0.4);
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            box-shadow: 0 8px 25px rgba(58, 109, 55, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-primary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(58, 109, 55, 0.3);
        }
        
        /* Secondary Button (Gray) */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #d1d5db;
            color: #374151;
            font-weight: 500;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
            color: #111827;
        }
        
        .btn-secondary:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(156, 163, 175, 0.3);
        }
        
        /* Dark mode secondary button */
        .dark .btn-secondary {
            background: #374151;
            border-color: #6b7280;
            color: #f3f4f6;
        }
        
        .dark .btn-secondary:hover {
            background: #4b5563;
            border-color: #9ca3af;
        }
        
        /* Danger Button (Red) */
        .btn-danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            color: white;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.6);
            transform: translateY(-2px);
        }
        
        .btn-danger:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.3);
        }
        
        /* Small button variant */
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        /* Large button variant */
        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }
        
        /* Icon only button */
        .btn-icon {
            padding: 0.5rem;
            border-radius: 0.5rem;
        }
        
        /* Legacy glow-button support (maps to btn-primary) */
        .glow-button {
            background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));
            box-shadow: 0 4px 15px rgba(58, 109, 55, 0.4);
            transition: all 0.3s ease;
        }
        
        .glow-button:hover {
            box-shadow: 0 8px 25px rgba(58, 109, 55, 0.6);
            transform: translateY(-2px);
        }
        
        /* Form Input Standardization */
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #111827;
        }
        
        .form-input:focus {
            outline: none;
            border-color: rgb(58, 109, 55);
            box-shadow: 0 0 0 3px rgba(58, 109, 55, 0.1);
            background: rgba(255, 255, 255, 1);
        }
        
        .form-input::placeholder {
            color: #9ca3af;
        }
        
        /* Dark mode form inputs */
        .dark .form-input {
            background: #374151;
            border-color: #6b7280;
            color: #f3f4f6;
        }
        
        .dark .form-input:focus {
            background: #4b5563;
            border-color: rgb(58, 109, 55);
            box-shadow: 0 0 0 3px rgba(58, 109, 55, 0.2);
        }
        
        .dark .form-input::placeholder {
            color: #9ca3af;
        }
        
        /* Form validation states */
        .form-input.error {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
        }
        
        .dark .form-input.error {
            border-color: #dc2626;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }
        
        .form-input.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .dark .form-input.success {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        /* Form labels */
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .dark .form-label {
            color: #f3f4f6;
        }
        
        /* Responsive design enhancements */
        @media (max-width: 640px) {
            .btn-primary, .btn-secondary, .btn-danger {
                font-size: 0.875rem;
                padding: 0.625rem 1.25rem;
            }
            
            .form-input {
                font-size: 1rem; /* Prevent zoom on iOS */
                padding: 0.75rem;
            }
            
            .form-label {
                font-size: 0.875rem;
            }
        }
        
        /* Touch target improvements for mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn-icon {
                padding: 0.75rem;
                min-width: 44px;
                min-height: 44px;
            }
            
            button, .btn-primary, .btn-secondary, .btn-danger {
                min-height: 44px;
            }
        }
        
        /* Focus improvements for accessibility */
        .btn-primary:focus-visible, .btn-secondary:focus-visible, .btn-danger:focus-visible {
            outline: 2px solid currentColor;
            outline-offset: 2px;
        }
        
        .form-input:focus-visible {
            outline: 2px solid rgb(58, 109, 55);
            outline-offset: -2px;
        }
        
        .status-glow-good {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
            border: 2px solid rgba(34, 197, 94, 0.4);
        }
        
        .status-glow-warning {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            border: 2px solid rgba(251, 191, 36, 0.5);
        }
        
        .status-glow-critical {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .status-glow-unknown {
            box-shadow: 0 0 15px rgba(156, 163, 175, 0.2);
            border: 2px solid rgba(156, 163, 175, 0.3);
        }
        
        /* Status icon glow effects */
        .status-icon-glow-good {
            filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.6));
            animation: pulse-good 2s infinite;
        }
        
        .status-icon-glow-warning {
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
            animation: pulse-warning 2s infinite;
        }
        
        .status-icon-glow-critical {
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6));
            animation: pulse-critical 1.5s infinite;
        }
        
        .status-icon-glow-unknown {
            filter: drop-shadow(0 0 8px rgba(156, 163, 175, 0.4));
        }
        
        @keyframes pulse-good {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(34, 197, 94, 0.6)); }
            50% { filter: drop-shadow(0 0 12px rgba(34, 197, 94, 0.8)); }
        }
        
        @keyframes pulse-warning {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6)); }
            50% { filter: drop-shadow(0 0 12px rgba(251, 191, 36, 0.8)); }
        }
        
        @keyframes pulse-critical {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6)); }
            50% { filter: drop-shadow(0 0 12px rgba(239, 68, 68, 0.9)); }
        }
        
        /* Equipment history modal - same styling as store modal */
        #equipment-history-modal {
            background: rgba(0, 0, 0, 0.3) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .dark #equipment-history-modal {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        #equipment-history-modal > div {
            background-color: #fafbfb !important;
            border-color: #d1d5db !important;
        }
        
        .dark #equipment-history-modal > div {
            background-color: #1f1f1f !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        #equipment-history-modal h3 {
            color: #111827 !important;
        }
        
        .dark #equipment-history-modal h3 {
            color: #f9fafb !important;
        }
        
        #equipment-history-modal .history-item {
            background-color: #ffffff !important;
            border: 2px solid #d1d5db !important;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
        }
        
        #equipment-history-modal .history-item:hover {
            background-color: #f9fafb !important;
            border-color: #9ca3af !important;
        }
        
        .dark #equipment-history-modal .history-item {
            background-color: rgb(52, 52, 52) !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark #equipment-history-modal .history-item:hover {
            background-color: #4b5563 !important;
        }
        
        #equipment-history-modal .history-item h4,
        #equipment-history-modal .history-item p {
            color: #111827 !important;
        }
        
        .dark #equipment-history-modal .history-item h4,
        .dark #equipment-history-modal .history-item p {
            color: #f9fafb !important;
        }
        
        /* Temp Reports modal - dark mode only styling */
        .dark #temp-history-modal {
            background: rgba(0, 0, 0, 0.5) !important;
            backdrop-filter: blur(8px) !important;
        }
        
        .dark #temp-history-modal > div {
            background-color: #1f1f1f !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark #temp-history-modal h3 {
            color: #f9fafb !important;
        }
        
        .dark #temp-history-modal p {
            color: #d1d5db !important;
        }
        
        .dark #temp-history-modal .border-b {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .dark #temp-history-modal .bg-gray-50 {
            background-color: #2d2d2d !important;
        }
        
        .dark #temp-history-modal .text-gray-600 {
            color: #d1d5db !important;
        }
        
        .dark #temp-history-modal .text-gray-900 {
            color: #f9fafb !important;
        }
        
        .dark #temp-history-modal .hover\:bg-gray-100:hover {
            background-color: #374151 !important;
        }
        
        .dark #temp-history-modal .bg-gray-100 {
            background-color: #374151 !important;
        }
        
        .dark #temp-history-modal .text-gray-500 {
            color: #9ca3af !important;
        }
        
        /* Temp Reports modal content areas - dark mode */
        .dark #temp-history-modal .bg-white {
            background-color: rgb(52, 52, 52) !important;
        }
        
        .dark #temp-history-modal table {
            background-color: rgb(52, 52, 52) !important;
        }
        
        .dark #temp-history-modal th {
            background-color: #2d2d2d !important;
            color: #f9fafb !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .dark #temp-history-modal td {
            background-color: rgb(52, 52, 52) !important;
            color: #f9fafb !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .dark #temp-history-modal .hover\:bg-gray-50:hover {
            background-color: #4b5563 !important;
        }
        
        .dark #temp-history-modal .border-gray-200 {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
        
        .dark #temp-history-modal .border-gray-300 {
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        
        .dark #temp-history-modal .text-green-600 {
            color: #10b981 !important;
        }
        
        .dark #temp-history-modal .text-yellow-600 {
            color: #f59e0b !important;
        }
        
        .dark #temp-history-modal .text-red-600 {
            color: #ef4444 !important;
        }
        
        .dark #temp-history-modal .bg-green-50 {
            background-color: rgba(16, 185, 129, 0.1) !important;
        }
        
        .dark #temp-history-modal .bg-yellow-50 {
            background-color: rgba(245, 158, 11, 0.1) !important;
        }
        
        .dark #temp-history-modal .bg-red-50 {
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
        
        .dark #temp-history-modal .bg-blue-50 {
            background-color: rgba(59, 130, 246, 0.1) !important;
        }
        
        .dark #temp-history-modal .border-blue-200 {
            border-color: rgba(59, 130, 246, 0.3) !important;
        }
        
        .dark #temp-history-modal .text-gray-700 {
            color: #d1d5db !important;
        }
        
        .dark #temp-history-modal .text-gray-800 {
            color: #f3f4f6 !important;
        }
        
        .dark #temp-history-modal .text-gray-400 {
            color: #9ca3af !important;
        }
        
        .dark #temp-history-modal .border {
            border-color: rgba(255, 255, 255, 0.2) !important;
        }
    </style>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="glass-strong shadow-2xl border-b border-white/30 floating">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <div class="p-2 rounded-lg shadow-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                        <svg class="h-5 w-5 text-white header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">TempTracker Pro</h1>
                    </div>
                </div>
                <div class="flex flex-col items-end space-y-1">
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleDarkMode()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Toggle Dark Mode">
                            <svg id="theme-icon" class="h-5 w-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        <div class="flex items-center space-x-4">
                            <!-- User Menu -->
                            <div class="relative" id="user-menu-container" style="display: none;">
                                <button onclick="toggleUserMenu()" class="flex items-center space-x-2 bg-transparent px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                                    <div class="w-8 h-8 bg-gradient-to-r from-green-600 to-green-700 rounded-full flex items-center justify-center" id="header-user-avatar">
                                        <span class="text-white font-semibold text-sm" id="user-initials">?</span>
                                    </div>
                                    <div class="text-left hidden md:block">
                                        <p class="text-sm font-medium text-gray-900 dark:text-gray-100" id="user-display-name">User</p>
                                        <p class="text-xs text-gray-600 dark:text-gray-300" id="user-current-store">No store</p>
                                    </div>
                                    <svg class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                            </div>

                            <!-- Login Button (shown when not authenticated) -->
                            <button id="login-button" onclick="openAuthModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                                Sign In
                            </button>

                        </div>
                    </div>
                    
                    <!-- Version Number (positioned below user dropdown in header) -->
                    <div class="text-xs text-gray-600 dark:text-gray-400 bg-transparent pr-4">
                        v1.10.53
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Store Selector & Management -->
        <div class="mb-8">
            <div class="glass-strong rounded-3xl shadow-2xl p-8 floating">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Select Store Location</h2>
                    <button onclick="openAddStoreModal()" class="glow-button text-white px-6 py-3 md:px-6 md:py-3 px-4 py-4 rounded-2xl font-semibold flex items-center space-x-2 min-h-[44px] touch-manipulation">
                        <span>➕</span>
                        <span class="hidden sm:inline">Add Store</span>
                        <span class="sm:hidden">Add</span>
                    </button>
                </div>
                
                <div class="relative" style="z-index: 1000;">
                    <div class="w-full glass rounded-2xl shadow-lg p-6 flex items-center justify-between border-2 border-gray-300 dark:border-white/30">
                        <button onclick="toggleDropdown()" class="store-selector-btn flex items-center space-x-4 flex-1 text-left hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg p-2 transition-colors duration-200">
                            <div class="bg-gradient-to-r from-green-600 to-green-700 p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-gray-900 dark:text-gray-100 text-lg" id="selected-store-name">Loading stores...</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300" id="selected-store-address"></p>
                            </div>
                        </button>
                        <div class="flex items-center space-x-2">
                            <button id="edit-current-store-btn" onclick="editCurrentStore(event)" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" style="display: none;" title="Edit Store">
                                <svg class="h-4 w-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="toggleDropdown()" class="glow-button text-white px-4 py-3 md:px-4 md:py-2 rounded-lg font-semibold min-h-[44px] touch-manipulation store-select-btn" title="Select Store">
                                📍 Select
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="mb-8">
            <div class="glass-strong rounded-2xl shadow-xl p-2">
                <div class="flex space-x-2">
                    <button onclick="showSection('temperature')" id="temp-tab" class="flex-1 px-4 py-4 md:px-6 md:py-3 rounded-lg font-semibold transition-colors min-h-[44px] touch-manipulation">
                        <span class="hidden sm:inline">🌡️ Temperature Log</span>
                        <span class="sm:hidden">🌡️ Temp Log</span>
                    </button>
                    <button onclick="showSection('equipment')" id="equipment-tab" class="flex-1 px-4 py-4 md:px-6 md:py-3 rounded-lg font-semibold transition-colors text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100 min-h-[44px] touch-manipulation">
                        <span class="hidden sm:inline">⚙️ Equipment</span>
                        <span class="sm:hidden">⚙️ Equipment</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Temperature Logging -->
        <div class="mb-8" id="temperature-section" style="display: none;">
            <div class="glass-strong rounded-3xl shadow-2xl p-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                            <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Temperature Logging</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-300" id="selected-store-temperature">Log temperatures for equipment</p>
                        </div>
                    </div>
                </div>
                
                <!-- Move bulk mode and history buttons below header, above equipment -->
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 mt-4 mb-4">
                    <button onclick="toggleBulkMode()" id="bulk-mode-btn" class="btn-secondary min-h-[44px] touch-manipulation px-4 py-3">
                        <span class="hidden sm:inline">📝 Bulk Mode</span>
                        <span class="sm:hidden">📝 Bulk</span>
                    </button>
                    <button onclick="openTemperatureHistory()" class="btn-secondary min-h-[44px] touch-manipulation px-4 py-3">
                        <span class="hidden sm:inline">📊 History</span>
                        <span class="sm:hidden">📊 History</span>
                    </button>
                </div>
                
                <div id="temperature-list" class="space-y-4">
                    <!-- Temperature logging will be populated here -->
                </div>
                
                <div id="bulk-actions" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-blue-900">🔥 Bulk Temperature Entry</h3>
                        <div class="flex space-x-2">
                            <button onclick="saveBulkTemperatures()" class="glow-button text-white px-4 py-2 rounded-lg font-semibold">
                                💾 Save All
                            </button>
                            <button onclick="clearBulkTemperatures()" class="btn-secondary btn-sm">
                                🗑️ Clear
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-blue-700 mb-4">Enter temperatures for all equipment, then save all at once</p>
                </div>
            </div>
        </div>

        <!-- Equipment Management -->
        <div class="mb-8" id="equipment-section" style="display: none;">
            <div class="glass-strong rounded-3xl shadow-2xl p-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 gap-4">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                            <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">Equipment Management</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-300" id="selected-store-equipment">Select a store to manage equipment</p>
                        </div>
                    </div>
                    <button onclick="openEquipmentModal('add')" class="glow-button text-white px-4 py-4 md:px-6 md:py-3 rounded-2xl font-semibold flex items-center justify-center space-x-2 min-h-[44px] touch-manipulation w-full sm:w-auto">
                        <span>➕</span>
                        <span class="hidden sm:inline">Add Equipment</span>
                        <span class="sm:hidden">Add Equipment</span>
                    </button>
                </div>
                
                <div id="equipment-list" class="space-y-4">
                    <!-- Equipment will be populated here -->
                </div>
            </div>
        </div>


        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(58, 109, 55);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Total Stores</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-stores">0</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(76, 135, 72);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Equipment</p>
                        <p class="text-2xl font-semibold text-gray-900" id="equipment-count">--</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(34, 197, 94);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Range</p>
                        <p class="text-2xl font-semibold text-gray-900" id="in-range-count">--</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(239, 68, 68);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L2.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Alerts</p>
                        <p class="text-2xl font-semibold text-gray-900" id="alert-count">--</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Hidden Status Container (required for updateStatus function) -->
        <div style="display: none;">
            <div id="status-list">
                <div></div>
                <div></div>
            </div>
        </div>
    </main>

    <!-- Store Modal -->
    <div id="store-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="modal-title">Add New Store</h3>
                    <button onclick="closeModal()" class="btn-secondary btn-icon">
                        ✕
                    </button>
                </div>
                
                <form onsubmit="saveStore(event)" class="space-y-4">
                    <input type="hidden" id="store-id">
                    
                    <div>
                        <label class="form-label">Store Name</label>
                        <input type="text" id="store-name" required class="form-input">
                    </div>
                    
                    <div>
                        <label class="form-label">Address</label>
                        <textarea id="store-address" required rows="3" class="form-input"></textarea>
                    </div>
                    
                    <div>
                        <label class="form-label">Phone</label>
                        <input type="tel" id="store-phone" class="form-input">
                    </div>
                    
                    <div>
                        <label class="form-label">Manager</label>
                        <input type="text" id="store-manager" class="form-input">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                            Save Store
                        </button>
                        <button type="button" onclick="closeModal()" class="btn-secondary">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Equipment Modal -->
    <div id="equipment-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-lg w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="equipment-modal-title">Add Equipment</h3>
                    <button onclick="closeEquipmentModal()" class="btn-secondary btn-icon">
                        ✕
                    </button>
                </div>
                
                <form onsubmit="saveEquipment(event)" class="space-y-4">
                    <input type="hidden" id="equipment-id">
                    
                    <div>
                        <label class="form-label">Equipment Name</label>
                        <select id="equipment-name" required class="form-input" onchange="updateTemperatureRanges()">
                            <option value="">Select equipment...</option>
                            <option value="Pizza Make Table">Pizza Make Table</option>
                            <option value="Sub Make Table">Sub Make Table</option>
                            <option value="Grill Make Table">Grill Make Table</option>
                            <option value="Walk-in Cooler">Walk-in Cooler</option>
                            <option value="Walk-in Freezer">Walk-in Freezer</option>
                            <option value="Reach-in Cooler">Reach-in Cooler</option>
                            <option value="Reach-in Freezer">Reach-in Freezer</option>
                            <option value="Beverage Cooler">Beverage Cooler</option>
                            <option value="Alcohol Cooler">Alcohol Cooler</option>
                            <option value="Mug Freezer">Mug Freezer</option>
                            <option value="Hot Box">Hot Box</option>
                            <option value="Heat Lamp">Heat Lamp</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Temp (°F)</label>
                            <input type="number" id="equipment-min-temp" required step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="32">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Temp (°F)</label>
                            <input type="number" id="equipment-max-temp" required step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="40">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" id="equipment-location"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Kitchen Back Wall">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Photo (Optional)</label>
                        <div class="flex space-x-2 mb-2">
                            <input type="file" id="equipment-photo" accept="image/*" capture="environment"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onchange="handlePhotoUpload(event)">
                            <button type="button" onclick="openCamera()" class="glow-button text-white px-4 py-3 rounded-lg font-semibold">
                                📷
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Upload a photo or use camera to capture equipment image</p>
                        <div id="photo-preview" class="mt-2 hidden">
                            <img id="preview-image" class="w-16 h-16 rounded-lg object-cover" src="" alt="Preview">
                            <button type="button" onclick="removePhoto()" class="ml-2 text-red-500 text-sm">Remove</button>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                            Save Equipment
                        </button>
                        <button type="button" onclick="closeEquipmentModal()" class="btn-secondary">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="auth-modal-title">Welcome to TempTracker Pro</h3>
                    <button onclick="closeAuthModal()" class="btn-secondary btn-icon">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Login Form -->
                <div id="login-form">
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="login-password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your password">
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Sign In
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-4 text-center">
                        <button onclick="showResetForm()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            Forgot your password?
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Don't have an account? 
                            <button onclick="showSignupForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign up</button>
                        </p>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <form onsubmit="handleSignup(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="signup-name" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your full name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="signup-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="signup-password" required minlength="6"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Create a password (min 6 characters)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Store Location</label>
                            <select id="signup-store" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select your primary store</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">You can switch between stores after signing in</p>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Create Account
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            Already have an account? 
                            <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign in</button>
                        </p>
                    </div>
                </div>
                
                <!-- Password Reset Form -->
                <div id="reset-form" class="hidden">
                    <form onsubmit="handleForgotPasswordSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="reset-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email address">
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="h-5 w-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="text-sm font-medium text-blue-800">Password Reset Instructions</h3>
                                    <p class="text-sm text-blue-700 mt-1">
                                        We'll send you a secure link to reset your password. Check your email inbox and follow the instructions.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Send Reset Link
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            Remember your password? 
                            <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign in</button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Settings Modal -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-2xl w-full border border-white/40 floating max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">🔧 Admin Settings</h3>
                    <button onclick="closeAdminModal()" class="btn-secondary btn-icon">
                        ✕
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Store Management Permissions -->
                    <div class="border-b pb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Store Management Permissions</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Add New Stores</p>
                                    <p class="text-sm text-gray-500">Allow creating new store locations</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_add_admin" class="mr-2" onchange="updatePermission('store_add')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_add_users" class="mr-2" onchange="updatePermission('store_add')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Edit Stores</p>
                                    <p class="text-sm text-gray-500">Allow modifying existing store details</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_edit_admin" class="mr-2" onchange="updatePermission('store_edit')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_edit_users" class="mr-2" onchange="updatePermission('store_edit')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Delete Stores</p>
                                    <p class="text-sm text-gray-500">Allow removing stores from system</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_delete_admin" class="mr-2" onchange="updatePermission('store_delete')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_delete_users" class="mr-2" onchange="updatePermission('store_delete')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Reorder Stores</p>
                                    <p class="text-sm text-gray-500">Allow drag-and-drop reordering of stores</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_reorder_admin" class="mr-2" onchange="updatePermission('store_reorder')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_reorder_users" class="mr-2" onchange="updatePermission('store_reorder')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equipment Management Permissions -->
                    <div class="pb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Equipment Management Permissions</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Add Equipment</p>
                                    <p class="text-sm text-gray-500">Allow creating new equipment items</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_add_admin" class="mr-2" onchange="updatePermission('equipment_add')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_add_users" class="mr-2" onchange="updatePermission('equipment_add')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Edit Equipment</p>
                                    <p class="text-sm text-gray-500">Allow modifying equipment details</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_edit_admin" class="mr-2" onchange="updatePermission('equipment_edit')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_edit_users" class="mr-2" onchange="updatePermission('equipment_edit')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Delete Equipment</p>
                                    <p class="text-sm text-gray-500">Allow removing equipment from system</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_delete_admin" class="mr-2" onchange="updatePermission('equipment_delete')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_delete_users" class="mr-2" onchange="updatePermission('equipment_delete')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Reorder Equipment</p>
                                    <p class="text-sm text-gray-500">Allow drag-and-drop reordering of equipment</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_reorder_admin" class="mr-2" onchange="updatePermission('equipment_reorder')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_reorder_users" class="mr-2" onchange="updatePermission('equipment_reorder')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- UI Inspector Tool -->
                    <div class="border-b pb-6">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">UI Inspector Tool</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700 dark:text-gray-300">UI Inspector Access</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Advanced debugging tool for UI element inspection and color modification</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="ui_inspector_admin" class="mr-2" onchange="updatePermission('ui_inspector')">
                                        <span class="text-sm text-gray-700 dark:text-gray-300">Admin</span>
                                    </label>
                                    <label class="flex items-center opacity-50 cursor-not-allowed">
                                        <input type="checkbox" id="ui_inspector_users" class="mr-2" disabled>
                                        <span class="text-sm text-gray-500">All Users</span>
                                    </label>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800">
                                <strong>⚠️ Security Note:</strong> UI Inspector is admin-only for security reasons. Regular users cannot access this debugging tool.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Inspector Context Menu -->
    <div id="ui-inspector-menu" class="hidden fixed z-[9999999] glass-strong rounded-xl shadow-2xl border border-white/40 p-3 min-w-[200px]">
        <button onclick="inspectSelectedElement()" class="w-full text-left px-3 py-2 text-sm font-medium text-gray-800 dark:text-gray-200 hover:bg-blue-500/20 rounded-lg transition-colors duration-200 flex items-center space-x-2">
            <span>🔍</span>
            <span>Inspect Element</span>
        </button>
        <button onclick="closeInspectorMenu()" class="w-full text-left px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:bg-gray-500/20 rounded-lg transition-colors duration-200 flex items-center space-x-2">
            <span>✕</span>
            <span>Cancel</span>
        </button>
    </div>

    <!-- UI Inspector Panel -->
    <div id="ui-inspector-panel" class="hidden fixed top-4 left-4 w-80 max-h-[90vh] overflow-y-auto z-[9999998] glass-strong rounded-2xl shadow-2xl border border-white/40">
        <!-- Header -->
        <div class="sticky top-0 glass-strong rounded-t-2xl p-4 border-b border-white/20">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900 dark:text-gray-100 flex items-center space-x-2">
                    <span>🔍</span>
                    <span>UI Inspector</span>
                </h3>
                <button onclick="closeUIInspector()" class="btn-secondary btn-icon">
                    ✕
                </button>
            </div>
            <div class="mt-2">
                <p class="text-sm text-gray-600 dark:text-gray-400">Inspecting: <span id="inspector-element-name" class="font-mono text-blue-600 dark:text-blue-400"></span></p>
            </div>
        </div>

        <!-- Content -->
        <div class="p-4 space-y-6">
            <!-- Element Info Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>📋</span>
                    <span>Element Information</span>
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Tag:</span>
                        <span id="inspector-tag" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">ID:</span>
                        <span id="inspector-id" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Classes:</span>
                        <span id="inspector-classes" class="font-mono text-gray-800 dark:text-gray-200 text-right max-w-[200px] break-words"></span>
                    </div>
                </div>
            </div>

            <!-- Colors Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>🎨</span>
                    <span>Colors</span>
                </h4>
                <div class="space-y-4">
                    <div class="color-property">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Text Color</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-picker-color" class="w-8 h-8 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                            <span id="color-value-color" class="text-xs font-mono text-gray-700 dark:text-gray-300 flex-1"></span>
                            <button onclick="revertColor('color')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Reset</button>
                        </div>
                    </div>
                    <div class="color-property">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Background Color</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-picker-backgroundColor" class="w-8 h-8 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                            <span id="color-value-backgroundColor" class="text-xs font-mono text-gray-700 dark:text-gray-300 flex-1"></span>
                            <button onclick="revertColor('backgroundColor')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Reset</button>
                        </div>
                    </div>
                    <div class="color-property">
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Border Color</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="color-picker-borderColor" class="w-8 h-8 rounded border border-gray-300 dark:border-gray-600 cursor-pointer">
                            <span id="color-value-borderColor" class="text-xs font-mono text-gray-700 dark:text-gray-300 flex-1"></span>
                            <button onclick="revertColor('borderColor')" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Reset</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Typography Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>🔤</span>
                    <span>Typography</span>
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Font Size:</span>
                        <span id="inspector-fontSize" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Font Weight:</span>
                        <span id="inspector-fontWeight" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Line Height:</span>
                        <span id="inspector-lineHeight" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                </div>
            </div>

            <!-- Layout Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>📐</span>
                    <span>Layout</span>
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Display:</span>
                        <span id="inspector-display" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Position:</span>
                        <span id="inspector-position" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Width:</span>
                        <span id="inspector-width" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Height:</span>
                        <span id="inspector-height" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                </div>
            </div>

            <!-- Spacing Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>📏</span>
                    <span>Spacing</span>
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Margin:</span>
                        <span id="inspector-margin" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Padding:</span>
                        <span id="inspector-padding" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                </div>
            </div>

            <!-- Effects Section -->
            <div class="inspector-section">
                <h4 class="text-sm font-semibold text-gray-800 dark:text-gray-200 mb-3 flex items-center space-x-2">
                    <span>✨</span>
                    <span>Effects</span>
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Opacity:</span>
                        <span id="inspector-opacity" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Border Radius:</span>
                        <span id="inspector-borderRadius" class="font-mono text-gray-800 dark:text-gray-200"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Box Shadow:</span>
                        <span id="inspector-boxShadow" class="font-mono text-gray-800 dark:text-gray-200 text-right max-w-[200px] break-words"></span>
                    </div>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="pt-4 border-t border-white/20">
                <button onclick="resetAllColors()" class="w-full btn-secondary btn-sm">
                    🔄 Reset All Colors
                </button>
            </div>
        </div>
    </div>

    <!-- Temperature Log Modal and History Modal will be inserted here dynamically -->

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-[999999] space-y-2 max-w-sm w-full pointer-events-none">
        <!-- Notifications will be inserted here dynamically -->
    </div>

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://cacalfugowmeitmlwnjw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhY2FsZnVnb3dtZWl0bWx3bmp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjIxNTEsImV4cCI6MjA2ODg5ODE1MX0.JU72z7PFNcRe1Old3OqYT24BH2q_zpoY0OkpQoLMmyY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Data arrays - will be populated from Supabase
        let stores = [];
        let equipment = [];
        let temperatureLogs = [];
        let userProfiles = [];
        
        let selectedStore = null;
        let currentEquipmentPhoto = null;
        let currentUser = null;
        let userProfile = null;

        // UI Inspector System
        window.UIInspector = {
            enabled: false,
            activeElement: null,
            originalStyles: new Map(),
            contextMenu: null,
            propertyPanel: null,
            hoveredElement: null,
            permissions: {}
        };

        // Notification System
        let notificationId = 0;

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) {
                console.warn('Notification container not found');
                return;
            }

            // Create notification element
            const notificationDiv = document.createElement('div');
            const id = `notification-${++notificationId}`;
            notificationDiv.id = id;
            
            // Get appropriate colors and emoji for notification type
            let bgColor, borderColor, textColor, iconEmoji;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50/95 dark:bg-green-900/95';
                    borderColor = 'border-green-200 dark:border-green-700';
                    textColor = 'text-green-800 dark:text-green-200';
                    iconEmoji = '✅';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50/95 dark:bg-yellow-900/95';
                    borderColor = 'border-yellow-200 dark:border-yellow-700';
                    textColor = 'text-yellow-800 dark:text-yellow-200';
                    iconEmoji = '⚠️';
                    break;
                case 'error':
                    bgColor = 'bg-red-50/95 dark:bg-red-900/95';
                    borderColor = 'border-red-200 dark:border-red-700';
                    textColor = 'text-red-800 dark:text-red-200';
                    iconEmoji = '❌';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-50/95 dark:bg-blue-900/95';
                    borderColor = 'border-blue-200 dark:border-blue-700';
                    textColor = 'text-blue-800 dark:text-blue-200';
                    iconEmoji = 'ℹ️';
                    break;
            }

            // Create notification HTML with glassmorphism styling
            notificationDiv.className = `
                pointer-events-auto transform translate-x-full opacity-0 transition-all duration-300 ease-in-out
                ${bgColor} backdrop-blur-md ${borderColor} border rounded-xl shadow-lg p-4 
                max-w-sm w-full cursor-pointer hover:shadow-xl
            `;
            
            notificationDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <span class="text-lg">${iconEmoji}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium ${textColor} break-words">${message}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="removeNotification('${id}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

            // Add click to dismiss
            notificationDiv.addEventListener('click', () => removeNotification(id));

            // Insert notification at the top of the container
            container.insertBefore(notificationDiv, container.firstChild);

            // Trigger animation after insertion
            requestAnimationFrame(() => {
                notificationDiv.classList.remove('translate-x-full', 'opacity-0');
                notificationDiv.classList.add('translate-x-0', 'opacity-100');
            });

            // Auto-dismiss after timeout
            let timeout = 5000; // Default 5 seconds
            if (type === 'error') timeout = 8000; // Errors stay longer
            if (type === 'warning') timeout = 6000; // Warnings stay a bit longer
            if (type === 'success' && message.includes('🔗')) timeout = 3000; // Database sync notifications shorter

            setTimeout(() => {
                removeNotification(id);
            }, timeout);

            return id;
        }

        function removeNotification(id) {
            const notification = document.getElementById(id);
            if (!notification) return;

            // Animate out
            notification.classList.add('translate-x-full', 'opacity-0');
            notification.classList.remove('translate-x-0', 'opacity-100');

            // Remove from DOM after animation
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }

        // Clear all notifications
        function clearAllNotifications() {
            const container = document.getElementById('notification-container');
            if (container) {
                const notifications = container.querySelectorAll('[id^="notification-"]');
                notifications.forEach(notification => {
                    removeNotification(notification.id);
                });
            }
        }

        // Make functions globally available for onclick handlers
        window.removeNotification = removeNotification;
        window.clearAllNotifications = clearAllNotifications;
        window.openStoreModal = openStoreModal;
        window.closeStoreModal = closeStoreModal;
        window.selectStoreFromModal = selectStoreFromModal;
        
        // Authentication functions (will be defined below)
        window.handleLogin = handleLogin;
        window.handleSignup = handleSignup;
        window.handleForgotPasswordSubmit = handleForgotPasswordSubmit;
        window.openAuthModal = openAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.showResetForm = showResetForm;
        window.showSignupForm = showSignupForm;
        window.showLoginForm = showLoginForm;
        window.handleLogout = handleLogout;
        
        // UI functions (will be defined below)
        window.toggleDarkMode = toggleDarkMode;
        window.toggleUserMenu = toggleUserMenu;
        window.showSection = showSection;
        window.toggleBulkMode = toggleBulkMode;
        window.openTemperatureHistory = openTemperatureHistory;
        window.saveBulkTemperatures = saveBulkTemperatures;
        window.clearBulkTemperatures = clearBulkTemperatures;
        window.openEquipmentModal = openEquipmentModal;
        window.saveStore = saveStore;
        window.saveEquipment = saveEquipment;
        window.toggleDropdown = toggleDropdown;
        window.openAddStoreModal = openAddStoreModal;
        window.editCurrentStore = editCurrentStore;
        window.closeModal = closeModal;
        window.closeEquipmentModal = closeEquipmentModal;
        window.openCamera = openCamera;
        window.removePhoto = removePhoto;
        window.capturePhoto = capturePhoto;
        window.openTemperatureModal = openTemperatureModal;
        window.deleteEquipment = deleteEquipment;
        window.openAdminSettings = openAdminSettings;
        window.showProfile = showProfile;

        // Authentication Functions
        async function checkAuthState() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session?.user) {
                    currentUser = session.user;
                    await loadUserProfile();
                    await loadUserPermissions();
                    updateAuthUI(true);
                    await loadDefaultStore();
                } else {
                    updateAuthUI(false);
                    openAuthModal();
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
                updateAuthUI(false);
                openAuthModal();
            }
        }

        async function loadUserProfile() {
            try {
                console.log('🔄 Loading user profile for:', currentUser?.email);
                
                if (!currentUser) {
                    console.log('❌ No current user to load profile for');
                    return;
                }

                // First try to get the profile
                const { data: profileData, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError) {
                    console.log('Profile not found, creating new profile...');
                    // If profile doesn't exist, create it
                    const { data: newProfile, error: createError } = await supabase
                        .from('user_profiles')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                            active: true
                        })
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creating profile:', createError);
                        // Continue with basic user data even if profile creation fails
                        userProfile = {
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                            active: true
                        };
                    } else {
                        userProfile = newProfile;
                        console.log('✅ Profile created:', userProfile);
                    }
                } else {
                    userProfile = profileData;
                    console.log('✅ Profile loaded:', userProfile);
                }
                
                // If user has a default store, load it
                if (userProfile?.default_store_id) {
                    console.log('Loading default store:', userProfile.default_store_id);
                    const { data: storeData, error: storeError } = await supabase
                        .from('stores')
                        .select('*')
                        .eq('id', userProfile.default_store_id)
                        .single();
                    
                    if (!storeError && storeData) {
                        userProfile.default_store = storeData;
                        console.log('✅ Default store loaded:', storeData.name);
                    }
                }
                
                // Apply dark mode preference from profile
                if (userProfile?.dark_mode_preference) {
                    applyDarkModePreference(userProfile.dark_mode_preference);
                }
                
                // Always update display after profile loading
                updateUserDisplay();
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Even on error, try to update display with basic user data
                userProfile = {
                    id: currentUser?.id,
                    email: currentUser?.email,
                    full_name: currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'User',
                    active: true
                };
                updateUserDisplay();
                showNotification('Using basic profile info due to loading error', 'warning');
            }
        }

        async function loadDefaultStore() {
            console.log('🏪 Loading default store for user profile:', userProfile);
            console.log('User profile default_store_id:', userProfile?.default_store_id);
            console.log('User profile default_store object:', userProfile?.default_store);
            
            // First, ensure stores are loaded
            await initStores();
            
            if (userProfile?.default_store) {
                console.log('✅ Using cached default store:', userProfile.default_store.name);
                selectStore(userProfile.default_store);
            } else if (userProfile?.default_store_id) {
                console.log('🔍 Finding default store by ID:', userProfile.default_store_id);
                // Find the store in the loaded stores array
                const defaultStore = stores.find(store => store.id === userProfile.default_store_id);
                if (defaultStore) {
                    console.log('✅ Found default store:', defaultStore.name);
                    selectStore(defaultStore);
                    // Also cache it in the profile for future use
                    userProfile.default_store = defaultStore;
                } else {
                    console.log('❌ Default store ID not found in stores list');
                    console.log('Available stores:', stores.map(s => ({ id: s.id, name: s.name })));
                }
            } else {
                console.log('No default store set, user will need to select one');
            }
            
            // Update user display after store selection
            updateUserDisplay();
        }

        function updateAuthUI(isAuthenticated) {
            const loginButton = document.getElementById('login-button');
            const userMenuContainer = document.getElementById('user-menu-container');
            
            if (isAuthenticated) {
                loginButton.style.display = 'none';
                userMenuContainer.style.display = 'block';
            } else {
                loginButton.style.display = 'block';
                userMenuContainer.style.display = 'none';
            }
        }

        function updateUserDisplay() {
            console.log('Updating user display with profile:', userProfile);
            console.log('Current user:', currentUser);
            console.log('Selected store:', selectedStore);
            
            if (!currentUser) {
                console.log('No current user available for display');
                return;
            }
            
            // Use userProfile if available, otherwise fallback to currentUser data
            const fullName = userProfile?.full_name || 
                             currentUser?.user_metadata?.full_name || 
                             currentUser?.email?.split('@')[0] || 'User';
                             
            const email = userProfile?.email || currentUser?.email || '';
            
            const initials = fullName
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2) || '?';
            
            // Update all user display elements
            const userInitialsElement = document.getElementById('user-initials');
            const userDisplayNameElement = document.getElementById('user-display-name');
            const userCurrentStoreElement = document.getElementById('user-current-store');
            const dropdownUserNameElement = document.getElementById('dropdown-user-name');
            const dropdownUserEmailElement = document.getElementById('dropdown-user-email');
            
            if (userInitialsElement) userInitialsElement.textContent = initials;
            if (userDisplayNameElement) userDisplayNameElement.textContent = fullName;
            if (userCurrentStoreElement) userCurrentStoreElement.textContent = selectedStore?.name || 'No store selected';
            if (dropdownUserNameElement) dropdownUserNameElement.textContent = fullName;
            if (dropdownUserEmailElement) dropdownUserEmailElement.textContent = email;
            
            // Update header avatar with profile picture or initials
            updateHeaderAvatar();
            
            // Update admin menu visibility based on user role
            updateAdminMenuVisibility();
            
            console.log('✅ User display updated:', { fullName, email, store: selectedStore?.name });
        }

        // Auth Modal Functions
        function openAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            showLoginForm();
            populateStoreOptions();
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Welcome Back';
        }

        function showSignupForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Create Account';
        }

        function showResetForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('auth-modal-title').textContent = 'Reset Password';
        }

        async function populateStoreOptions() {
            const select = document.getElementById('signup-store');
            select.innerHTML = '<option value="">Select your primary store</option>';
            
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                select.appendChild(option);
            });
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                updateStatus('Signing in...');
                console.log('🔄 Attempting login for:', email);
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    console.error('Supabase auth error:', error);
                    
                    // Handle specific error cases
                    if (error.message.includes('Email not confirmed')) {
                        updateStatus('❌ Email not verified');
                        showNotification('Please check your email and click the verification link before signing in', 'warning');
                        return;
                    } else if (error.message.includes('Invalid login credentials')) {
                        updateStatus('❌ Invalid credentials');
                        showNotification('Invalid email or password. Please check your credentials and try again.', 'error');
                        return;
                    }
                    
                    throw error;
                }
                
                console.log('✅ Login successful for user:', data.user.email);
                
                currentUser = data.user;
                await loadUserProfile();
                await loadUserPermissions();
                updateAuthUI(true);
                await loadDefaultStore();
                closeAuthModal();
                
                updateStatus('✅ Successfully signed in');
                showNotification(`Welcome back, ${userProfile?.full_name || 'User'}!`, 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                updateStatus('❌ Sign in failed');
                showNotification('Login failed: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const defaultStoreId = document.getElementById('signup-store').value;
            
            try {
                updateStatus('Creating account...');
                console.log('🔄 Creating account for:', email, 'with default store:', defaultStoreId);
                
                // Step 1: Create Supabase auth user
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            default_store_id: defaultStoreId || null
                        }
                    }
                });
                
                if (error) {
                    console.error('Signup error:', error);
                    throw error;
                }
                
                console.log('✅ Supabase user created:', data.user?.email);
                
                // Step 2: Handle post-signup profile setup
                if (data.user) {
                    // Wait briefly for auth session to establish
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    console.log('🔄 Setting up user profile and store access...');
                    
                    // Update profile with default store (trigger should have created basic profile)
                    if (defaultStoreId) {
                        const { error: profileUpdateError } = await supabase
                            .from('user_profiles')
                            .update({ 
                                default_store_id: defaultStoreId,
                                full_name: name
                            })
                            .eq('id', data.user.id);
                        
                        if (profileUpdateError) {
                            console.error('Error updating user profile:', profileUpdateError);
                        } else {
                            console.log('✅ User profile updated with default store');
                        }
                        
                        // Create store access entry
                        const { error: accessError } = await supabase
                            .from('user_store_access')
                            .upsert({
                                user_id: data.user.id,
                                store_id: defaultStoreId,
                                access_level: 'employee',
                                active: true
                            }, {
                                onConflict: 'user_id,store_id'
                            });
                        
                        if (accessError) {
                            console.error('Error creating user store access:', accessError);
                        } else {
                            console.log('✅ User store access created successfully');
                        }
                    }
                    
                    // Step 3: Initialize user session
                    currentUser = data.user;
                    await loadUserProfile();
                    updateAuthUI(true);
                    await loadDefaultStore();
                    closeAuthModal();
                    
                    updateStatus('✅ Account created successfully');
                    showNotification(`Welcome to TempTracker Pro, ${name}!`, 'success');
                } else {
                    showNotification('Please check your email to verify your account', 'success');
                }
                
            } catch (error) {
                console.error('Signup error:', error);
                updateStatus('❌ Account creation failed');
                showNotification('Error creating account: ' + error.message, 'error');
            }
        }

        async function handleForgotPasswordSubmit(event) {
            event.preventDefault();
            
            const email = document.getElementById('reset-email').value;
            
            try {
                updateStatus('Sending reset link...');
                
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/temptracker-supabase/reset-password.html'
                });
                
                if (error) throw error;
                
                updateStatus('✅ Reset link sent');
                showNotification(`Password reset link sent to ${email}. Check your email!`, 'success');
                
                // Show success message and switch back to login
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
                
            } catch (error) {
                console.error('Password reset error:', error);
                updateStatus('❌ Failed to send reset link');
                showNotification('Error sending reset link: ' + error.message, 'error');
            }
        }

        async function handlePasswordResetCallback(accessToken, refreshToken) {
            try {
                // Set the session with the tokens from the URL
                const { data, error } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });
                
                if (error) throw error;
                
                // Prompt user for new password
                const newPassword = prompt('Please enter your new password (minimum 6 characters):');
                
                if (!newPassword) {
                    showNotification('Password reset cancelled', 'warning');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                // Update the password
                const { error: updateError } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (updateError) throw updateError;
                
                // Clean up the URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                showNotification('✅ Password updated successfully!', 'success');
                
                // Set the current user and continue with normal login flow
                currentUser = data.user;
                await loadUserProfile();
                updateAuthUI(true);
                await loadDefaultStore();
                
            } catch (error) {
                console.error('Password reset callback error:', error);
                showNotification('Error resetting password: ' + error.message, 'error');
                
                // Clean up the URL and show login
                window.history.replaceState({}, document.title, window.location.pathname);
                updateAuthUI(false);
                openAuthModal();
            }
        }

        // Admin Modal Functions
        async function openAdminSettings() {
            if (!isCurrentUserAdmin()) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            // Load current permissions and populate checkboxes
            const { data: permissions, error } = await supabase
                .from('global_permissions')
                .select('*');
            
            if (!error && permissions) {
                permissions.forEach(perm => {
                    const adminCheckbox = document.getElementById(`${perm.permission_name}_admin`);
                    const usersCheckbox = document.getElementById(`${perm.permission_name}_users`);
                    
                    if (adminCheckbox) adminCheckbox.checked = perm.enabled_for_admin;
                    if (usersCheckbox) usersCheckbox.checked = perm.enabled_for_users;
                });
            }
            
            // Special handling for UI Inspector checkbox
            const uiInspectorCheckbox = document.getElementById('ui_inspector_admin');
            if (uiInspectorCheckbox) {
                uiInspectorCheckbox.checked = localStorage.getItem('ui_inspector_enabled') === 'true';
            }
            
            document.getElementById('admin-modal').classList.remove('hidden');
        }
        
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }
        
        async function updatePermission(permissionName) {
            const adminCheckbox = document.getElementById(`${permissionName}_admin`);
            const usersCheckbox = document.getElementById(`${permissionName}_users`);
            
            if (!adminCheckbox || !usersCheckbox) return;
            
            // Special handling for ui_inspector - store in localStorage since it might not exist in DB
            if (permissionName === 'ui_inspector') {
                localStorage.setItem('ui_inspector_enabled', adminCheckbox.checked);
                userPermissions.ui_inspector = adminCheckbox.checked;
                
                // Immediately update UI Inspector state
                if (isCurrentUserAdmin() && adminCheckbox.checked) {
                    initializeUIInspector();
                } else {
                    disableUIInspector();
                }
                
                showNotification(`UI Inspector ${adminCheckbox.checked ? 'enabled' : 'disabled'}`, 'success');
                return;
            }
            
            await updateGlobalPermission(
                permissionName,
                adminCheckbox.checked,
                usersCheckbox.checked
            );
        }

        // UI Inspector Tool Functions
        function initializeUIInspector() {
            if (!isCurrentUserAdmin()) {
                console.warn('UI Inspector: Admin access required');
                return;
            }
            
            UIInspector.enabled = true;
            console.log('🔍 UI Inspector initialized');
            
            // Add event listeners for inspector functionality
            document.addEventListener('contextmenu', handleInspectorRightClick);
            document.addEventListener('mouseover', handleInspectorHover);
            document.addEventListener('mouseout', handleInspectorMouseOut);
            document.addEventListener('click', handleInspectorClick);
            
            // Initialize color picker event listeners
            initializeColorPickers();
            
            showNotification('🔍 UI Inspector enabled - Right-click any element to inspect', 'info');
        }
        
        function disableUIInspector() {
            UIInspector.enabled = false;
            
            // Remove event listeners
            document.removeEventListener('contextmenu', handleInspectorRightClick);
            document.removeEventListener('mouseover', handleInspectorHover);
            document.removeEventListener('mouseout', handleInspectorMouseOut);
            document.removeEventListener('click', handleInspectorClick);
            
            // Close any open inspector elements
            closeInspectorMenu();
            closeUIInspector();
            
            // Remove any hover highlights
            removeInspectorHighlight();
            
            console.log('🔍 UI Inspector disabled');
        }
        
        function handleInspectorRightClick(event) {
            console.log('🔍 Right-click detected!');
            console.log('UIInspector.enabled:', UIInspector?.enabled);
            
            if (!UIInspector.enabled) {
                console.log('❌ UI Inspector not enabled, ignoring right-click');
                return;
            }
            
            // Don't interfere with inspector UI elements
            const target = event.target;
            console.log('Right-click target:', target);
            
            if (target.closest('#ui-inspector-panel') || target.closest('#ui-inspector-menu')) {
                console.log('❌ Right-clicked on inspector UI, ignoring');
                return;
            }
            
            console.log('✅ Valid right-click, preventing default and showing menu');
            event.preventDefault();
            event.stopPropagation();
            
            UIInspector.activeElement = target;
            
            try {
                showInspectorContextMenu(event.clientX, event.clientY);
                console.log('✅ Context menu should be displayed now');
            } catch (error) {
                console.error('❌ Error showing context menu:', error);
            }
        }
        
        function handleInspectorHover(event) {
            if (!UIInspector.enabled) return;
            
            const target = event.target;
            
            // Don't highlight inspector UI elements
            if (target.closest('#ui-inspector-panel') || target.closest('#ui-inspector-menu')) {
                return;
            }
            
            UIInspector.hoveredElement = target;
            highlightInspectorElement(target);
        }
        
        function handleInspectorMouseOut(event) {
            if (!UIInspector.enabled) return;
            
            removeInspectorHighlight();
            UIInspector.hoveredElement = null;
        }
        
        function handleInspectorClick(event) {
            if (!UIInspector.enabled) return;
            
            // Close context menu if clicking outside
            const target = event.target;
            if (!target.closest('#ui-inspector-menu')) {
                closeInspectorMenu();
            }
        }
        
        function showInspectorContextMenu(x, y) {
            console.log('🎯 showInspectorContextMenu called with x:', x, 'y:', y);
            
            const menu = document.getElementById('ui-inspector-menu');
            console.log('Menu element found:', !!menu);
            
            if (!menu) {
                console.error('❌ UI Inspector menu element not found!');
                return;
            }
            
            // Position the menu, adjusting for viewport edges
            const menuWidth = 200;
            const menuHeight = 80;
            
            let adjustedX = x;
            let adjustedY = y;
            
            if (x + menuWidth > window.innerWidth) {
                adjustedX = x - menuWidth;
            }
            
            if (y + menuHeight > window.innerHeight) {
                adjustedY = y - menuHeight;
            }
            
            console.log('Setting menu position to x:', adjustedX, 'y:', adjustedY);
            menu.style.left = `${adjustedX}px`;
            menu.style.top = `${adjustedY}px`;
            menu.classList.remove('hidden');
            
            console.log('✅ Context menu should now be visible!');
            console.log('Menu classes:', menu.className);
            console.log('Menu style:', menu.style.cssText);
        }
        
        function closeInspectorMenu() {
            const menu = document.getElementById('ui-inspector-menu');
            if (menu) {
                menu.classList.add('hidden');
            }
        }
        
        window.inspectSelectedElement = function() {
            if (!UIInspector.activeElement) return;
            
            closeInspectorMenu();
            openInspectorPanel(UIInspector.activeElement);
        };
        
        window.closeInspectorMenu = function() {
            const menu = document.getElementById('ui-inspector-menu');
            if (menu) {
                menu.classList.add('hidden');
            }
        };
        
        function openInspectorPanel(element) {
            const panel = document.getElementById('ui-inspector-panel');
            if (!panel || !element) return;
            
            // Store original styles for reverting
            if (!UIInspector.originalStyles.has(element)) {
                const computedStyle = getComputedStyle(element);
                UIInspector.originalStyles.set(element, {
                    color: computedStyle.color,
                    backgroundColor: computedStyle.backgroundColor,
                    borderColor: computedStyle.borderColor
                });
            }
            
            // Extract and display element properties
            populateInspectorPanel(element);
            
            // Show the panel
            panel.classList.remove('hidden');
            
            // Re-initialize color picker event listeners for this specific panel
            initializeColorPickers();
            
            // Highlight the inspected element
            highlightInspectorElement(element, true);
        }
        
        function populateInspectorPanel(element) {
            const computedStyle = getComputedStyle(element);
            const rect = element.getBoundingClientRect();
            
            // Element identification
            const elementName = `${element.tagName.toLowerCase()}${element.id ? '#' + element.id : ''}${element.className ? '.' + element.className.split(' ')[0] : ''}`;
            document.getElementById('inspector-element-name').textContent = elementName;
            document.getElementById('inspector-tag').textContent = element.tagName.toLowerCase();
            document.getElementById('inspector-id').textContent = element.id || 'none';
            document.getElementById('inspector-classes').textContent = element.className || 'none';
            
            // Colors
            updateColorPicker('color', computedStyle.color);
            updateColorPicker('backgroundColor', computedStyle.backgroundColor);
            updateColorPicker('borderColor', computedStyle.borderColor);
            
            // Typography
            document.getElementById('inspector-fontSize').textContent = computedStyle.fontSize;
            document.getElementById('inspector-fontWeight').textContent = computedStyle.fontWeight;
            document.getElementById('inspector-lineHeight').textContent = computedStyle.lineHeight;
            
            // Layout
            document.getElementById('inspector-display').textContent = computedStyle.display;
            document.getElementById('inspector-position').textContent = computedStyle.position;
            document.getElementById('inspector-width').textContent = Math.round(rect.width) + 'px';
            document.getElementById('inspector-height').textContent = Math.round(rect.height) + 'px';
            
            // Spacing
            document.getElementById('inspector-margin').textContent = computedStyle.margin;
            document.getElementById('inspector-padding').textContent = computedStyle.padding;
            
            // Effects
            document.getElementById('inspector-opacity').textContent = computedStyle.opacity;
            document.getElementById('inspector-borderRadius').textContent = computedStyle.borderRadius;
            document.getElementById('inspector-boxShadow').textContent = computedStyle.boxShadow === 'none' ? 'none' : 'Applied';
        }
        
        function updateColorPicker(property, color) {
            const picker = document.getElementById(`color-picker-${property}`);
            const valueSpan = document.getElementById(`color-value-${property}`);
            
            if (!picker || !valueSpan) return;
            
            // Convert color to hex for color picker
            const hexColor = rgbToHex(color);
            if (hexColor) {
                picker.value = hexColor;
            }
            
            valueSpan.textContent = color;
        }
        
        function rgbToHex(rgb) {
            if (!rgb || rgb === 'rgba(0, 0, 0, 0)' || rgb === 'transparent') {
                return '#000000';
            }
            
            // Handle rgb(r, g, b) and rgba(r, g, b, a) formats
            const match = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (match) {
                const r = parseInt(match[1]);
                const g = parseInt(match[2]);
                const b = parseInt(match[3]);
                return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            }
            
            // Already in hex format
            if (rgb.startsWith('#')) {
                return rgb;
            }
            
            return '#000000';
        }
        
        function initializeColorPickers() {
            ['color', 'backgroundColor', 'borderColor'].forEach(property => {
                const picker = document.getElementById(`color-picker-${property}`);
                if (picker) {
                    // Remove existing listeners to prevent duplicates
                    const newPicker = picker.cloneNode(true);
                    picker.parentNode.replaceChild(newPicker, picker);
                    
                    // Add new event listener
                    newPicker.addEventListener('input', (e) => {
                        console.log(`🎨 Color picker changed: ${property} = ${e.target.value}`);
                        updateElementColor(property, e.target.value);
                    });
                    
                    console.log(`✅ Color picker initialized for ${property}`);
                }
            });
        }
        
        function updateElementColor(property, newColor) {
            console.log(`🔧 updateElementColor called: ${property} = ${newColor}`);
            console.log('Active element:', UIInspector.activeElement);
            
            if (!UIInspector.activeElement) {
                console.error('❌ No active element to update!');
                return;
            }
            
            const element = UIInspector.activeElement;
            const isDarkMode = document.body.classList.contains('dark');
            
            console.log('Element before update:', element.style[property]);
            console.log('Current theme:', isDarkMode ? 'dark' : 'light');
            
            // Store original color for both modes if not already stored
            if (!UIInspector.originalStyles.has(element)) {
                const computedStyle = getComputedStyle(element);
                UIInspector.originalStyles.set(element, {
                    color: computedStyle.color,
                    backgroundColor: computedStyle.backgroundColor,
                    borderColor: computedStyle.borderColor
                });
            }
            
            // Apply the new color with theme-specific handling
            if (isDarkMode) {
                // For dark mode, store as custom property to maintain across theme switches
                element.style.setProperty(`--dark-${property}`, newColor);
                element.style[property] = newColor;
            } else {
                // For light mode
                element.style.setProperty(`--light-${property}`, newColor);
                element.style[property] = newColor;
            }
            
            console.log('Element after update:', element.style[property]);
            console.log('Element computed style:', getComputedStyle(element)[property]);
            
            // Update the display
            const valueSpan = document.getElementById(`color-value-${property}`);
            if (valueSpan) {
                valueSpan.textContent = `${newColor} (${isDarkMode ? 'Dark' : 'Light'} Mode)`;
                console.log('Updated value display to:', newColor);
            }
            
            showNotification(`🎨 Updated ${property} to ${newColor} (${isDarkMode ? 'Dark' : 'Light'} Mode)`, 'success');
        }
        
        window.revertColor = function(property) {
            if (!UIInspector.activeElement) return;
            
            const element = UIInspector.activeElement;
            const originalStyles = UIInspector.originalStyles.get(element);
            
            if (originalStyles && originalStyles[property]) {
                element.style[property] = originalStyles[property];
                updateColorPicker(property, originalStyles[property]);
                showNotification(`🔄 Reverted ${property} to original`, 'info');
            }
        };
        
        window.resetAllColors = function() {
            if (!UIInspector.activeElement) return;
            
            const element = UIInspector.activeElement;
            const originalStyles = UIInspector.originalStyles.get(element);
            
            if (originalStyles) {
                ['color', 'backgroundColor', 'borderColor'].forEach(property => {
                    if (originalStyles[property]) {
                        element.style[property] = originalStyles[property];
                        updateColorPicker(property, originalStyles[property]);
                    }
                });
                showNotification('🔄 Reset all colors to original', 'info');
            }
        };
        
        window.closeUIInspector = function() {
            const panel = document.getElementById('ui-inspector-panel');
            if (panel) {
                panel.classList.add('hidden');
            }
            
            removeInspectorHighlight();
            UIInspector.activeElement = null;
        };
        
        function highlightInspectorElement(element, isSelected = false) {
            // Remove existing highlights
            removeInspectorHighlight();
            
            if (!element) return;
            
            // Add highlight styling
            const highlightClass = isSelected ? 'ui-inspector-selected' : 'ui-inspector-hover';
            element.classList.add(highlightClass);
            
            // Add CSS for highlights if not already present
            if (!document.getElementById('ui-inspector-styles')) {
                const style = document.createElement('style');
                style.id = 'ui-inspector-styles';
                style.textContent = `
                    .ui-inspector-hover {
                        outline: 2px solid #3b82f6 !important;
                        outline-offset: 2px !important;
                    }
                    .ui-inspector-selected {
                        outline: 3px solid #10b981 !important;
                        outline-offset: 2px !important;
                        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.2) !important;
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function removeInspectorHighlight() {
            // Remove all inspector highlight classes
            document.querySelectorAll('.ui-inspector-hover, .ui-inspector-selected').forEach(el => {
                el.classList.remove('ui-inspector-hover', 'ui-inspector-selected');
            });
        }
        
        async function handleLogout() {
            try {
                updateStatus('Signing out...');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                userProfile = null;
                selectedStore = null;
                
                updateAuthUI(false);
                
                // Hide main sections
                document.getElementById('temperature-section').style.display = 'none';
                document.getElementById('equipment-section').style.display = 'none';
                
                // Reset store display
                document.getElementById('selected-store-name').textContent = 'Select a store location';
                document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                
                updateStatus('✅ Signed out successfully');
                showNotification('You have been signed out', 'success');
                
                // Show login modal
                openAuthModal();
                
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error signing out', 'error');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            const button = document.querySelector('#user-menu-container button');
            
            if (dropdown.classList.contains('hidden')) {
                // Position dropdown relative to button
                const buttonRect = button.getBoundingClientRect();
                dropdown.style.top = (buttonRect.bottom + 8) + 'px';
                dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        // Profile Settings Functions
        function showProfile() {
            console.log('🔧 Opening profile settings modal...');
            document.getElementById('user-dropdown').classList.add('hidden');
            document.getElementById('profile-settings-modal').classList.remove('hidden');
            document.body.classList.add('modal-open');
            loadProfileData();
        }

        function closeProfileModal() {
            console.log('🔧 Closing profile settings modal...');
            document.getElementById('profile-settings-modal').classList.add('hidden');
            document.body.classList.remove('modal-open');
        }

        async function loadProfileData() {
            console.log('🔄 Loading profile data for modal...');
            
            if (!userProfile) {
                console.log('❌ No user profile available');
                return;
            }

            // Load personal info
            document.getElementById('profile-full-name').value = userProfile.full_name || '';
            document.getElementById('profile-email').value = userProfile.email || currentUser?.email || '';

            // Load preferences
            const darkModePreference = userProfile.dark_mode_preference || 'system';
            document.querySelector(`input[name="dark-mode"][value="${darkModePreference}"]`).checked = true;
            
            document.getElementById('profile-email-notifications').checked = userProfile.email_notifications !== false;

            // Load default store dropdown
            const defaultStoreSelect = document.getElementById('profile-default-store');
            defaultStoreSelect.innerHTML = '<option value="">Select a default store</option>';
            
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                if (store.id === userProfile.default_store_id) {
                    option.selected = true;
                }
                defaultStoreSelect.appendChild(option);
            });

            // Load store access
            await loadProfileStoreAccess();

            // Update profile avatar
            updateProfileAvatar();
            updateHeaderAvatar();
        }

        function updateProfileAvatar() {
            const avatarElement = document.getElementById('profile-avatar');
            const fullName = userProfile?.full_name || currentUser?.email || 'User';
            
            if (userProfile?.profile_picture_url) {
                // Use profile picture if available
                avatarElement.style.backgroundImage = `url(${userProfile.profile_picture_url})`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.style.backgroundPosition = 'center';
                avatarElement.textContent = '';
            } else {
                // Use initials
                avatarElement.style.backgroundImage = '';
                avatarElement.style.backgroundSize = '';
                avatarElement.style.backgroundPosition = '';
                avatarElement.textContent = getInitials(fullName);
            }
        }

        function updateHeaderAvatar() {
            const headerAvatarElement = document.getElementById('header-user-avatar');
            const userInitialsElement = document.getElementById('user-initials');
            const fullName = userProfile?.full_name || currentUser?.email || 'User';
            
            if (userProfile?.profile_picture_url) {
                // Use profile picture if available
                headerAvatarElement.style.backgroundImage = `url(${userProfile.profile_picture_url})`;
                headerAvatarElement.style.backgroundSize = 'cover';
                headerAvatarElement.style.backgroundPosition = 'center';
                headerAvatarElement.style.backgroundRepeat = 'no-repeat';
                if (userInitialsElement) userInitialsElement.style.display = 'none';
            } else {
                // Use initials
                headerAvatarElement.style.backgroundImage = '';
                headerAvatarElement.style.backgroundSize = '';
                headerAvatarElement.style.backgroundPosition = '';
                headerAvatarElement.style.backgroundRepeat = '';
                if (userInitialsElement) {
                    userInitialsElement.style.display = '';
                    userInitialsElement.textContent = getInitials(fullName);
                }
            }
        }

        function getInitials(name) {
            return name
                .split(' ')
                .map(word => word.charAt(0))
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        async function loadProfileStoreAccess() {
            console.log('🔄 Loading store access for profile...');
            
            try {
                // First try to get store access from user_store_access table
                const { data: storeAccess, error } = await supabase
                    .from('user_store_access')
                    .select('*, stores(*)')
                    .eq('user_id', currentUser.id)
                    .eq('active', true);

                if (error) {
                    console.log('Error loading store access, trying fallback:', error);
                    // Fallback: show current stores if user_store_access fails
                    const storeAccessList = document.getElementById('profile-store-access-list');
                    storeAccessList.innerHTML = '';
                    
                    if (stores && stores.length > 0) {
                        stores.forEach(store => {
                            const storeItem = document.createElement('div');
                            storeItem.className = 'store-access-item flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';
                            storeItem.innerHTML = `
                                <div>
                                    <h5 class="font-medium text-gray-900 dark:text-gray-100">${store.name}</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">employee</p>
                                </div>
                                <div class="store-address text-sm text-gray-500 dark:text-gray-400">
                                    ${store.address}
                                </div>
                            `;
                            storeAccessList.appendChild(storeItem);
                        });
                    } else {
                        storeAccessList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No stores available</p>';
                    }
                    return;
                }

                const storeAccessList = document.getElementById('profile-store-access-list');
                storeAccessList.innerHTML = '';

                if (storeAccess && storeAccess.length > 0) {
                    storeAccess.forEach(access => {
                        const storeItem = document.createElement('div');
                        storeItem.className = 'store-access-item flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';
                        storeItem.innerHTML = `
                            <div>
                                <h5 class="font-medium text-gray-900 dark:text-gray-100">${access.stores.name}</h5>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${access.access_level}</p>
                            </div>
                            <div class="store-address text-sm text-gray-500 dark:text-gray-400">
                                ${access.stores.address}
                            </div>
                        `;
                        storeAccessList.appendChild(storeItem);
                    });
                } else {
                    // Fallback: show current stores if no store access records found
                    if (stores && stores.length > 0) {
                        stores.forEach(store => {
                            const storeItem = document.createElement('div');
                            storeItem.className = 'store-access-item flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700';
                            storeItem.innerHTML = `
                                <div>
                                    <h5 class="font-medium text-gray-900 dark:text-gray-100">${store.name}</h5>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">employee</p>
                                </div>
                                <div class="store-address text-sm text-gray-500 dark:text-gray-400">
                                    ${store.address}
                                </div>
                            `;
                            storeAccessList.appendChild(storeItem);
                        });
                    } else {
                        storeAccessList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No stores available</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading store access:', error);
                document.getElementById('profile-store-access-list').innerHTML = '<p class="text-sm text-red-500">Error loading store access</p>';
            }
        }

        function switchProfileTab(tabName) {
            console.log('🔄 Switching to profile tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.remove('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400', 'border-green-500', 'text-green-600', 'dark:text-green-400');
                tab.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            });
            
            // Show selected tab content
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            
            // Add active class to selected tab - use green for light mode, blue for dark mode
            const activeTab = document.getElementById(`tab-${tabName}`);
            if (document.body.classList.contains('dark')) {
                activeTab.classList.add('active', 'border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            } else {
                activeTab.classList.add('active', 'border-green-500', 'text-green-600');
            }
            activeTab.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
        }

        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('📸 Uploading profile picture...');
            
            try {
                // Validate file type and size
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification('Image file size must be less than 5MB', 'error');
                    return;
                }

                // Upload to Supabase storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/profile-${Date.now()}.${fileExt}`;
                
                const { data, error } = await supabase.storage
                    .from('profile-pictures')
                    .upload(fileName, file);

                if (error) throw error;

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('profile-pictures')
                    .getPublicUrl(fileName);

                // Update profile with new picture URL
                const { error: updateError } = await supabase
                    .from('user_profiles')
                    .update({ profile_picture_url: publicUrl })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                // Update local profile data
                userProfile.profile_picture_url = publicUrl;
                
                // Update avatar display
                updateProfileAvatar();
                updateHeaderAvatar();
                
                showNotification('Profile picture updated successfully! 📸', 'success');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showNotification('Error uploading profile picture: ' + error.message, 'error');
            }
        }

        async function saveProfileSettings() {
            console.log('💾 Saving profile settings...');
            
            try {
                const fullName = document.getElementById('profile-full-name').value.trim();
                const darkModePreference = document.querySelector('input[name="dark-mode"]:checked').value;
                const defaultStoreId = document.getElementById('profile-default-store').value;
                const emailNotifications = document.getElementById('profile-email-notifications').checked;

                // Validate required fields
                if (!fullName) {
                    showNotification('Full name is required', 'error');
                    return;
                }

                // Prepare update data
                const updateData = {
                    full_name: fullName,
                    dark_mode_preference: darkModePreference,
                    email_notifications: emailNotifications,
                    updated_at: new Date().toISOString()
                };

                // Only update default store if one is selected
                if (defaultStoreId) {
                    updateData.default_store_id = defaultStoreId;
                }

                // Update profile in database
                const { error } = await supabase
                    .from('user_profiles')
                    .update(updateData)
                    .eq('id', currentUser.id);

                if (error) throw error;

                // Update local profile data
                Object.assign(userProfile, updateData);

                // Apply dark mode preference immediately
                applyDarkModePreference(darkModePreference);

                // Update user display
                updateUserDisplay();

                showNotification('Profile settings saved successfully! ✅', 'success');
                closeProfileModal();
                
            } catch (error) {
                console.error('Error saving profile settings:', error);
                showNotification('Error saving profile settings: ' + error.message, 'error');
            }
        }

        function applyDarkModePreference(preference) {
            console.log('🎨 Applying dark mode preference:', preference);
            
            const body = document.body;
            
            if (preference === 'dark') {
                body.classList.add('dark');
                localStorage.setItem('darkMode', 'dark');
            } else if (preference === 'light') {
                body.classList.remove('dark');
                localStorage.setItem('darkMode', 'light');
            } else {
                // System preference - check system preference
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    body.classList.add('dark');
                    localStorage.setItem('darkMode', 'dark');
                } else {
                    body.classList.remove('dark');
                    localStorage.setItem('darkMode', 'light');
                }
            }
        }

        async function resetPassword() {
            console.log('🔐 Initiating password reset...');
            
            try {
                const { error } = await supabase.auth.resetPasswordForEmail(currentUser.email, {
                    redirectTo: window.location.origin + '/temptracker-supabase/reset-password.html'
                });

                if (error) throw error;

                showNotification('Password reset email sent! Check your inbox 📧', 'success');
                
            } catch (error) {
                console.error('Error sending password reset:', error);
                showNotification('Error sending password reset: ' + error.message, 'error');
            }
        }

        function showPasswordResetPage() {
            console.log('🔓 Opening password reset modal...');
            
            // Close any competing modals first
            const authModal = document.getElementById('auth-modal');
            if (authModal && !authModal.classList.contains('hidden')) {
                authModal.classList.add('hidden');
                console.log('🔒 Closed auth modal to show password reset');
            }
            
            const modal = document.getElementById('password-reset-page');
            if (modal) {
                modal.classList.remove('hidden');
                console.log('✅ Password reset modal opened with high z-index');
            } else {
                console.error('❌ Password reset modal not found!');
            }
        }

        function closePasswordResetPage() {
            document.getElementById('password-reset-page').classList.add('hidden');
            document.getElementById('password-reset-form').reset();
        }

        async function handleNewPasswordSubmit(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showNotification('Password must be at least 6 characters long', 'error');
                return;
            }
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                showNotification('Password updated successfully!', 'success');
                closePasswordResetPage();
                
            } catch (error) {
                console.error('Error updating password:', error);
                showNotification('Error updating password: ' + error.message, 'error');
            }
        }

        // Check for password reset token on page load
        function checkPasswordResetToken() {
            let urlParams;
            let accessToken, refreshToken, type;
            
            // Check hash fragment first (modern Supabase format)
            if (window.location.hash) {
                urlParams = new URLSearchParams(window.location.hash.substring(1));
                accessToken = urlParams.get('access_token');
                refreshToken = urlParams.get('refresh_token');
                type = urlParams.get('type');
            } else {
                // Fallback: check query parameters
                urlParams = new URLSearchParams(window.location.search);
                accessToken = urlParams.get('access_token');
                refreshToken = urlParams.get('refresh_token');
                type = urlParams.get('type');
            }
            
            if (type === 'recovery' && accessToken && refreshToken) {
                // Set the session with the tokens
                supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                }).then(({ data, error }) => {
                    if (!error && data.user) {
                        console.log('🔑 Password reset token verified successfully');
                        console.log('👤 User logged in:', data.user.email);
                        console.log('🔄 About to show password reset modal...');
                        showPasswordResetPage();
                        // Clear the URL parameters
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } else {
                        console.error('❌ Token verification failed:', error);
                        showNotification('Invalid or expired reset link. Please request a new password reset.', 'error');
                    }
                });
            }
        }

        // Profile Camera Functions
        async function openProfileCamera() {
            console.log('📸 Opening profile camera...');
            
            try {
                // Check if we're on mobile or have camera access
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'user' // Use front camera for profile pictures
                        }
                    });
                    
                    // Create camera modal
                    showProfileCameraModal(stream);
                } else {
                    // Fallback to file input with camera capture
                    document.getElementById('profile-picture-input').setAttribute('capture', 'user');
                    document.getElementById('profile-picture-input').click();
                }
            } catch (error) {
                console.error('Camera access denied:', error);
                showNotification('Camera access denied. Using file picker instead.', 'error');
                document.getElementById('profile-picture-input').click();
            }
        }

        function showProfileCameraModal(stream) {
            // Create camera modal HTML
            const cameraModal = document.createElement('div');
            cameraModal.id = 'profile-camera-modal';
            cameraModal.className = 'fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4';
            cameraModal.style.zIndex = '999999';
            
            cameraModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">Take Profile Picture</h3>
                        <button onclick="closeProfileCameraModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <video id="profile-camera-video" class="w-full rounded-lg" autoplay playsinline></video>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="captureProfilePhoto()" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-2xl font-semibold transition-colors">
                            📷 Capture
                        </button>
                        <button onclick="closeProfileCameraModal()" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(cameraModal);
            
            // Start video stream
            const video = document.getElementById('profile-camera-video');
            video.srcObject = stream;
            
            // Store stream for cleanup
            window.currentProfileCameraStream = stream;
        }

        function captureProfilePhoto() {
            const video = document.getElementById('profile-camera-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                if (blob) {
                    // Create a file from the blob
                    const file = new File([blob], `profile-${Date.now()}.jpg`, { type: 'image/jpeg' });
                    
                    // Upload the captured photo
                    await uploadProfilePicture(file);
                }
            }, 'image/jpeg', 0.8);
            
            // Close camera modal
            closeProfileCameraModal();
            
            showNotification('Profile photo captured successfully! 📷', 'success');
        }

        function closeProfileCameraModal() {
            const modal = document.getElementById('profile-camera-modal');
            if (modal) {
                modal.remove();
            }
            
            // Stop camera stream
            if (window.currentProfileCameraStream) {
                window.currentProfileCameraStream.getTracks().forEach(track => track.stop());
                window.currentProfileCameraStream = null;
            }
        }

        async function uploadProfilePicture(file) {
            console.log('📸 Uploading profile picture...');
            
            try {
                // Validate file type and size
                if (!file.type.startsWith('image/')) {
                    showNotification('Please select a valid image file', 'error');
                    return;
                }

                if (file.size > 5 * 1024 * 1024) { // 5MB limit
                    showNotification('Image file size must be less than 5MB', 'error');
                    return;
                }

                // Upload to Supabase storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/profile-${Date.now()}.${fileExt}`;
                
                const { data, error } = await supabase.storage
                    .from('profile-pictures')
                    .upload(fileName, file);

                if (error) throw error;

                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('profile-pictures')
                    .getPublicUrl(fileName);

                // Update profile with new picture URL
                const { error: updateError } = await supabase
                    .from('user_profiles')
                    .update({ profile_picture_url: publicUrl })
                    .eq('id', currentUser.id);

                if (updateError) throw updateError;

                // Update local profile data
                userProfile.profile_picture_url = publicUrl;
                
                // Update avatar display
                updateProfileAvatar();
                updateHeaderAvatar();
                
                showNotification('Profile picture updated successfully! 📸', 'success');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showNotification('Error uploading profile picture: ' + error.message, 'error');
            }
        }

        // Manual refresh function for debugging
        async function refreshUserProfile() {
            console.log('Manually refreshing user profile...');
            if (currentUser) {
                await loadUserProfile();
                if (userProfile?.default_store_id && !selectedStore) {
                    await loadDefaultStore();
                }
                updateUserDisplay();
                showNotification('Profile refreshed', 'success');
            }
        }

        // Debug function to check authentication status
        async function debugAuth() {
            console.log('=== AUTH DEBUG INFO ===');
            console.log('Current User:', currentUser);
            console.log('User Profile:', userProfile);
            console.log('Selected Store:', selectedStore);
            console.log('Available Stores:', stores);
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                console.log('Supabase Session:', session);
                
                if (session?.user) {
                    console.log('Session User ID:', session.user.id);
                    console.log('Session User Email:', session.user.email);
                    console.log('Email Confirmed:', session.user.email_confirmed_at);
                    
                    // Check user profile in database
                    const { data: profile, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    console.log('Database Profile:', profile);
                    if (profileError) console.log('Profile Error:', profileError);
                    
                    // Check user store access
                    const { data: storeAccess, error: accessError } = await supabase
                        .from('user_store_access')
                        .select('*, stores(*)')
                        .eq('user_id', session.user.id);
                    
                    console.log('Store Access:', storeAccess);
                    if (accessError) console.log('Store Access Error:', accessError);
                }
            } catch (error) {
                console.log('Debug Error:', error);
            }
            
            console.log('=== END DEBUG INFO ===');
        }

        // Fix function to manually set default store
        async function fixDefaultStore(storeId) {
            if (!currentUser) {
                console.log('❌ No current user');
                return;
            }
            
            try {
                console.log('🔧 Setting default store to:', storeId);
                
                // Update user profile with new default store
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ default_store_id: storeId })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // Reload profile and stores
                await loadUserProfile();
                await loadDefaultStore();
                
                console.log('✅ Default store updated successfully');
                showNotification('Default store updated!', 'success');
                
            } catch (error) {
                console.error('❌ Error updating default store:', error);
                showNotification('Error updating default store', 'error');
            }
        }

        // Time function removed - no longer displaying current time
        
        // Debug function to check UI Inspector status
        window.debugUIInspector = function() {
            console.log('🔍 Debug UI Inspector Status:');
            console.log('UIInspector object:', UIInspector);
            console.log('UIInspector.enabled:', UIInspector?.enabled);
            console.log('Is Admin:', isCurrentUserAdmin());
            console.log('UI Inspector Permission:', userPermissions?.ui_inspector);
            console.log('All Permissions:', userPermissions);
            
            // Check HTML elements exist
            const menu = document.getElementById('ui-inspector-menu');
            const panel = document.getElementById('ui-inspector-panel');
            console.log('Context menu element exists:', !!menu);
            console.log('Inspector panel element exists:', !!panel);
            
            // Check if event listeners are attached
            console.log('Testing right-click handler...');
            
            // Force enable for testing
            if (isCurrentUserAdmin()) {
                console.log('🔧 Force enabling UI Inspector for admin...');
                initializeUIInspector();
                showNotification('UI Inspector force-enabled! Try right-clicking now.', 'info');
                
                // Test the context menu directly
                console.log('Testing context menu display...');
                showInspectorContextMenu(100, 100);
            } else {
                console.log('❌ Not admin - cannot enable UI Inspector');
            }
        };
        
        // Simple test function to bypass all checks
        window.testContextMenu = function() {
            console.log('🧪 Testing context menu directly...');
            const menu = document.getElementById('ui-inspector-menu');
            if (menu) {
                menu.style.left = '100px';
                menu.style.top = '100px';
                menu.classList.remove('hidden');
                console.log('✅ Context menu should be visible now');
                showNotification('Context menu test - check for menu at top-left', 'info');
            } else {
                console.log('❌ Context menu element not found!');
            }
        };
        
        // Permission Management Functions
        let userPermissions = {};
        
        // Check if current user is admin
        function isCurrentUserAdmin() {
            return userProfile?.is_admin === true || userProfile?.role === 'admin';
        }
        
        // Load all permissions for current user
        async function loadUserPermissions() {
            try {
                // Load global permissions
                const { data: globalPerms, error } = await supabase
                    .from('global_permissions')
                    .select('*');
                
                if (error) throw error;
                
                // Check if ui_inspector permission exists - if not, default to enabled for admins
                const hasUIInspectorPerm = globalPerms.find(perm => perm.permission_name === 'ui_inspector');
                if (!hasUIInspectorPerm) {
                    console.log('🔧 UI Inspector permission not found in database - defaulting to enabled for admins');
                }
                
                // Build permissions object
                userPermissions = {};
                globalPerms.forEach(perm => {
                    // If user is admin, use admin permissions, otherwise use user permissions
                    if (isCurrentUserAdmin()) {
                        userPermissions[perm.permission_name] = perm.enabled_for_admin;
                    } else {
                        userPermissions[perm.permission_name] = perm.enabled_for_users;
                    }
                });
                
                // Special handling for UI Inspector - check localStorage first
                const uiInspectorEnabled = localStorage.getItem('ui_inspector_enabled') === 'true';
                userPermissions.ui_inspector = uiInspectorEnabled;
                
                // Initialize UI Inspector if admin has permission
                if (isCurrentUserAdmin() && uiInspectorEnabled) {
                    console.log('🔧 UI Inspector permission check: enabling for admin');
                    initializeUIInspector();
                } else {
                    console.log('🔧 UI Inspector permission check: disabling');
                    disableUIInspector();
                }
                
                console.log('✅ Permissions loaded:', userPermissions);
                
                // After loading permissions, refresh UI
                refreshUIPermissions();
                
            } catch (error) {
                console.error('Error loading permissions:', error);
                // Default to allowing all permissions on error
                userPermissions = {
                    store_add: true,
                    store_edit: true,
                    store_delete: true,
                    store_reorder: true,
                    equipment_add: true,
                    equipment_edit: true,
                    equipment_delete: true,
                    equipment_reorder: true
                };
            }
        }
        
        // Check if current user has permission
        function checkPermission(permissionName) {
            // Always allow for admins if not explicitly disabled
            if (isCurrentUserAdmin() && userPermissions[permissionName] !== false) {
                return true;
            }
            return userPermissions[permissionName] === true;
        }
        
        // Update global permission setting (admin only)
        async function updateGlobalPermission(permissionName, enabledForAdmin, enabledForUsers) {
            if (!isCurrentUserAdmin()) {
                console.error('Only admins can update permissions');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('global_permissions')
                    .update({
                        enabled_for_admin: enabledForAdmin,
                        enabled_for_users: enabledForUsers,
                        updated_at: new Date()
                    })
                    .eq('permission_name', permissionName);
                
                if (error) throw error;
                
                console.log('✅ Permission updated:', permissionName);
                
                // Reload permissions and refresh UI
                await loadUserPermissions();
                
            } catch (error) {
                console.error('Error updating permission:', error);
                showNotification('Error updating permission: ' + error.message, 'error');
            }
        }
        
        // Refresh all UI elements based on permissions
        function refreshUIPermissions() {
            updateStoreManagementUI();
            updateEquipmentManagementUI();
            updateAdminMenuVisibility();
        }
        
        // Update store-related UI elements
        function updateStoreManagementUI() {
            // Add Store button
            const addStoreBtn = document.querySelector('[onclick="openAddStoreModal()"]');
            if (addStoreBtn) {
                addStoreBtn.style.display = checkPermission('store_add') ? 'inline-flex' : 'none';
            }
            
            // Edit Store buttons (including selected store edit button)
            document.querySelectorAll('[onclick*="editStore"], #edit-current-store-btn').forEach(btn => {
                btn.style.display = checkPermission('store_edit') ? 'inline-block' : 'none';
            });
            
            // Delete Store buttons
            document.querySelectorAll('[onclick*="deleteStore"]').forEach(btn => {
                btn.style.display = checkPermission('store_delete') ? 'inline-block' : 'none';
            });
            
            // Store drag handles
            document.querySelectorAll('.store-item .drag-handle, .store-item [title="Drag to reorder"]').forEach(handle => {
                handle.style.display = checkPermission('store_reorder') ? 'block' : 'none';
            });
        }
        
        // Update equipment-related UI elements
        function updateEquipmentManagementUI() {
            // Add Equipment button
            const addEquipmentBtn = document.querySelector('[onclick*="openEquipmentModal(\'add\'"]');
            if (addEquipmentBtn) {
                addEquipmentBtn.style.display = checkPermission('equipment_add') ? 'inline-flex' : 'none';
            }
            
            // Edit Equipment buttons
            document.querySelectorAll('[onclick*="openEquipmentModal(\'edit\'"]').forEach(btn => {
                btn.style.display = checkPermission('equipment_edit') ? 'inline-block' : 'none';
            });
            
            // Delete Equipment buttons
            document.querySelectorAll('[onclick*="deleteEquipment"]').forEach(btn => {
                btn.style.display = checkPermission('equipment_delete') ? 'inline-block' : 'none';
            });
            
            // Equipment drag handles
            document.querySelectorAll('[data-index] [title="Drag to reorder"]').forEach(handle => {
                handle.style.display = checkPermission('equipment_reorder') ? 'block' : 'none';
            });
        }
        
        // Update admin menu visibility
        function updateAdminMenuVisibility() {
            const adminDropdownItem = document.getElementById('admin-dropdown-item');
            if (adminDropdownItem) {
                if (isCurrentUserAdmin()) {
                    adminDropdownItem.classList.remove('hidden');
                    adminDropdownItem.classList.add('flex');
                } else {
                    adminDropdownItem.classList.add('hidden');
                    adminDropdownItem.classList.remove('flex');
                }
            }
        }

        // Initialize stores - Load from Supabase
        async function initStores() {
            try {
                updateStatus('Loading stores from database...');
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                stores = data || [];
                updateStoreCount();
                
                // Set default "Select a store" state instead of auto-selecting first store
                document.getElementById('selected-store-name').textContent = 'Select a store location';
                document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                document.getElementById('edit-current-store-btn').style.display = 'none';
                
                renderStoreDropdown();
                updateStatus('✅ Stores loaded successfully from database');
            } catch (error) {
                console.error('Error loading stores:', error);
                updateStatus('❌ Error loading stores: ' + error.message);
            }
        }

        // Load equipment from Supabase
        async function loadEquipmentFromDB(storeId) {
            try {
                const { data, error } = await supabase
                    .from('equipment')
                    .select('*')
                    .eq('store_id', storeId)
                    .eq('active', true)
                    .order('display_order');

                if (error) throw error;

                const storeEquipment = data || [];
                equipment = equipment.filter(eq => eq.store_id !== storeId).concat(storeEquipment);
                return storeEquipment;
            } catch (error) {
                console.error('Error loading equipment:', error);
                updateStatus('❌ Error loading equipment: ' + error.message);
                return [];
            }
        }

        // Load temperature logs from Supabase
        async function loadTemperatureLogsFromDB(storeId, fromDate = null, toDate = null) {
            try {
                let query = supabase
                    .from('temperature_logs')
                    .select(`
                        *,
                        equipment:equipment_id (
                            id,
                            name,
                            min_temp,
                            max_temp,
                            type
                        ),
                        user_profiles:logged_by_user_id (
                            id,
                            full_name,
                            email
                        )
                    `)
                    .eq('store_id', storeId)
                    .order('logged_at', { ascending: false });

                if (fromDate && toDate) {
                    query = query.gte('logged_at', fromDate).lte('logged_at', toDate);
                }

                const { data, error } = await query.limit(100);

                if (error) throw error;

                const logs = data || [];
                temperatureLogs = temperatureLogs.filter(log => log.store_id !== storeId).concat(logs);
                return logs;
            } catch (error) {
                console.error('Error loading temperature logs:', error);
                updateStatus('❌ Error loading temperature logs: ' + error.message);
                return [];
            }
        }

        // Load user profiles for export functions
        async function loadUserProfiles() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('id, full_name, email');

                if (error) throw error;

                userProfiles = data || [];
                console.log('✅ Loaded user profiles:', userProfiles.length);
                return userProfiles;
            } catch (error) {
                console.error('Error loading user profiles:', error);
                userProfiles = [];
                return [];
            }
        }

        // Update store count
        function updateStoreCount() {
            document.getElementById('total-stores').textContent = stores.length;
        }

        // Select store
        function selectStore(store) {
            selectedStore = store;
            document.getElementById('selected-store-name').textContent = store.name;
            document.getElementById('selected-store-address').textContent = store.address;
            
            // Show edit button when store is selected (if user has permission)
            document.getElementById('edit-current-store-btn').style.display = checkPermission('store_edit') ? 'block' : 'none';
            
            const dropdown = document.getElementById('store-dropdown');
            dropdown.classList.add('hidden');
            renderStoreDropdown();
            
            // Update user display if authenticated
            if (currentUser) {
                updateUserDisplay();
            }
            
            // Show temperature and equipment sections
            showTemperatureSection();
            showEquipmentSection();
            loadEquipmentForStore(store.id);
            loadTemperatureData(store.id);
            showSection('temperature'); // Default to temperature tab
        }

        // Show sections
        function showEquipmentSection() {
            document.getElementById('equipment-section').style.display = 'block';
            document.getElementById('selected-store-equipment').textContent = `Managing equipment for ${selectedStore.name}`;
        }
        
        function showTemperatureSection() {
            document.getElementById('temperature-section').style.display = 'block';
            document.getElementById('selected-store-temperature').textContent = `Logging temperatures for ${selectedStore.name}`;
        }

        // Load equipment for selected store from Supabase
        async function loadEquipmentForStore(storeId) {
            try {
                updateStatus('Loading equipment...');
                const storeEquipment = await loadEquipmentFromDB(storeId);
                renderEquipmentList(storeEquipment);
                
                // Update equipment count in stats
                try {
                    document.getElementById('equipment-count').textContent = storeEquipment.length;
                } catch (error) {
                    console.log('Could not update equipment count in stats:', error);
                }
                
                updateStatus('✅ Equipment loaded successfully');
            } catch (error) {
                console.error('Error in loadEquipmentForStore:', error);
                updateStatus('❌ Error loading equipment');
            }
        }

        // Render equipment list
        function renderEquipmentList(equipmentList) {
            const container = document.getElementById('equipment-list');
            
            if (equipmentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path>
                        </svg>
                        <p>No equipment found for this store</p>
                        <p class="text-sm mt-1">Click "Add Equipment" to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = equipmentList.map((eq, index) => {
                const lastLog = getLastTemperature(eq.id);
                const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
                const statusIcon = getStatusIcon(status);
                const statusColor = getStatusColor(status);
                const glowClass = getStatusGlowClass(status);
                
                return `
                <div class="glass rounded-xl p-4 flex flex-col sm:flex-row sm:items-center justify-between card-hover ${glowClass} transition-all duration-300 gap-4 sm:gap-0" 
                     draggable="true" 
                     data-index="${index}"
                     ondragstart="handleEquipmentDragStart(event)"
                     ondragover="handleEquipmentDragOver(event)"
                     ondrop="handleEquipmentDrop(event)"
                     ondragend="handleEquipmentDragEnd(event)">
                    <div class="flex items-center space-x-4 flex-1">
                        <div class="cursor-grab active:cursor-grabbing p-1 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation" title="Drag to reorder">
                            <svg class="h-5 w-5 sm:h-4 sm:w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        <div class="p-2 rounded-lg ${eq.photo ? 'p-0' : ''}" style="background: ${eq.photo ? 'transparent' : `linear-gradient(135deg, ${getEquipmentColor(eq.type)})`};">
                            ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-lg object-cover">` : getEquipmentIcon(eq.type)}
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-900 text-lg sm:text-base">${eq.name}</h3>
                            <p class="text-sm text-gray-600">${eq.location || 'No location set'}</p>
                            <p class="text-xs text-gray-500">Target: ${eq.min_temp}°F to ${eq.max_temp}°F</p>
                            ${lastLog ? `<p class="text-xs text-gray-400 mt-1">Last: ${lastLog.temperature}°F (${formatTimeAgo(lastLog.logged_at)})</p>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between sm:justify-center space-x-3 sm:space-x-3">
                        <div class="text-center">
                            <div class="mb-1">${statusIcon}</div>
                            <div class="text-xs font-medium" style="color: ${statusColor};">Status</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="openEquipmentHistoryModal('${eq.id}')" class="p-3 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center" title="View Temperature History">
                                <svg class="h-5 w-5 sm:h-4 sm:w-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </button>
                            <button onclick="openEquipmentModal('edit', '${eq.id}')" class="p-3 sm:p-2 hover:bg-gray-100 rounded-lg transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center" title="Edit Equipment">
                                <svg class="h-5 w-5 sm:h-4 sm:w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteEquipment('${eq.id}')" class="p-3 sm:p-2 hover:bg-red-100 rounded-lg transition-colors touch-manipulation min-h-[44px] min-w-[44px] sm:min-h-auto sm:min-w-auto flex items-center justify-center" title="Delete Equipment">
                                <svg class="h-5 w-5 sm:h-4 sm:w-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Equipment helper functions
        function getEquipmentColor(type) {
            const colors = {
                freezer: 'rgb(59, 130, 246), rgb(37, 99, 235)',
                cooler: 'rgb(16, 185, 129), rgb(5, 150, 105)',
                walk_in_freezer: 'rgb(139, 92, 246), rgb(124, 58, 237)',
                walk_in_cooler: 'rgb(34, 197, 94), rgb(22, 163, 74)',
                prep_cooler: 'rgb(168, 85, 247), rgb(147, 51, 234)',
                pizza_cooler: 'rgb(245, 101, 101), rgb(239, 68, 68)',
                reach_in: 'rgb(251, 146, 60), rgb(249, 115, 22)',
                hot_holding: 'rgb(248, 113, 113), rgb(239, 68, 68)',
                oven: 'rgb(251, 113, 133), rgb(244, 63, 94)',
                other: 'rgb(107, 114, 128), rgb(75, 85, 99)'
            };
            return colors[type] || colors.other;
        }

        function getEquipmentIcon(type) {
            const icons = {
                freezer: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>',
                cooler: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path></svg>',
                walk_in_freezer: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>',
                walk_in_cooler: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>',
                oven: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path></svg>',
                other: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path></svg>'
            };
            return icons[type] || icons.other;
        }

        function formatEquipmentType(type) {
            const types = {
                freezer: 'Freezer',
                cooler: 'Cooler',
                walk_in_freezer: 'Walk-in Freezer',
                walk_in_cooler: 'Walk-in Cooler',
                prep_cooler: 'Prep Cooler',
                pizza_cooler: 'Pizza Cooler',
                reach_in: 'Reach-in Unit',
                hot_holding: 'Hot Holding',
                oven: 'Oven',
                other: 'Other'
            };
            return types[type] || type;
        }

        // Equipment modal functions
        // Auto-populate temperature ranges based on equipment name
        function updateTemperatureRanges() {
            const equipmentName = document.getElementById('equipment-name').value;
            const minTempInput = document.getElementById('equipment-min-temp');
            const maxTempInput = document.getElementById('equipment-max-temp');
            
            // Industry standard temperature ranges based on health department guidelines
            const temperatureRanges = {
                'Pizza Make Table': { min: 33, max: 41 },
                'Sub Make Table': { min: 33, max: 41 },
                'Grill Make Table': { min: 33, max: 41 },
                'Walk-in Cooler': { min: 32, max: 40 },
                'Walk-in Freezer': { min: -10, max: 10 },
                'Reach-in Cooler': { min: 33, max: 41 },
                'Reach-in Freezer': { min: -5, max: 5 },
                'Beverage Cooler': { min: 33, max: 38 },
                'Alcohol Cooler': { min: 33, max: 38 },
                'Mug Freezer': { min: 0, max: 10 },
                'Hot Box': { min: 140, max: 165 },
                'Heat Lamp': { min: 140, max: 180 }
            };
            
            if (equipmentName && temperatureRanges[equipmentName]) {
                const range = temperatureRanges[equipmentName];
                minTempInput.value = range.min;
                maxTempInput.value = range.max;
            }
        }

        function openEquipmentModal(mode, equipmentId = null) {
            if (!selectedStore) {
                showNotification('Please select a store first', 'error');
                return;
            }

            const modal = document.getElementById('equipment-modal');
            const title = document.getElementById('equipment-modal-title');
            const form = modal.querySelector('form');
            
            if (mode === 'add') {
                title.textContent = 'Add Equipment';
                form.reset();
                document.getElementById('equipment-id').value = '';
                // Clear photo preview
                document.getElementById('photo-preview').classList.add('hidden');
                currentEquipmentPhoto = null;
            } else if (mode === 'edit' && equipmentId) {
                const eq = equipment.find(e => e.id === equipmentId);
                if (eq) {
                    title.textContent = 'Edit Equipment';
                    document.getElementById('equipment-id').value = eq.id;
                    document.getElementById('equipment-name').value = eq.name;
                    document.getElementById('equipment-min-temp').value = eq.min_temp;
                    document.getElementById('equipment-max-temp').value = eq.max_temp;
                    document.getElementById('equipment-location').value = eq.location || '';
                    
                    // Handle photo preview for editing
                    if (eq.photo) {
                        currentEquipmentPhoto = eq.photo;
                        document.getElementById('preview-image').src = eq.photo;
                        document.getElementById('photo-preview').classList.remove('hidden');
                    } else {
                        document.getElementById('photo-preview').classList.add('hidden');
                        currentEquipmentPhoto = null;
                    }
                }
            }
            
            modal.classList.remove('hidden');
            // Prevent background scrolling
            document.body.classList.add('modal-open');
        }

        function closeEquipmentModal() {
            console.log('🚪 Closing equipment modal...');
            const modal = document.getElementById('equipment-modal');
            modal.classList.add('hidden');
            
            // Reset photo preview
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('equipment-photo').value = '';
            currentEquipmentPhoto = null;
            
            // Re-enable background scrolling
            document.body.classList.remove('modal-open');
            
            console.log('✅ Equipment modal closed');
        }

        // This function is now handled directly in the onclick
        // function editEquipment(equipmentId) {
        //     openEquipmentModal('edit', equipmentId);
        // }

        async function deleteEquipment(equipmentId) {
            const equipmentItem = equipment.find(e => e.id === equipmentId);
            if (!equipmentItem) {
                showNotification('Equipment not found', 'error');
                return;
            }

            // Create styled delete confirmation modal
            const deleteModal = document.createElement('div');
            deleteModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            deleteModal.style.zIndex = '9999999';
            deleteModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-5xl mb-4">🗑️</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Equipment?</h3>
                        <p class="text-gray-600">"${equipmentItem.name}"</p>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="text-red-600 text-xl">⚠️</div>
                            <div class="flex-1">
                                <p class="text-sm text-red-800 font-medium mb-1">This action cannot be undone!</p>
                                <p class="text-sm text-red-700">All temperature logs for this equipment will also be deleted.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-6 bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-600">Location:</span>
                            <span class="text-gray-900">${equipmentItem.location || 'Not specified'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-600">Temp Range:</span>
                            <span class="text-gray-900">${equipmentItem.min_temp}°F - ${equipmentItem.max_temp}°F</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEquipmentDeleteModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmDeleteEquipment('${equipmentId}')" 
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
                            Delete Equipment
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            document.body.classList.add('modal-open');
        }

        window.closeEquipmentDeleteModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmDeleteEquipment = async function(equipmentId) {
            try {
                updateStatus('Deleting equipment...');

                // Soft delete equipment (set active = false)
                const { error } = await supabase
                    .from('equipment')
                    .update({ active: false })
                    .eq('id', equipmentId);

                if (error) throw error;

                // Remove from local equipment array
                const index = equipment.findIndex(e => e.id === equipmentId);
                if (index !== -1) {
                    equipment.splice(index, 1);
                }

                await loadEquipmentForStore(selectedStore.id);
                
                // Also reload temperature data to sync the lists
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('✅ Equipment deleted successfully');
                showNotification('Equipment deleted successfully! ✅', 'success');
                
                closeEquipmentDeleteModal();

            } catch (error) {
                console.error('Error deleting equipment:', error);
                updateStatus('❌ Error deleting equipment: ' + error.message);
                showNotification('Error deleting equipment: ' + error.message, 'error');
            }
        };

        async function saveEquipment(event) {
            event.preventDefault();
            
            console.log('🔧 Saving equipment...');
            
            // Get and disable the save button with loading state
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Saving...</span>
                </div>
            `;
            
            const equipmentId = document.getElementById('equipment-id').value;
            const equipmentName = document.getElementById('equipment-name').value;
            
            // Map equipment names to types for database compatibility
            const nameToTypeMap = {
                'Pizza Make Table': 'prep_cooler',
                'Sub Make Table': 'prep_cooler',
                'Grill Make Table': 'prep_cooler',
                'Walk-in Cooler': 'walk_in_cooler',
                'Walk-in Freezer': 'walk_in_freezer',
                'Reach-in Cooler': 'cooler',
                'Reach-in Freezer': 'freezer',
                'Beverage Cooler': 'cooler',
                'Alcohol Cooler': 'cooler',
                'Mug Freezer': 'freezer',
                'Hot Box': 'hot_holding',
                'Heat Lamp': 'hot_holding'
            };
            
            const equipmentData = {
                store_id: selectedStore.id,
                name: equipmentName,
                type: nameToTypeMap[equipmentName] || 'other',
                min_temp: parseFloat(document.getElementById('equipment-min-temp').value),
                max_temp: parseFloat(document.getElementById('equipment-max-temp').value),
                location: document.getElementById('equipment-location').value,
                photo: currentEquipmentPhoto,
                active: true
            };
            
            console.log('📊 Equipment data:', equipmentData);
            
            try {
                updateStatus('Saving equipment...');
                
                if (equipmentId) {
                    // Update existing equipment
                    const { data, error } = await supabase
                        .from('equipment')
                        .update(equipmentData)
                        .eq('id', equipmentId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local equipment array
                    const index = equipment.findIndex(e => e.id === equipmentId);
                    if (index !== -1) {
                        equipment[index] = data;
                    }
                    
                    console.log('✏️ Updated existing equipment in database');
                    showNotification('Equipment updated successfully! ✅', 'success');
                } else {
                    // Add new equipment
                    const { data, error } = await supabase
                        .from('equipment')
                        .insert(equipmentData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Add to local equipment array
                    equipment.push(data);
                    console.log('➕ Added new equipment to database');
                    showNotification('Equipment added successfully! ✅', 'success');
                }
                
                // Reset the photo variable for next use
                currentEquipmentPhoto = null;
                
                // Reload equipment for current store
                await loadEquipmentForStore(selectedStore.id);
                
                // Also reload temperature data to sync the lists
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('✅ Equipment saved successfully');
                
                // Reset button state
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
                
                console.log('🚪 Calling closeEquipmentModal...');
                closeEquipmentModal();
                console.log('✅ Save equipment complete');
                
            } catch (error) {
                console.error('Error saving equipment:', error);
                updateStatus('❌ Error saving equipment: ' + error.message);
                showNotification('Error saving equipment: ' + error.message, 'error');
                
                // Reset button state on error
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }

        // Toggle store modal (used in both light and dark mode now)
        function toggleDropdown() {
            openStoreModal();
        }
        
        // Open store selection modal
        function openStoreModal() {
            const modal = document.getElementById('store-selection-modal');
            renderStoreModalContent();
            modal.classList.remove('hidden');
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
        }
        
        // Close store selection modal
        function closeStoreModal() {
            const modal = document.getElementById('store-selection-modal');
            modal.classList.add('hidden');
            // Restore scrolling
            document.body.style.overflow = '';
        }

        // Equipment history modal functions
        async function openEquipmentHistoryModal(equipmentId) {
            const equipmentItem = equipment.find(eq => eq.id === equipmentId);
            if (!equipmentItem) return;
            
            const modal = document.getElementById('equipment-history-modal');
            const title = document.getElementById('equipment-history-title');
            const container = document.getElementById('equipment-history-list');
            
            title.textContent = `${equipmentItem.name} - Temperature History`;
            
            // Show loading
            container.innerHTML = '<div class="text-center py-8 text-gray-500">Loading temperature history...</div>';
            
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            try {
                // Get temperature logs for this equipment
                const logs = temperatureLogs
                    .filter(log => log.equipment_id === equipmentId)
                    .sort((a, b) => new Date(b.logged_at) - new Date(a.logged_at))
                    .slice(0, 50); // Show last 50 entries
                
                if (logs.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No temperature history found for this equipment.</div>';
                    return;
                }
                
                container.innerHTML = logs.map(log => {
                    const status = getTemperatureStatus(log.temperature, equipmentItem.min_temp, equipmentItem.max_temp);
                    const statusIcon = getStatusIcon(status);
                    const statusColor = getStatusColor(status);
                    const logDate = new Date(log.logged_at);
                    
                    return `
                        <div class="history-item rounded-xl p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-4">
                                    <div class="text-center">
                                        <div class="mb-1">${statusIcon}</div>
                                        <div class="text-xs font-medium" style="color: ${statusColor};">Status</div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-lg">${log.temperature}°F</h4>
                                        <p class="text-sm">Target: ${equipmentItem.min_temp}°F to ${equipmentItem.max_temp}°F</p>
                                        <p class="text-xs mt-1">${logDate.toLocaleDateString()} at ${logDate.toLocaleTimeString()}</p>
                                        ${log.user_profiles?.full_name ? `<p class="text-xs text-gray-400">Logged by: ${log.user_profiles.full_name}</p>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs">${formatTimeAgo(log.logged_at)} ago</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading equipment history:', error);
                container.innerHTML = '<div class="text-center py-8 text-red-500">Error loading temperature history.</div>';
            }
        }

        function closeEquipmentHistoryModal() {
            const modal = document.getElementById('equipment-history-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        // Select store from modal and close
        function selectStoreFromModal(storeId) {
            const store = stores.find(s => s.id === storeId);
            if (store) {
                selectStore(store);
                closeStoreModal();
            }
        }
        
        // Render store modal content
        function renderStoreModalContent() {
            const container = document.getElementById('store-modal-list');
            const sortedStores = stores.sort((a, b) => a.display_order - b.display_order);
            const isDarkMode = document.body.classList.contains('dark');
            
            container.innerHTML = sortedStores.map((store, index) => `
                <div class="store-modal-item bg-white dark:bg-gray-700 rounded-xl p-4 hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors mb-3 last:mb-0 border-2 border-gray-300 dark:border-white/30"
                     ${checkPermission('store_reorder') ? `draggable="true" data-index="${index}" data-store-id="${store.id}"
                     ondragstart="handleStoreModalDragStart(event)"
                     ondragover="handleStoreModalDragOver(event)"
                     ondrop="handleStoreModalDrop(event)"
                     ondragend="handleStoreModalDragEnd(event)"` : ''}>
                    <div class="flex items-center justify-between">
                        ${checkPermission('store_reorder') ? `
                        <div class="drag-handle mr-3 text-gray-400 hover:text-gray-600 cursor-move" title="Drag to reorder">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        ` : ''}
                        <div class="flex items-center space-x-4 flex-1 cursor-pointer" onclick="selectStoreFromModal('${store.id}')">
                            <div class="p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-900 dark:text-gray-100 store-name">${store.name}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-300">${store.address}</p>
                                ${store.phone ? `<p class="text-xs text-gray-500 dark:text-gray-400">${store.phone}</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-1">
                            ${checkPermission('store_edit') ? `
                            <button onclick="editStore('${store.id}')" class="p-2 hover:bg-transparent rounded-lg transition-colors" title="Edit Store">
                                <svg class="h-4 w-4 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            ` : ''}
                            ${checkPermission('store_delete') ? `
                            <button onclick="deleteStore('${store.id}')" class="p-2 hover:bg-transparent rounded-lg transition-colors" title="Delete Store">
                                <svg class="h-4 w-4 text-red-500 hover:text-red-700 dark:hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render store dropdown with drag-and-drop
        function renderStoreDropdown() {
            console.log('Rendering dropdown with stores:', stores);
            const storeList = document.getElementById('store-list');
            
            // Sort stores by display_order, fallback to name
            const sortedStores = [...stores].sort((a, b) => {
                if (a.display_order !== undefined && b.display_order !== undefined) {
                    return a.display_order - b.display_order;
                }
                return a.name.localeCompare(b.name);
            });
            
            storeList.innerHTML = sortedStores.map((store, index) => `
                <div class="store-item flex items-center justify-between p-4 hover:bg-green-50 transition-colors border-b border-gray-200/50 last:border-b-0 cursor-move" 
                     draggable="true" 
                     data-store-id="${store.id}" 
                     data-index="${index}"
                     ondragstart="handleStoreDragStart(event)"
                     ondragover="handleStoreDragOver(event)"
                     ondrop="handleStoreDrop(event)"
                     ondragend="handleStoreDragEnd(event)">
                    <div class="flex items-center flex-1">
                        <div class="drag-handle mr-3 text-gray-400 hover:text-gray-600" title="Drag to reorder">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        <button onclick="selectStore(${JSON.stringify(store).replace(/"/g, '&quot;')})" 
                                class="flex-1 text-left ${selectedStore?.id === store.id ? 'font-bold' : 'text-gray-900'}" style="${selectedStore?.id === store.id ? 'color: rgb(58, 109, 55);' : ''}">
                            <p class="font-bold">${store.name}</p>
                            <p class="text-sm text-gray-600">${store.address}</p>
                            ${store.manager ? `<p class="text-xs text-gray-500 mt-1">Manager: ${store.manager}</p>` : ''}
                        </button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="editStore('${store.id}')" class="p-2 hover:bg-gray-200 rounded-lg transition-colors" title="Edit Store">
                            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteStore('${store.id}')" class="p-2 hover:bg-red-100 rounded-lg transition-colors" title="Delete Store">
                            <svg class="h-4 w-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal functions
        function openAddStoreModal() {
            // Close dropdown first
            document.getElementById('store-dropdown').classList.add('hidden');
            
            // Open modal
            document.getElementById('modal-title').textContent = 'Add New Store';
            document.getElementById('store-id').value = '';
            document.getElementById('store-name').value = '';
            document.getElementById('store-address').value = '';
            document.getElementById('store-phone').value = '';
            document.getElementById('store-manager').value = '';
            document.getElementById('store-modal').classList.remove('hidden');
            
            // Prevent background scrolling
            document.body.classList.add('modal-open');
        }

        function editStore(storeId) {
            // Close modal/dropdown first
            closeStoreModal();
            document.getElementById('store-dropdown').classList.add('hidden');
            
            const store = stores.find(s => s.id === storeId);
            if (store) {
                document.getElementById('modal-title').textContent = 'Edit Store';
                document.getElementById('store-id').value = store.id;
                document.getElementById('store-name').value = store.name;
                document.getElementById('store-address').value = store.address;
                document.getElementById('store-phone').value = store.phone || '';
                document.getElementById('store-manager').value = store.manager || '';
                document.getElementById('store-modal').classList.remove('hidden');
                
                // Prevent background scrolling
                document.body.classList.add('modal-open');
            }
        }

        // Delete store with confirmation
        async function deleteStore(storeId) {
            // Close modal/dropdown first
            closeStoreModal();
            document.getElementById('store-dropdown').classList.add('hidden');
            
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                showNotification('Store not found', 'error');
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete "${store.name}"?\n\nThis action cannot be undone and will also delete all associated equipment and temperature logs.`);
            
            if (!confirmed) {
                return;
            }

            try {
                updateStatus('Deleting store...');

                // First, soft delete the store (set active = false)
                const { error } = await supabase
                    .from('stores')
                    .update({ active: false })
                    .eq('id', storeId);

                if (error) throw error;

                // Remove from local stores array
                stores = stores.filter(s => s.id !== storeId);
                updateStoreCount();

                // If this was the selected store, reset selection
                if (selectedStore && selectedStore.id === storeId) {
                    selectedStore = null;
                    document.getElementById('selected-store-name').textContent = 'Select a store location';
                    document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                    document.getElementById('edit-current-store-btn').style.display = 'none';
                    
                    // Hide temperature and equipment sections
                    document.getElementById('temperature-section').style.display = 'none';
                    document.getElementById('equipment-section').style.display = 'none';
                }

                renderStoreDropdown();
                updateStatus('✅ Store deleted successfully');
                showNotification('Store deleted successfully!', 'success');

            } catch (error) {
                console.error('Error deleting store:', error);
                updateStatus('❌ Error deleting store: ' + error.message);
                showNotification('Error deleting store: ' + error.message, 'error');
            }
        }

        function editCurrentStore(event) {
            event.stopPropagation();
            if (selectedStore) {
                editStore(selectedStore.id);
            }
        }

        function closeModal() {
            document.getElementById('store-modal').classList.add('hidden');
            // Re-enable background scrolling
            document.body.classList.remove('modal-open');
        }

        async function saveStore(event) {
            event.preventDefault();
            
            const storeId = document.getElementById('store-id').value;
            const storeData = {
                name: document.getElementById('store-name').value,
                address: document.getElementById('store-address').value,
                phone: document.getElementById('store-phone').value || null,
                manager: document.getElementById('store-manager').value || null,
                active: true
            };
            
            console.log('Saving store:', storeData);
            
            try {
                updateStatus('Saving store...');
                
                if (storeId) {
                    // Update existing store
                    const { data, error } = await supabase
                        .from('stores')
                        .update(storeData)
                        .eq('id', storeId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local stores array
                    const index = stores.findIndex(s => s.id === storeId);
                    if (index !== -1) {
                        stores[index] = data;
                        if (selectedStore && selectedStore.id === storeId) {
                            selectStore(data);
                        }
                    }
                    
                    showNotification('Store updated successfully! ✅', 'success');
                } else {
                    // Add new store
                    const { data, error } = await supabase
                        .from('stores')
                        .insert(storeData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Add to local stores array
                    stores.push(data);
                    stores.sort((a, b) => a.name.localeCompare(b.name));
                    
                    showNotification('Store added successfully! ✅', 'success');
                }
                
                updateStoreCount();
                renderStoreDropdown();
                closeModal();
                updateStatus('✅ Store saved successfully');
                
                console.log('Total stores now:', stores.length);
                console.log('All stores:', stores);
                
            } catch (error) {
                console.error('Error saving store:', error);
                updateStatus('❌ Error saving store: ' + error.message);
                showNotification('Error saving store: ' + error.message, 'error');
            }
        }
        function updateStatus(message) {
            const statusList = document.getElementById('status-list');
            const secondItem = statusList.children[1];
            if (secondItem) {
                secondItem.innerHTML = `
                    <span class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: rgb(58, 109, 55);"></span>
                    <span class="font-medium">${message}</span>
                `;
            }
        }
        // Dark mode functionality
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            
            // Update icon
            const themeIcon = document.getElementById('theme-icon');
            if (isDark) {
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            } else {
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDark);
        }

        // Load saved dark mode preference
        function loadDarkModePreference() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark');
                const themeIcon = document.getElementById('theme-icon');
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            }
        }

        // Photo handling functions
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentEquipmentPhoto = e.target.result;
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('photo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removePhoto() {
            currentEquipmentPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('equipment-photo').value = '';
        }
        
        async function openCamera() {
            try {
                // Check if we're on mobile or have camera access
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment', // Use back camera
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    // Create camera modal
                    showCameraModal(stream);
                } else {
                    // Fallback to file input with camera capture
                    const fileInput = document.getElementById('equipment-photo');
                    fileInput.click();
                }
            } catch (error) {
                console.error('Camera access denied:', error);
                showNotification('Camera access denied. Using file picker instead.', 'error');
                // Fallback to file input
                const fileInput = document.getElementById('equipment-photo');
                fileInput.click();
            }
        }
        
        function showCameraModal(stream) {
            // Create camera modal HTML
            const cameraModal = document.createElement('div');
            cameraModal.id = 'camera-modal';
            cameraModal.className = 'fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4';
            cameraModal.style.zIndex = '999999';
            
            cameraModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Take Photo</h3>
                            <button onclick="closeCameraModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                ✕
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <video id="camera-video" class="w-full rounded-lg" autoplay playsinline></video>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="capturePhoto()" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                📷 Capture
                            </button>
                            <button onclick="closeCameraModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(cameraModal);
            
            // Start video stream
            const video = document.getElementById('camera-video');
            video.srcObject = stream;
            
            // Store stream reference for cleanup
            window.currentCameraStream = stream;
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0);
            
            // Convert to base64
            const photoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Set as current photo
            currentEquipmentPhoto = photoData;
            document.getElementById('preview-image').src = photoData;
            document.getElementById('photo-preview').classList.remove('hidden');
            
            // Close camera modal
            closeCameraModal();
            
            showNotification('Photo captured successfully! 📷', 'success');
        }
        
        window.closeCameraModal = function() {
            const modal = document.getElementById('camera-modal');
            if (modal) {
                // Stop camera stream
                if (window.currentCameraStream) {
                    window.currentCameraStream.getTracks().forEach(track => track.stop());
                    window.currentCameraStream = null;
                }
                modal.remove();
            }
        }
        
        window.capturePhoto = capturePhoto;

        // Section management
        let currentSection = 'temperature';
        let bulkModeActive = false;
        let bulkTemperatures = {};
        
        function showSection(section) {
            currentSection = section;
            
            // Hide all sections
            document.getElementById('temperature-section').style.display = 'none';
            document.getElementById('equipment-section').style.display = 'none';
            
            // Show selected section
            if (section === 'temperature' && selectedStore) {
                document.getElementById('temperature-section').style.display = 'block';
            } else if (section === 'equipment' && selectedStore) {
                document.getElementById('equipment-section').style.display = 'block';
            }
            
            // Update tab styles
            document.getElementById('temp-tab').className = section === 'temperature' 
                ? 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-white glow-button'
                : 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900';
                
            document.getElementById('equipment-tab').className = section === 'equipment'
                ? 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-white glow-button'
                : 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900';
        }
        
        // Temperature logging functions
        async function loadTemperatureData(storeId) {
            try {
                updateStatus('Loading temperature data...');
                
                // Load temperature logs for this store
                const logs = await loadTemperatureLogsFromDB(storeId);
                
                // Update global temperatureLogs array with store data
                temperatureLogs = temperatureLogs.filter(log => log.store_id !== storeId);
                temperatureLogs.push(...logs);
                
                const storeEquipment = equipment.filter(eq => eq.store_id === storeId);
                
                // If no equipment loaded yet, load it first
                if (storeEquipment.length === 0) {
                    await loadEquipmentFromDB(storeId);
                    const refreshedEquipment = equipment.filter(eq => eq.store_id === storeId);
                    renderTemperatureList(refreshedEquipment);
                } else {
                    renderTemperatureList(storeEquipment);
                }
                
                // Re-render equipment list now that temperature data is loaded
                renderEquipmentList(equipment.filter(eq => eq.store_id === storeId));
                
                updateTemperatureStats(storeId);
                updateStatus('✅ Temperature data loaded');
            } catch (error) {
                console.error('Error loading temperature data:', error);
                updateStatus('❌ Error loading temperature data');
            }
        }
        
        function renderTemperatureList(equipmentList) {
            const container = document.getElementById('temperature-list');
            
            if (equipmentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>No equipment found for temperature logging</p>
                        <p class="text-sm mt-1">Add equipment first to start logging temperatures</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = equipmentList.map(eq => {
                const lastLog = getLastTemperature(eq.id);
                const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
                const statusIcon = getStatusIcon(status);
                const statusColor = getStatusColor(status);
                
                const glowClass = getStatusGlowClass(status);
                
                return `
                    <div class="glass rounded-xl p-4 flex flex-col sm:flex-row sm:items-center justify-between card-hover ${glowClass} transition-all duration-300 gap-4 sm:gap-0">
                        <div class="flex items-center space-x-4 flex-1">
                            <div class="p-2 rounded-lg ${eq.photo ? 'p-0' : ''}" style="background: ${eq.photo ? 'transparent' : `linear-gradient(135deg, ${getEquipmentColor(eq.type)})`};">
                                ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-lg object-cover">` : getEquipmentIcon(eq.type)}
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900 text-lg sm:text-base">${eq.name}</h3>
                                <p class="text-sm text-gray-600">${eq.location || 'No location set'}</p>
                                <p class="text-xs text-gray-500">Target: ${eq.min_temp}°F to ${eq.max_temp}°F</p>
                                ${lastLog ? `<p class="text-xs text-gray-400 mt-1">Last: ${lastLog.temperature}°F (${formatTimeAgo(lastLog.logged_at)})</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center justify-between sm:justify-center space-x-3 sm:space-x-3">
                            <div class="text-center">
                                <div class="mb-1">${statusIcon}</div>
                                <div class="text-xs font-medium" style="color: ${statusColor};">Status</div>
                            </div>
                            ${bulkModeActive ? `
                                <input type="number" 
                                       id="temp-${eq.id}" 
                                       placeholder="Temp"
                                       step="0.1"
                                       class="w-24 sm:w-20 px-3 py-3 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center min-h-[44px] touch-manipulation text-lg sm:text-base"
                                       onchange="updateBulkTemperature('${eq.id}', this.value)"
                                       onblur="updateTemperatureVisualFeedback('${eq.id}', this.value)"
                                       onkeypress="handleBulkTemperatureKeypress(event, '${eq.id}')">
                            ` : `
                                <button onclick="openTemperatureModal('${eq.id}')" class="glow-button text-white px-6 py-3 sm:px-4 sm:py-2 rounded-lg font-semibold min-h-[44px] touch-manipulation text-base">
                                    🌡️ Log
                                </button>
                            `}
                        </div>
                    </div>
                `;   
            }).join('');
        }
        
        function getLastTemperature(equipmentId) {
            const logs = temperatureLogs.filter(log => log.equipment_id === equipmentId)
                                      .sort((a, b) => new Date(b.logged_at) - new Date(a.logged_at));
            return logs[0] || null;
        }
        
        function getTemperatureStatus(temperature, minTemp, maxTemp) {
            if (!temperature && temperature !== 0) return 'unknown';
            
            // Red (Critical): 3+ degrees below min OR 3+ degrees above max
            if (temperature <= minTemp - 3 || temperature >= maxTemp + 3) return 'critical';
            
            // Yellow (Warning): 1-2 degrees below min OR 1-2 degrees above max
            if ((temperature >= minTemp - 2 && temperature < minTemp) || 
                (temperature > maxTemp && temperature <= maxTemp + 2)) return 'warning';
            
            // Green (Good): Within range
            if (temperature >= minTemp && temperature <= maxTemp) return 'good';
            
            // Default to critical for anything else
            return 'critical';
        }
        
        function getStatusIcon(status) {
            const icons = {
                good: `<div class="status-icon-glow-good"><svg class="h-8 w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m8 12 3 3 6-6"/>
                </svg></div>`,
                warning: `<div class="status-icon-glow-warning"><svg class="h-8 w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                    <path d="M12 8v6"/>
                    <circle cx="12" cy="17" r="1" fill="currentColor"/>
                </svg></div>`,
                critical: `<div class="status-icon-glow-critical"><svg class="h-8 w-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="m16 8-8 8"/>
                    <path d="m8 8 8 8"/>
                </svg></div>`,
                unknown: `<div class="status-icon-glow-unknown"><svg class="h-8 w-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.5 8.5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5c0 1-0.5 1.5-1.5 2l-1 1v1"/>
                    <circle cx="12" cy="17" r="1" fill="currentColor"/>
                </svg></div>`
            };
            return icons[status] || icons.unknown;
        }
        
        function getStatusColor(status) {
            const colors = {
                good: 'rgb(34, 197, 94)',
                warning: 'rgb(251, 191, 36)',
                critical: 'rgb(239, 68, 68)',
                unknown: 'rgb(156, 163, 175)'
            };
            return colors[status] || 'rgb(156, 163, 175)';
        }
        
        function getStatusGlowClass(status) {
            const classes = {
                good: 'status-glow-good',
                warning: 'status-glow-warning', 
                critical: 'status-glow-critical',
                unknown: 'status-glow-unknown'
            };
            return classes[status] || 'status-glow-unknown';
        }
        
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours > 0) return `${diffHours}h ago`;
            if (diffMins > 0) return `${diffMins}m ago`;
            return 'Just now';
        }
        
        function updateTemperatureStats(storeId) {
            const storeEquipment = equipment.filter(eq => eq.store_id === storeId);
            let inRange = 0, alerts = 0;
            
            storeEquipment.forEach(eq => {
                const lastLog = getLastTemperature(eq.id);
                const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
                
                if (status === 'good') inRange++;
                if (status === 'critical' || status === 'warning') alerts++;
            });
            
            document.getElementById('in-range-count').textContent = inRange;
            document.getElementById('alert-count').textContent = alerts;
        }
        
        // Bulk mode functions
        function toggleBulkMode() {
            bulkModeActive = !bulkModeActive;
            const btn = document.getElementById('bulk-mode-btn');
            const bulkActions = document.getElementById('bulk-actions');
            
            if (bulkModeActive) {
                btn.textContent = '✅ Exit Bulk';
                btn.className = 'px-6 py-3 glow-button text-white rounded-lg font-semibold';
                bulkActions.classList.remove('hidden');
            } else {
                btn.textContent = '📝 Bulk Mode';
                btn.className = 'px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium';
                bulkActions.classList.add('hidden');
                bulkTemperatures = {};
            }
            
            // Re-render temperature list
            if (selectedStore) {
                loadTemperatureData(selectedStore.id);
            }
        }
        
        function updateBulkTemperature(equipmentId, temperature) {
            if (temperature && !isNaN(temperature)) {
                bulkTemperatures[equipmentId] = parseFloat(temperature);
            } else {
                delete bulkTemperatures[equipmentId];
            }
        }
        
        function handleBulkTemperatureKeypress(event, currentEquipmentId) {
            // Handle Enter key (keyCode 13) or Go button on mobile
            if (event.key === 'Enter' || event.keyCode === 13) {
                event.preventDefault();
                
                // Update the current temperature value
                const currentInput = document.getElementById(`temp-${currentEquipmentId}`);
                if (currentInput && currentInput.value) {
                    updateBulkTemperature(currentEquipmentId, currentInput.value);
                    updateTemperatureVisualFeedback(currentEquipmentId, currentInput.value);
                }
                
                // Find all temperature inputs in order
                const allInputs = Array.from(document.querySelectorAll('[id^="temp-"]'));
                const currentIndex = allInputs.findIndex(input => input.id === `temp-${currentEquipmentId}`);
                
                // Move to next input if available
                if (currentIndex >= 0 && currentIndex < allInputs.length - 1) {
                    const nextInput = allInputs[currentIndex + 1];
                    nextInput.focus();
                    nextInput.select(); // Select all text for easy replacement
                } else {
                    // If at last input, blur to trigger mobile keyboard hide
                    currentInput.blur();
                    showNotification('💾 Ready to save temperatures!', 'success');
                }
            }
        }
        
        function updateTemperatureVisualFeedback(equipmentId, temperature) {
            if (!temperature || isNaN(temperature)) return;
            
            // Find the equipment data
            const eq = equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            // Calculate the status
            const temp = parseFloat(temperature);
            const status = getTemperatureStatus(temp, eq.min_temp, eq.max_temp);
            const statusIcon = getStatusIcon(status);
            const glowClass = getStatusGlowClass(status);
            
            // Find the equipment card in the DOM
            const equipmentCards = document.querySelectorAll('#temperature-list .glass');
            for (const card of equipmentCards) {
                const input = card.querySelector(`#temp-${equipmentId}`);
                if (input) {
                    // Update the status icon
                    const statusIconElement = card.querySelector('.text-3xl');
                    if (statusIconElement) {
                        statusIconElement.textContent = statusIcon;
                    }
                    
                    // Update the glow class
                    // First remove all existing status glow classes
                    card.classList.remove('status-glow-good', 'status-glow-warning', 'status-glow-critical', 'status-glow-unknown');
                    // Add the new glow class
                    card.classList.add(glowClass);
                    
                    break;
                }
            }
        }
        
        async function saveBulkTemperatures() {
            const entries = Object.keys(bulkTemperatures);
            if (entries.length === 0) {
                showNotification('No temperatures entered!', 'warning');
                return;
            }
            
            console.log('🔄 Saving bulk temperatures:', entries.length, 'entries');
            let successCount = 0;
            
            // Save each temperature to Supabase
            for (const equipmentId of entries) {
                const temperature = bulkTemperatures[equipmentId];
                
                try {
                    const tempLogData = {
                        equipment_id: equipmentId,
                        store_id: selectedStore.id,
                        temperature: temperature,
                        logged_at: new Date().toISOString(),
                        logged_by_user_id: currentUser?.id
                    };
                    
                    console.log('💾 Saving temperature log to Supabase:', tempLogData);
                    
                    const { data, error } = await supabase
                        .from('temperature_logs')
                        .insert(tempLogData)
                        .select();
                    
                    if (error) {
                        console.error('Error saving temperature log:', error);
                        showNotification(`Error saving temperature: ${error.message}`, 'error');
                    } else {
                        console.log('✅ Temperature log saved successfully:', data);
                        successCount++;
                        
                        // Add to local array for immediate display
                        if (data && data[0]) {
                            temperatureLogs.push(data[0]);
                        }
                    }
                } catch (error) {
                    console.error('Error in bulk temperature save:', error);
                    showNotification(`Error saving temperature: ${error.message}`, 'error');
                }
            }
            
            // Clear bulk data and exit bulk mode
            bulkTemperatures = {};
            toggleBulkMode();
            
            // Refresh display
            await loadTemperatureData(selectedStore.id);
            
            if (successCount === entries.length) {
                showNotification(`✅ Saved ${successCount} temperature readings to Supabase! 🌡️`, 'success');
            } else {
                showNotification(`⚠️ Saved ${successCount} of ${entries.length} temperatures`, 'warning');
            }
        }
        
        function clearBulkTemperatures() {
            bulkTemperatures = {};
            // Clear all input fields
            const inputs = document.querySelectorAll('[id^="temp-"]');
            inputs.forEach(input => input.value = '');
            showNotification('Bulk temperatures cleared', 'warning');
        }
        
        function openTemperatureModal(equipmentId) {
            const eq = equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            const lastLog = getLastTemperature(equipmentId);
            const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
            const statusIcon = getStatusIcon(status);
            const statusColor = getStatusColor(status);
            
            // Create temperature modal HTML
            const tempModal = document.createElement('div');
            tempModal.id = 'temp-log-modal';
            tempModal.className = 'fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4';
            tempModal.style.zIndex = '999999';
            
            tempModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div class="p-3 rounded-full mx-auto mb-4 w-16 h-16 flex items-center justify-center" style="background: linear-gradient(135deg, ${getEquipmentColor(eq.type)});">
                                ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-full object-cover">` : getEquipmentIcon(eq.type)}
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">🌡️ Log Temperature</h3>
                            <p class="text-lg font-semibold text-gray-800">${eq.name}</p>
                            <p class="text-sm text-gray-600">${eq.location || 'No location set'}</p>
                        </div>
                        
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">TARGET RANGE</p>
                                    <p class="text-lg font-bold" style="color: rgb(58, 109, 55);">${eq.min_temp}°F - ${eq.max_temp}°F</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">LAST READING</p>
                                    <div class="flex items-center justify-center space-x-2">
                                        <span class="text-lg font-bold" style="color: ${statusColor};">
                                            ${lastLog ? lastLog.temperature + '°F' : 'None'}
                                        </span>
                                        <span class="text-xl">${statusIcon}</span>
                                    </div>
                                    ${lastLog ? `<p class="text-xs text-gray-400 mt-1">${formatTimeAgo(lastLog.logged_at)}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <form onsubmit="saveTemperatureLog(event, '${equipmentId}')" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3 text-center">Enter Current Temperature</label>
                                <div class="relative">
                                    <input type="number" 
                                           id="temp-input" 
                                           step="0.1" 
                                           required 
                                           autofocus
                                           class="w-full px-6 py-4 text-3xl font-bold text-center border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                                           placeholder="0.0">
                                    <span class="absolute right-6 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">°F</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 glow-button text-white py-4 px-6 rounded-2xl font-bold text-lg">
                                    💾 Save Temperature
                                </button>
                                <button type="button" onclick="closeTempLogModal()" class="px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-colors font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tempModal);
            document.body.classList.add('modal-open');
            
            // Focus on input after a brief delay
            setTimeout(() => {
                const input = document.getElementById('temp-input');
                if (input) input.focus();
            }, 100);
        }
        
        window.closeTempLogModal = function() {
            const modal = document.getElementById('temp-log-modal');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        }
        
        window.saveTemperatureLog = async function(event, equipmentId) {
            event.preventDefault();
            
            const temperature = parseFloat(document.getElementById('temp-input').value);
            const eq = equipment.find(e => e.id === equipmentId);
            
            if (isNaN(temperature)) {
                showNotification('Please enter a valid temperature', 'error');
                return;
            }
            
            // Validation: reasonable temperature range
            if (temperature < -50 || temperature > 200) {
                if (!confirm(`Temperature ${temperature}°F seems unusual. Are you sure this is correct?`)) {
                    return;
                }
            }

            try {
                updateStatus('Logging temperature...');

                const tempLogData = {
                    equipment_id: equipmentId,
                    store_id: selectedStore.id,
                    temperature: temperature,
                    logged_at: new Date().toISOString(),
                    logged_by_user_id: currentUser?.id
                };

                // Save to Supabase
                console.log('Attempting to save temperature log:', tempLogData);
                
                const { data, error } = await supabase
                    .from('temperature_logs')
                    .insert(tempLogData)
                    .select()
                    .single();

                if (error) {
                    console.error('Supabase temperature_logs insert error:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    throw error;
                }

                // Add to local temperatureLogs array
                temperatureLogs.push(data);
                
                // Reload temperature data
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('✅ Temperature logged successfully');
                showNotification(`Temperature ${temperature}°F logged successfully! 🌡️`, 'success');
                closeTempLogModal();

            } catch (error) {
                console.error('Error logging temperature:', error);
                updateStatus('❌ Error logging temperature: ' + error.message);
                showNotification('Error logging temperature: ' + error.message, 'error');
            }
        }
        
        function openTemperatureHistory() {
            if (!selectedStore) return;
            
            // Create temperature history modal
            const historyModal = document.createElement('div');
            historyModal.id = 'temp-history-modal';
            historyModal.className = 'fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4';
            historyModal.style.zIndex = '999999';
            
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            historyModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-6xl w-full h-[90vh] border border-white/40 floating flex flex-col">
                    <!-- Header - Compact on mobile -->
                    <div class="p-3 md:p-6 flex-shrink-0 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2 md:mb-4">
                            <div>
                                <h3 class="text-xl md:text-3xl font-bold text-gray-900 mb-1 md:mb-2">📊 Temp Reports</h3>
                                <p class="text-sm md:text-lg font-medium text-gray-600">${selectedStore.name}</p>
                            </div>
                            <button onclick="closeTempHistoryModal()" class="p-2 md:p-3 hover:bg-gray-100 rounded-xl transition-colors">
                                <svg class="h-5 w-5 md:h-6 md:w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Tab Navigation - Smaller on mobile -->
                        <div class="flex space-x-1 md:space-x-2">
                            <button onclick="switchTempTab('summary')" id="summary-tab" class="flex-1 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-colors glow-button text-white text-sm md:text-base">
                                <span class="md:hidden">📈 Summary</span>
                                <span class="hidden md:inline">📈 Summary & Charts</span>
                            </button>
                            <button onclick="switchTempTab('details')" id="details-tab" class="flex-1 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100 text-sm md:text-base">
                                <span class="md:hidden">📝 Details</span>
                                <span class="hidden md:inline">📝 Log Details</span>
                            </button>
                        </div>
                    </div>
                        
                    <!-- Date Range Selector (Shared) -->
                    <div class="p-4 md:p-6 flex-shrink-0 bg-gray-50 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div class="flex flex-col md:flex-row md:items-center gap-3 md:space-x-4">
                                <div class="flex-1 min-w-0">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                                    <input type="date" id="from-date" value="${weekAgo.toISOString().split('T')[0]}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                                    <input type="date" id="to-date" value="${today.toISOString().split('T')[0]}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="md:pt-6">
                                    <button onclick="refreshTempHistory()" class="glow-button text-white px-4 py-2 rounded-lg font-semibold w-full md:w-auto">
                                        <span class="md:hidden">🔄</span>
                                        <span class="hidden md:inline">🔄 Refresh</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-row gap-2 md:pt-6">
                                <button onclick="exportTempHistory('pdf')" class="flex-1 md:flex-none px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-sm">
                                    <span class="md:hidden">📄</span>
                                    <span class="hidden md:inline">📄 Export PDF</span>
                                </button>
                                <button onclick="exportTempHistory('excel')" class="flex-1 md:flex-none px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                                    <span class="md:hidden">📈</span>
                                    <span class="hidden md:inline">📈 Export Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content Container -->
                    <div class="flex-1 overflow-hidden">
                        
                        <!-- Summary Tab Content -->
                        <div id="summary-content" class="flex-1 overflow-y-auto">
                            <div class="p-4 md:p-6">
                                <!-- Temperature Chart - Scrollable on mobile -->
                                <div class="mb-3">
                                    <div class="bg-white rounded-xl p-3 md:p-6 border border-gray-200 shadow-sm">
                                        <h4 class="text-base md:text-xl font-bold text-gray-900 mb-2 md:mb-4">📈 Temperature Trends</h4>
                                        <div id="temperature-chart" class="max-h-36 md:h-56 overflow-y-auto flex items-start justify-center text-gray-500">
                                            <div class="text-center w-full">
                                                <svg class="h-8 w-8 md:h-16 md:w-16 mx-auto mb-2 md:mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                                <p class="text-xs md:text-base">Temperature chart will be displayed here</p>
                                                <p class="text-xs mt-1">Select date range and click Refresh</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Statistics - Mobile optimized -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                    <div class="bg-green-50 p-3 md:p-4 rounded-xl border border-green-200">
                                        <div class="text-center">
                                            <div class="mb-1 md:mb-2 flex justify-center">
                                                <div class="status-icon-glow-good"><svg class="h-6 w-6 md:h-8 md:w-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="m8 12 3 3 6-6"/>
                                                </svg></div>
                                            </div>
                                            <div class="text-xl md:text-2xl font-bold text-green-600" id="summary-good">--</div>
                                            <div class="text-xs md:text-sm text-green-700 font-medium">In Range</div>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 md:p-4 rounded-xl border border-yellow-200">
                                        <div class="text-center">
                                            <div class="mb-1 md:mb-2 flex justify-center">
                                                <div class="status-icon-glow-warning"><svg class="h-6 w-6 md:h-8 md:w-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                                    <path d="M12 8v6"/>
                                                    <circle cx="12" cy="17" r="1" fill="currentColor"/>
                                                </svg></div>
                                            </div>
                                            <div class="text-xl md:text-2xl font-bold text-yellow-600" id="summary-warning">--</div>
                                            <div class="text-xs md:text-sm text-yellow-700 font-medium">Warnings</div>
                                        </div>
                                    </div>
                                    <div class="bg-red-50 p-3 md:p-4 rounded-xl border border-red-200">
                                        <div class="text-center">
                                            <div class="mb-1 md:mb-2 flex justify-center">
                                                <div class="status-icon-glow-critical"><svg class="h-6 w-6 md:h-8 md:w-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <circle cx="12" cy="12" r="10"/>
                                                    <path d="m16 8-8 8"/>
                                                    <path d="m8 8 8 8"/>
                                                </svg></div>
                                            </div>
                                            <div class="text-xl md:text-2xl font-bold text-red-600" id="summary-critical">--</div>
                                            <div class="text-xs md:text-sm text-red-700 font-medium">Critical</div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-200">
                                        <div class="text-center">
                                            <div class="mb-1 md:mb-2 flex justify-center">
                                                <svg class="h-6 w-6 md:h-8 md:w-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                                                    <path d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z"/>
                                                </svg>
                                            </div>
                                            <div class="text-xl md:text-2xl font-bold text-blue-600" id="summary-total">--</div>
                                            <div class="text-xs md:text-sm text-blue-700 font-medium">Total Logs</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Details Tab Content -->
                        <div id="details-content" class="hidden flex-1 flex flex-col min-h-0">
                            <div class="p-3 md:p-4 border-b border-gray-200 flex-shrink-0 bg-white">
                                <h4 class="text-lg md:text-xl font-bold text-gray-900">📝 Temperature Log Details</h4>
                                <p class="text-sm text-gray-600 mt-1">Complete list of all temperature readings</p>
                            </div>
                            <div id="temp-log-table" class="flex-1 bg-white overflow-auto" style="max-height: calc(90vh - 160px); min-height: 300px;">
                                <div class="text-center text-gray-500 py-8 md:py-12">
                                    <svg class="h-12 w-12 md:h-16 md:w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p class="text-base md:text-lg font-medium">Select date range and click Refresh</p>
                                    <p class="text-sm mt-2">Temperature log details will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            document.body.appendChild(historyModal);
            document.body.classList.add('modal-open');
            
            // Auto-load data for initial date range
            setTimeout(() => refreshTempHistory(), 100);
        }
        
        let currentTempTab = 'summary';
        
        window.switchTempTab = function(tab) {
            currentTempTab = tab;
            
            // Hide all tab contents
            document.getElementById('summary-content').classList.toggle('hidden', tab !== 'summary');
            document.getElementById('details-content').classList.toggle('hidden', tab !== 'details');
            
            // Update tab styles
            const summaryTab = document.getElementById('summary-tab');
            const detailsTab = document.getElementById('details-tab');
            
            if (tab === 'summary') {
                summaryTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors glow-button text-white';
                detailsTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100';
            } else {
                summaryTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100';
                detailsTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors glow-button text-white';
            }
        }
        
        window.closeTempHistoryModal = function() {
            const modal = document.getElementById('temp-history-modal');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        }
        
        window.refreshTempHistory = async function() {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select both from and to dates', 'warning');
                return;
            }
            
            try {
                updateStatus('Loading temperature history...');
                
                const from = new Date(fromDate);
                const to = new Date(toDate + 'T23:59:59');
                
                // Load fresh data from Supabase for the date range
                const filteredLogs = await loadTemperatureLogsFromDB(
                    selectedStore.id, 
                    from.toISOString(), 
                    to.toISOString()
                );
                
                // Update summary statistics
                updateTempSummaryStats(filteredLogs);
                
                // Update table
                updateTempLogTable(filteredLogs);
                
                // Update chart (simplified text-based for now)
                updateTempChart(filteredLogs);
                
                updateStatus('✅ Temperature history refreshed');
                showNotification('Temperature history updated!', 'success');
            } catch (error) {
                console.error('Error refreshing temperature history:', error);
                updateStatus('❌ Error refreshing temperature history');
                showNotification('Error loading temperature history', 'error');
            }
        }
        
        function updateTempSummaryStats(logs) {
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    if (status === 'good') good++;
                    else if (status === 'warning') warning++;
                    else if (status === 'critical') critical++;
                }
            });
            
            document.getElementById('summary-good').textContent = good;
            document.getElementById('summary-warning').textContent = warning;
            document.getElementById('summary-critical').textContent = critical;
            document.getElementById('summary-total').textContent = logs.length;
        }
        
        function updateTempLogTable(logs) {
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            const container = document.getElementById('temp-log-table');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="text-center text-gray-500 py-12">
                            <svg class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="text-lg font-medium">No temperature logs found</p>
                            <p class="text-sm mt-2">Try selecting a different date range</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <div style="overflow: auto; width: 100%; height: 100%; padding-bottom: 40px;">
                    <table class="w-full" style="min-width: 800px; margin-bottom: 24px;">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 200px;">Equipment</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 100px;">Temperature</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 120px;">Status</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 180px;">Date & Time</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 120px;">Logged By</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
            `;
            
            logs.forEach((log, index) => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    const statusIcon = getStatusIcon(status);
                    const statusColor = getStatusColor(status);
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    const isLastRow = index === logs.length - 1;
                    
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div>
                                    <div class="font-semibold text-gray-900 text-sm md:text-base">${eq.name}</div>
                                    <div class="text-xs text-gray-500">Range: ${eq.min_temp}°F - ${eq.max_temp}°F</div>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <span class="text-base md:text-lg font-bold">${log.temperature}°F</span>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="flex items-center space-x-1 md:space-x-2">
                                    <span class="text-lg md:text-xl">${statusIcon}</span>
                                    <span class="font-medium text-xs md:text-sm" style="color: ${statusColor};">${statusText}</span>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="text-xs md:text-sm">
                                    <div class="font-medium">${new Date(log.logged_at).toLocaleDateString()}</div>
                                    <div class="text-gray-600">${new Date(log.logged_at).toLocaleTimeString()}</div>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-600 ${isLastRow ? 'pb-8' : ''}">${log.user_profiles?.full_name || 'Unknown User'}</td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="flex space-x-1">
                                    <button onclick="editTemperatureLog('${log.id}')" class="p-2 hover:bg-transparent rounded-lg transition-colors" title="Edit Temperature">
                                        <svg class="h-4 w-4 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="deleteTemperatureLog('${log.id}')" class="p-2 hover:bg-transparent rounded-lg transition-colors" title="Delete Temperature">
                                        <svg class="h-4 w-4 text-red-500 hover:text-red-700 dark:hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        function updateTempChart(logs) {
            const container = document.getElementById('temperature-chart');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        <svg class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>No data available for chart</p>
                    </div>
                `;
                return;
            }
            
            // Simple text-based chart summary
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let chartData = {};
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    if (!chartData[eq.name]) {
                        chartData[eq.name] = { temps: [], dates: [], status: [] };
                    }
                    chartData[eq.name].temps.push(log.temperature);
                    chartData[eq.name].dates.push(new Date(log.logged_at));
                    chartData[eq.name].status.push(getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp));
                }
            });
            
            let chartHtml = '<div class="space-y-4">';
            
            Object.entries(chartData).forEach(([equipmentName, data]) => {
                const avgTemp = (data.temps.reduce((a, b) => a + b, 0) / data.temps.length).toFixed(1);
                const minTemp = Math.min(...data.temps);
                const maxTemp = Math.max(...data.temps);
                const goodCount = data.status.filter(s => s === 'good').length;
                const warningCount = data.status.filter(s => s === 'warning').length;
                const criticalCount = data.status.filter(s => s === 'critical').length;
                
                chartHtml += `
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h5 class="font-bold text-gray-900 mb-2">${equipmentName}</h5>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-blue-600">${avgTemp}°F</div>
                                <div class="text-gray-500">Average</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-gray-600">${minTemp}°F - ${maxTemp}°F</div>
                                <div class="text-gray-500">Range</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-green-600">${goodCount}</div>
                                <div class="text-gray-500">Good</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-yellow-600">${warningCount}</div>
                                <div class="text-gray-500">Warning</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-red-600">${criticalCount}</div>
                                <div class="text-gray-500">Critical</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            chartHtml += '</div>';
            container.innerHTML = chartHtml;
        }
        
        window.exportTempHistory = async function(format) {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select date range first', 'warning');
                return;
            }
            
            try {
                showNotification(`Generating ${format.toUpperCase()} export...`, 'success');
                
                // Load user profiles for export (needed for "Logged By" column)
                await loadUserProfiles();
                
                // Load data for export
                const from = new Date(fromDate);
                const to = new Date(toDate + 'T23:59:59');
                const logs = await loadTemperatureLogsFromDB(
                    selectedStore.id, 
                    from.toISOString(), 
                    to.toISOString()
                );
                
                if (logs.length === 0) {
                    showNotification('No data to export for selected date range', 'warning');
                    return;
                }
                
                // Call appropriate export function
                if (format === 'pdf') {
                    await exportToPDF(logs, fromDate, toDate);
                } else if (format === 'excel') {
                    await exportToExcel(logs, fromDate, toDate);
                }
                
                showNotification(`${format.toUpperCase()} export completed successfully!`, 'success');
            } catch (error) {
                console.error(`Error exporting ${format}:`, error);
                showNotification(`Error generating ${format.toUpperCase()} export`, 'error');
            }
        }
        
        async function exportToPDF(logs, fromDate, toDate) {
            console.log('📄 Starting PDF export...', { logsCount: logs.length, fromDate, toDate });
            
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(20);
            doc.text('Temperature Report', 14, 22);
            
            doc.setFontSize(12);
            doc.text(`Store: ${selectedStore.name}`, 14, 32);
            doc.text(`Date Range: ${fromDate} to ${toDate}`, 14, 40);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 48);
            
            // Calculate statistics
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    if (status === 'good') good++;
                    else if (status === 'warning') warning++;
                    else if (status === 'critical') critical++;
                }
            });
            
            // Add summary statistics
            doc.setFontSize(14);
            doc.text('Summary Statistics', 14, 62);
            doc.setFontSize(11);
            doc.text(`Total Logs: ${logs.length}`, 14, 72);
            doc.text(`Good: ${good}`, 14, 80);
            doc.text(`Warning: ${warning}`, 14, 88);
            doc.text(`Critical: ${critical}`, 14, 96);
            
            // Prepare table data
            const tableData = logs.map(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                const logDate = new Date(log.logged_at);
                const user = userProfiles.find(u => u.id === log.logged_by_user_id);
                const status = eq ? getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp) : 'unknown';
                const statusText = status === 'good' ? 'Good' : status === 'warning' ? 'Warning' : status === 'critical' ? 'Critical' : 'Unknown';
                
                return [
                    logDate.toLocaleDateString(),
                    logDate.toLocaleTimeString(),
                    eq ? eq.name : 'Unknown',
                    `${log.temperature}°F`,
                    statusText,
                    user ? user.full_name : 'Unknown'
                ];
            });
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Time', 'Equipment', 'Temperature', 'Status', 'Logged By']],
                body: tableData,
                startY: 106,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [58, 109, 55] },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            
            // Save the PDF
            const filename = `Temperature_Report_${selectedStore.name}_${fromDate}_to_${toDate}.pdf`.replace(/\s+/g, '_');
            doc.save(filename);
        }
        
        async function exportToExcel(logs, fromDate, toDate) {
            console.log('📈 Starting Excel export...', { logsCount: logs.length, fromDate, toDate });
            
            if (!window.XLSX) {
                throw new Error('XLSX library not loaded');
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Calculate statistics
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            const enrichedLogs = logs.map(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                const user = userProfiles.find(u => u.id === log.logged_by_user_id);
                const status = eq ? getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp) : 'unknown';
                
                if (status === 'good') good++;
                else if (status === 'warning') warning++;
                else if (status === 'critical') critical++;
                
                return {
                    'Date': new Date(log.logged_at).toLocaleDateString(),
                    'Time': new Date(log.logged_at).toLocaleTimeString(),
                    'Equipment': eq ? eq.name : 'Unknown',
                    'Type': eq ? eq.type : 'Unknown',
                    'Location': eq ? eq.location : 'Unknown',
                    'Temperature': log.temperature,
                    'Min Temp': eq ? eq.min_temp : '',
                    'Max Temp': eq ? eq.max_temp : '',
                    'Status': status.charAt(0).toUpperCase() + status.slice(1),
                    'Logged By': user ? user.full_name : 'Unknown'
                };
            });
            
            // Create summary sheet
            const summaryData = [
                ['Temperature Report Summary'],
                [],
                ['Store:', selectedStore.name],
                ['Date Range:', `${fromDate} to ${toDate}`],
                ['Generated:', new Date().toLocaleString()],
                [],
                ['Statistics'],
                ['Total Logs:', logs.length],
                ['Good:', good],
                ['Warning:', warning],
                ['Critical:', critical],
                [],
                ['Percentage Breakdown'],
                ['Good %:', logs.length > 0 ? ((good/logs.length)*100).toFixed(1) + '%' : '0%'],
                ['Warning %:', logs.length > 0 ? ((warning/logs.length)*100).toFixed(1) + '%' : '0%'],
                ['Critical %:', logs.length > 0 ? ((critical/logs.length)*100).toFixed(1) + '%' : '0%']
            ];
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Summary');
            
            // Create data sheet
            const ws_data = XLSX.utils.json_to_sheet(enrichedLogs);
            
            // Set column widths
            const colWidths = [
                {wch: 12}, // Date
                {wch: 10}, // Time
                {wch: 20}, // Equipment
                {wch: 12}, // Type
                {wch: 15}, // Location
                {wch: 12}, // Temperature
                {wch: 10}, // Min Temp
                {wch: 10}, // Max Temp
                {wch: 10}, // Status
                {wch: 20}  // Logged By
            ];
            ws_data['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws_data, 'Temperature Logs');
            
            // Save the Excel file
            const filename = `Temperature_Report_${selectedStore.name}_${fromDate}_to_${toDate}.xlsx`.replace(/\s+/g, '_');
            XLSX.writeFile(wb, filename);
        }

        // Store drag-and-drop variables
        let draggedStoreElement = null;
        let draggedStoreIndex = -1;

        // Store drag-and-drop handlers
        window.handleStoreDragStart = function(event) {
            draggedStoreElement = event.target;
            draggedStoreIndex = parseInt(event.target.dataset.index);
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        };

        window.handleStoreDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropTarget = event.target.closest('.store-item');
            if (dropTarget && dropTarget !== draggedStoreElement) {
                // Add visual indicator
                dropTarget.style.borderTop = '3px solid rgb(58, 109, 55)';
            }
        };

        window.handleStoreDrop = function(event) {
            event.preventDefault();
            
            const dropTarget = event.target.closest('.store-item');
            if (dropTarget && dropTarget !== draggedStoreElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                
                // Reorder stores array
                const draggedStore = stores[draggedStoreIndex];
                stores.splice(draggedStoreIndex, 1);
                stores.splice(dropIndex, 0, draggedStore);
                
                // Update display_order values
                stores.forEach((store, index) => {
                    store.display_order = index;
                });
                
                // Save new order to database
                saveStoreOrder();
                
                // Re-render dropdown
                renderStoreDropdown();
            }
            
            // Clean up visual indicators
            document.querySelectorAll('.store-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        window.handleStoreDragEnd = function(event) {
            event.target.style.opacity = '';
            draggedStoreElement = null;
            draggedStoreIndex = -1;
            
            // Clean up visual indicators
            document.querySelectorAll('.store-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        // Store modal drag-and-drop handlers
        let draggedStoreModalElement = null;
        let draggedStoreModalIndex = -1;

        window.handleStoreModalDragStart = function(event) {
            draggedStoreModalElement = event.target;
            draggedStoreModalIndex = parseInt(event.target.dataset.index);
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        };

        window.handleStoreModalDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropTarget = event.target.closest('.store-modal-item');
            if (dropTarget && dropTarget !== draggedStoreModalElement) {
                dropTarget.style.borderTop = '3px solid rgb(58, 109, 55)';
            }
        };

        window.handleStoreModalDrop = async function(event) {
            event.preventDefault();
            
            const dropTarget = event.target.closest('.store-modal-item');
            if (dropTarget && dropTarget !== draggedStoreModalElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                
                if (draggedStoreModalIndex !== dropIndex) {
                    try {
                        const draggedStore = stores[draggedStoreModalIndex];
                        const droppedStore = stores[dropIndex];
                        
                        const tempOrder = draggedStore.display_order;
                        draggedStore.display_order = droppedStore.display_order;
                        droppedStore.display_order = tempOrder;
                        
                        await Promise.all([
                            supabase.from('stores').update({ display_order: draggedStore.display_order }).eq('id', draggedStore.id),
                            supabase.from('stores').update({ display_order: droppedStore.display_order }).eq('id', droppedStore.id)
                        ]);
                        
                        stores.sort((a, b) => a.display_order - b.display_order);
                        renderStoreModalContent();
                        renderStoreDropdown();
                        
                        console.log('🔄 Store order updated in modal');
                        showNotification('Store order updated! 🔄', 'success');
                    } catch (error) {
                        console.error('Error updating store order:', error);
                        showNotification('Failed to update store order: ' + error.message, 'error');
                    }
                }
            }
            
            document.querySelectorAll('.store-modal-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        window.handleStoreModalDragEnd = function(event) {
            event.target.style.opacity = '';
            draggedStoreModalElement = null;
            draggedStoreModalIndex = -1;
            
            document.querySelectorAll('.store-modal-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        // Equipment drag-and-drop variables
        let draggedEquipmentElement = null;
        let draggedEquipmentIndex = -1;

        // Equipment drag-and-drop handlers
        window.handleEquipmentDragStart = function(event) {
            draggedEquipmentElement = event.target;
            draggedEquipmentIndex = parseInt(event.target.dataset.index);
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        };

        window.handleEquipmentDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropTarget = event.target.closest('[data-index]');
            if (dropTarget && dropTarget !== draggedEquipmentElement) {
                dropTarget.style.borderTop = '3px solid rgb(58, 109, 55)';
            }
        };

        window.handleEquipmentDrop = function(event) {
            event.preventDefault();
            
            const dropTarget = event.target.closest('[data-index]');
            if (dropTarget && dropTarget !== draggedEquipmentElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                
                // Get current equipment for the selected store
                const currentEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
                const draggedEquipment = currentEquipment[draggedEquipmentIndex];
                
                // Reorder equipment array
                currentEquipment.splice(draggedEquipmentIndex, 1);
                currentEquipment.splice(dropIndex, 0, draggedEquipment);
                
                // Update display_order values
                currentEquipment.forEach((eq, index) => {
                    eq.display_order = index;
                });
                
                // Update the main equipment array
                equipment = equipment.filter(eq => eq.store_id !== selectedStore.id).concat(currentEquipment);
                
                // Save new order to database
                saveEquipmentOrder(currentEquipment);
                
                // Re-render equipment list
                renderEquipmentList(currentEquipment);
            }
        };

        window.handleEquipmentDragEnd = function(event) {
            event.target.style.opacity = '';
            draggedEquipmentElement = null;
            draggedEquipmentIndex = -1;
            
            // Clean up visual indicators
            document.querySelectorAll('[data-index]').forEach(item => {
                item.style.borderTop = '';
            });
        };

        // Save store order to database
        async function saveStoreOrder() {
            try {
                const updates = stores.map(store => ({
                    id: store.id,
                    display_order: store.display_order
                }));
                
                for (const update of updates) {
                    const { error } = await supabase
                        .from('stores')
                        .update({ display_order: update.display_order })
                        .eq('id', update.id);
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('Error saving store order:', error);
                showNotification('❌ Error saving store order: ' + error.message, 'error');
            }
        }

        // Save equipment order to database
        async function saveEquipmentOrder(equipmentList) {
            try {
                for (const eq of equipmentList) {
                    const { error } = await supabase
                        .from('equipment')
                        .update({ display_order: eq.display_order })
                        .eq('id', eq.id);
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('Error saving equipment order:', error);
                showNotification('❌ Error saving equipment order: ' + error.message, 'error');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('store-dropdown');
            const storeSelector = event.target.closest('[onclick="toggleDropdown()"]');
            
            // If clicked outside the dropdown and not on the toggle button, close dropdown
            if (!dropdown.contains(event.target) && !storeSelector && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                }
        });

        // Close dropdown when scrolling
        document.addEventListener('scroll', function(event) {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                }
        });

        // Close user dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('user-dropdown');
            const userMenuContainer = document.getElementById('user-menu-container');
            
            // If clicked outside the dropdown and not on the toggle button, close dropdown
            if (userDropdown && !userDropdown.classList.contains('hidden') && 
                !userDropdown.contains(event.target) && !userMenuContainer.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Close user dropdown when scrolling
        document.addEventListener('scroll', function(event) {
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown && !userDropdown.classList.contains('hidden')) {
                userDropdown.classList.add('hidden');
            }
        });

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🌡️ Temp Tracker Pro v1.10.54 loaded successfully!');
            loadDarkModePreference();
            
            // Load stores first (needed for signup form)
            await initStores();
            
            // Check authentication state
            await checkAuthState();
            
            // Check for password reset token
            checkPasswordResetToken();
            
            // Add password reset form event listener
            const passwordResetForm = document.getElementById('password-reset-form');
            if (passwordResetForm) {
                passwordResetForm.addEventListener('submit', handleNewPasswordSubmit);
            }
        });

        // Temperature log edit/delete functions
        window.editTemperatureLog = async function(logId) {
            const log = temperatureLogs.find(l => l.id === logId);
            if (!log) {
                showNotification('Temperature log not found', 'error');
                return;
            }

            // Create styled edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            editModal.style.zIndex = '9999999';
            editModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-3">✏️</div>
                        <h3 class="text-xl font-bold text-gray-900">Edit Temperature</h3>
                        <p class="text-gray-600 mt-2">${log.equipment?.name || 'Equipment'}</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Temperature (°F)</label>
                        <input type="number" id="edit-temp-input" step="0.1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-semibold"
                               value="${log.temperature}" placeholder="Enter temperature">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEditModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmEditTemperature('${logId}')" 
                                class="flex-1 px-4 py-3 glow-button text-white rounded-lg font-semibold">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editModal);
            document.body.classList.add('modal-open');
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById('edit-temp-input');
                input.focus();
                input.select();
            }, 100);
        };

        window.closeEditModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmEditTemperature = async function(logId) {
            const input = document.getElementById('edit-temp-input');
            const tempValue = parseFloat(input.value);
            
            if (isNaN(tempValue)) {
                showNotification('Please enter a valid temperature', 'error');
                return;
            }

            try {
                console.log('🔄 Updating temperature log:', logId, 'to', tempValue);
                
                const { error } = await supabase
                    .from('temperature_logs')
                    .update({ temperature: tempValue })
                    .eq('id', logId);

                if (error) {
                    console.error('Error updating temperature log:', error);
                    showNotification('Error updating temperature: ' + error.message, 'error');
                    return;
                }

                console.log('✅ Temperature log updated successfully');
                showNotification('Temperature updated successfully! 🌡️', 'success');
                
                closeEditModal();
                
                // Refresh the temperature history and main temperature data
                await window.refreshTempHistory();
                if (selectedStore) {
                    await loadTemperatureData(selectedStore.id);
                }
                
            } catch (error) {
                console.error('Error updating temperature log:', error);
                showNotification('Error updating temperature: ' + error.message, 'error');
            }
        };

        window.deleteTemperatureLog = async function(logId) {
            const log = temperatureLogs.find(l => l.id === logId);
            if (!log) {
                showNotification('Temperature log not found', 'error');
                return;
            }

            const equipmentName = log.equipment?.name || 'Unknown Equipment';
            const logDate = new Date(log.logged_at).toLocaleDateString();
            const logTime = new Date(log.logged_at).toLocaleTimeString();
            
            // Create styled delete confirmation modal
            const deleteModal = document.createElement('div');
            deleteModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            deleteModal.style.zIndex = '9999999';
            deleteModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-3">🗑️</div>
                        <h3 class="text-xl font-bold text-gray-900">Delete Temperature Log?</h3>
                        <p class="text-gray-600 mt-2">This action cannot be undone</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Equipment:</span>
                            <span class="text-gray-900">${equipmentName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Temperature:</span>
                            <span class="text-gray-900 font-semibold">${log.temperature}°F</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Date:</span>
                            <span class="text-gray-900">${logDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Time:</span>
                            <span class="text-gray-900">${logTime}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeDeleteModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmDeleteTemperature('${logId}')" 
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
                            Delete Log
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            document.body.classList.add('modal-open');
        };

        window.closeDeleteModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmDeleteTemperature = async function(logId) {
            try {
                console.log('🔄 Deleting temperature log:', logId);
                
                const { error } = await supabase
                    .from('temperature_logs')
                    .delete()
                    .eq('id', logId);

                if (error) {
                    console.error('Error deleting temperature log:', error);
                    showNotification('Error deleting temperature: ' + error.message, 'error');
                    return;
                }

                console.log('✅ Temperature log deleted successfully');
                showNotification('Temperature log deleted successfully! 🗑️', 'success');
                
                closeDeleteModal();
                
                // Refresh the temperature history and main temperature data
                await window.refreshTempHistory();
                if (selectedStore) {
                    await loadTemperatureData(selectedStore.id);
                }
                
            } catch (error) {
                console.error('Error deleting temperature log:', error);
                showNotification('Error deleting temperature: ' + error.message, 'error');
            }
        };

        // Mobile navigation functions
        window.scrollToSection = function(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Update active state in bottom nav
                document.querySelectorAll('.bottom-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.bottom-nav-item').classList.add('active');
            }
        };

        window.openQuickTempModal = function() {
            if (!selectedStore) {
                showNotification('Please select a store first', 'warning');
                return;
            }

            // Check if we have equipment
            const equipmentList = document.getElementById('equipment-list');
            if (!equipmentList || equipmentList.children.length === 0) {
                showNotification('No equipment available. Add equipment first.', 'warning');
                return;
            }

            // Create quick temp modal
            const quickModal = document.createElement('div');
            quickModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            quickModal.style.zIndex = '9999999';
            quickModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="p-3 rounded-full mx-auto mb-4 w-16 h-16 flex items-center justify-center" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">Quick Temperature Log</h3>
                        <p class="text-gray-600 mt-2">Log temperature for first available equipment</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Temperature (°F)</label>
                        <div class="relative">
                            <input type="number" id="quick-temp-input" step="0.1" 
                                   class="w-full px-6 py-4 text-3xl font-bold text-center border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                                   placeholder="0.0" autofocus>
                            <span class="absolute right-6 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">°F</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeQuickTempModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="saveQuickTemp()" 
                                class="flex-1 px-4 py-3 glow-button text-white rounded-lg font-semibold">
                            Log Temperature
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(quickModal);
            document.body.classList.add('modal-open');
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById('quick-temp-input');
                input.focus();
            }, 100);
        };

        window.closeQuickTempModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.saveQuickTemp = async function() {
            if (!selectedStore || !currentUser) {
                showNotification('Authentication or store selection required', 'error');
                return;
            }

            const tempInput = document.getElementById('quick-temp-input');
            const tempValue = parseFloat(tempInput.value);
            
            if (isNaN(tempValue)) {
                showNotification('Please enter a valid temperature', 'error');
                return;
            }

            try {
                // Get first equipment item
                const equipmentCards = document.querySelectorAll('.equipment-card');
                if (equipmentCards.length === 0) {
                    showNotification('No equipment available', 'error');
                    return;
                }

                // Find the first equipment ID from the first card
                const firstCard = equipmentCards[0];
                const tempInputField = firstCard.querySelector('input[type="number"]');
                if (!tempInputField) {
                    showNotification('No temperature input found', 'error');
                    return;
                }

                const equipmentId = tempInputField.id.replace('temp-', '');
                
                // Log the temperature using existing function
                const result = await logTemperatureToDatabase(equipmentId, tempValue, selectedStore.id, currentUser.id);
                
                if (result.success) {
                    showNotification(`🌡️ Temperature logged: ${tempValue}°F`, 'success');
                    closeQuickTempModal();
                    
                    // Update the UI
                    tempInputField.value = tempValue;
                    await updateUI();
                } else {
                    showNotification('Error logging temperature: ' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('Error in saveQuickTemp:', error);
                showNotification('Error logging temperature: ' + error.message, 'error');
            }
        };

    </script>
    
    <!-- Store Selection Modal -->
    <div id="store-selection-modal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="rounded-3xl shadow-2xl max-w-md w-full border-2">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Select Store Location</h3>
                    <button onclick="closeStoreModal()" class="p-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white rounded-lg transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="store-modal-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <!-- Store items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Equipment History Modal -->
    <div id="equipment-history-modal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="rounded-3xl shadow-2xl max-w-2xl w-full border-2">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold" id="equipment-history-title">Equipment Temperature History</h3>
                    <button onclick="closeEquipmentHistoryModal()" class="p-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white rounded-lg transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="equipment-history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                    <!-- History items will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Store Dropdown Portal - Outside all stacking contexts -->
    <div id="store-dropdown" class="hidden fixed dropdown-bg rounded-2xl shadow-2xl max-h-64 overflow-y-auto" style="z-index: 999999999 !important; position: fixed !important; width: 400px;">
        <div id="store-list">
            <!-- Stores will be populated here -->
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profile-settings-modal" class="hidden fixed inset-0 flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="rounded-3xl shadow-2xl max-w-2xl w-full border-2">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Profile Settings</h3>
                    <button onclick="closeProfileModal()" class="p-2 text-gray-500 dark:text-gray-300 hover:text-gray-700 dark:hover:text-white rounded-lg transition-colors">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Profile Picture Section -->
                <div class="mb-8">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <div id="profile-avatar" class="w-20 h-20 rounded-full bg-gradient-to-br from-green-600 to-green-700 flex items-center justify-center text-white text-2xl font-bold border-4 border-white shadow-lg">
                                <!-- Initials will be populated here -->
                            </div>
                            <button onclick="openProfileCamera()" class="absolute -bottom-2 -right-2 w-8 h-8 bg-green-600 hover:bg-green-700 rounded-full flex items-center justify-center text-white shadow-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Profile Picture</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Take a photo or upload an image</p>
                            <div class="flex space-x-2 mt-2">
                                <button onclick="openProfileCamera()" class="flex items-center px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    Camera
                                </button>
                                <button onclick="document.getElementById('profile-picture-input').click()" class="flex items-center px-3 py-1.5 bg-gray-600 hover:bg-gray-700 text-white text-sm rounded-lg transition-colors">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Upload
                                </button>
                            </div>
                        </div>
                    </div>
                    <input type="file" id="profile-picture-input" accept="image/*" class="hidden" onchange="handleProfilePictureUpload(event)">
                </div>
                
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
                    <nav class="flex space-x-8">
                        <button onclick="switchProfileTab('personal')" id="tab-personal" class="profile-tab active py-2 px-1 border-b-2 border-blue-500 text-blue-600 dark:text-blue-400 font-medium">
                            Personal Info
                        </button>
                        <button onclick="switchProfileTab('preferences')" id="tab-preferences" class="profile-tab py-2 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium">
                            Preferences
                        </button>
                        <button onclick="switchProfileTab('security')" id="tab-security" class="profile-tab py-2 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium">
                            Security
                        </button>
                        <button onclick="switchProfileTab('stores')" id="tab-stores" class="profile-tab py-2 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 font-medium">
                            Store Access
                        </button>
                    </nav>
                </div>
                
                <!-- Tab Content -->
                <div id="profile-tab-content">
                    <!-- Personal Info Tab -->
                    <div id="tab-content-personal" class="profile-tab-content">
                        <div class="space-y-6">
                            <div>
                                <label for="profile-full-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Full Name</label>
                                <input type="text" id="profile-full-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label for="profile-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email Address</label>
                                <input type="email" id="profile-email" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 dark:text-gray-400 cursor-not-allowed">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Email is managed through your Supabase account</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preferences Tab -->
                    <div id="tab-content-preferences" class="profile-tab-content hidden">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Dark Mode</label>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="radio" name="dark-mode" value="system" class="mr-3">
                                        <span class="text-sm text-gray-700 dark:text-gray-300">Use system preference</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="dark-mode" value="light" class="mr-3">
                                        <span class="text-sm text-gray-700 dark:text-gray-300">Light mode</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="dark-mode" value="dark" class="mr-3">
                                        <span class="text-sm text-gray-700 dark:text-gray-300">Dark mode</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label for="profile-default-store" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Default Store</label>
                                <select id="profile-default-store" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white">
                                    <option value="">Select a default store</option>
                                </select>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="profile-email-notifications" class="mr-3 rounded">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Email notifications for critical temperatures</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div id="tab-content-security" class="profile-tab-content hidden">
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Password Management</h4>
                                <button onclick="resetPassword()" class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                                    </svg>
                                    Reset Password
                                </button>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">You'll receive an email with password reset instructions</p>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Active Sessions</h4>
                                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Session management coming soon...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Store Access Tab -->
                    <div id="tab-content-stores" class="profile-tab-content hidden">
                        <div class="space-y-6">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Current Store Access</h4>
                                <div id="profile-store-access-list" class="space-y-3">
                                    <!-- Store access items will be populated here -->
                                </div>
                            </div>
                            <div>
                                <h4 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Request Store Access</h4>
                                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4">
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Store access requests coming soon...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="closeProfileModal()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Cancel
                    </button>
                    <button onclick="saveProfileSettings()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Reset Page -->
    <div id="password-reset-page" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full" style="z-index: 9999999 !important;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white dark:bg-gray-800">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 dark:bg-green-900">
                    <svg class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mt-4">Reset Your Password</h3>
                <div class="mt-4 px-7 py-3">
                    <form id="password-reset-form" class="space-y-4">
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-left">New Password</label>
                            <input type="password" id="new-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 text-left">Confirm New Password</label>
                            <input type="password" id="confirm-password" required minlength="6" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closePasswordResetPage()" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Dropdown Portal - Outside all stacking contexts -->
    <div id="user-dropdown" class="hidden fixed w-64 bg-white rounded-lg shadow-lg border border-gray-200" style="z-index: 999999999 !important; position: fixed !important;">
        <div class="p-4 border-b border-gray-100">
            <p class="font-semibold text-gray-900" id="dropdown-user-name">User Name</p>
            <p class="text-sm text-gray-600" id="dropdown-user-email">user@email.com</p>
        </div>
        <div class="py-2">
            <button onclick="showProfile()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/50">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Profile Settings
            </button>
            <button id="admin-dropdown-item" onclick="openAdminSettings(); toggleUserMenu();" class="hidden items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/50">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Admin Settings
            </button>
            <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-sm hover:bg-red-50 dark:hover:bg-red-900/20" style="color: #dc2626 !important;">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Sign Out
            </button>
        </div>
        <div class="px-4 py-2 border-t border-gray-100">
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="bottom-nav-item" onclick="scrollToSection('temperature-logging')">
            <div class="bottom-nav-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <span class="bottom-nav-text">Temps</span>
        </div>
        
        <div class="bottom-nav-item" onclick="scrollToSection('equipment-management')">
            <div class="bottom-nav-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path>
                </svg>
            </div>
            <span class="bottom-nav-text">Equipment</span>
        </div>
        
        <div class="bottom-nav-item" onclick="openTempHistoryModal()">
            <div class="bottom-nav-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
            </div>
            <span class="bottom-nav-text">Reports</span>
        </div>
        
        <div class="bottom-nav-item" onclick="toggleUserMenu()">
            <div class="bottom-nav-icon">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
            </div>
            <span class="bottom-nav-text">Profile</span>
        </div>
    </nav>

    <!-- Floating Action Button (FAB) -->
    <button class="fab" onclick="openQuickTempModal()" title="Quick Temperature Log">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
    </button>

</body>
</html>