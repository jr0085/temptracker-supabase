<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TempTracker Pro v1.9.1 | Cristy's Pizza</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #e9ecef 0%, #ced4da 50%, #adb5bd 100%);
            background-attachment: fixed;
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        body.modal-open {
            overflow: hidden;
        }
        
        body.dark { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #404040 100%);
        }
        
        .dark .glass-strong {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }
        
        .dark .dropdown-bg {
            background: rgba(40, 40, 40, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark h1, .dark h2, .dark h3 {
            color: #f8f9fa !important;
        }
        
        /* Keep user names light in dark mode */
        .dark #dropdown-user-name,
        .dark #user-display-name {
            color: #f8f9fa !important;
        }
        
        /* Keep selected store name light in dark mode */
        .dark #selected-store-name {
            color: #f8f9fa !important;
        }
        
        /* Store selector button styling in dark mode - match temperature logging buttons */
        .dark button:has(#selected-store-name) {
            background-color: #374151 !important; /* gray-700 */
        }
        
        .dark button:has(#selected-store-name):hover {
            background-color: #4B5563 !important; /* gray-600 */
        }
        
        /* Fix dropdown button hover states in dark mode */
        .dark #user-dropdown button:hover {
            background-color: #374151 !important; /* gray-700 */
            color: #f3f4f6 !important; /* gray-100 */
        }
        
        .dark .text-gray-600 {
            color: #adb5bd !important;
        }
        
        .dark .text-gray-500 {
            color: #868e96 !important;
        }
        
        .dark .text-gray-700 {
            color: #e9ecef !important;
        }
        
        .dark input, .dark textarea, .dark select {
            background-color: #495057 !important;
            color: #f8f9fa !important;
            border-color: #6c757d !important;
        }
        
        .dark input:focus, .dark textarea:focus, .dark select:focus {
            background-color: #495057 !important;
            border-color: rgb(58, 109, 55) !important;
            box-shadow: 0 0 0 2px rgba(58, 109, 55, 0.2) !important;
        }
        
        .dark .hover\\:bg-gray-50:hover {
            background-color: #495057 !important;
        }
        
        .dark .hover\\:bg-gray-100:hover {
            background-color: #495057 !important;
        }
        
        .dark .bg-gray-50 {
            background-color: #495057 !important;
        }
        
        .dark #user-dropdown {
            background: rgba(30, 30, 30, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            z-index: 999999999 !important;
        }
        
        #user-dropdown {
            background: rgba(255, 255, 255, 0.95) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            z-index: 999999999 !important;
            position: absolute !important;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }
        
        .dropdown-bg {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .floating {
            /* Removed floating animation */
        }
        
        .card-hover { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        
        .card-hover:hover { 
            transform: translateY(-8px) scale(1.02); 
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .glow-button {
            background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));
            box-shadow: 0 4px 15px rgba(58, 109, 55, 0.4);
            transition: all 0.3s ease;
        }
        
        .glow-button:hover {
            box-shadow: 0 8px 25px rgba(58, 109, 55, 0.6);
            transform: translateY(-2px);
        }
        
        .status-glow-good {
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
            border: 2px solid rgba(34, 197, 94, 0.4);
        }
        
        .status-glow-warning {
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
            border: 2px solid rgba(251, 191, 36, 0.5);
        }
        
        .status-glow-critical {
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            border: 2px solid rgba(239, 68, 68, 0.5);
        }
        
        .status-glow-unknown {
            box-shadow: 0 0 15px rgba(156, 163, 175, 0.2);
            border: 2px solid rgba(156, 163, 175, 0.3);
        }
    </style>
    
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Excel Export Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen">
    <!-- Header -->
    <header class="glass-strong shadow-2xl border-b border-white/30 floating">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="p-3 rounded-xl shadow-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                        <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">TempTracker Pro</h1>
                        <p class="text-base text-gray-600 font-medium">Cristy's Pizza - Modern Edition</p>
                    </div>
                </div>
                <div class="flex flex-col items-end space-y-1">
                    <div class="flex items-center space-x-4">
                        <button onclick="toggleDarkMode()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Toggle Dark Mode">
                            <svg id="theme-icon" class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                        </button>
                        <div class="flex items-center space-x-4">
                            <!-- User Menu -->
                            <div class="relative" id="user-menu-container" style="display: none;">
                                <button onclick="toggleUserMenu()" class="flex items-center space-x-2 bg-transparent px-4 py-2 rounded-lg hover:bg-white/20 transition-colors">
                                    <div class="w-8 h-8 bg-gradient-to-r from-green-600 to-green-700 rounded-full flex items-center justify-center">
                                        <span class="text-white font-semibold text-sm" id="user-initials">?</span>
                                    </div>
                                    <div class="text-left hidden md:block">
                                        <p class="text-sm font-medium text-gray-900" id="user-display-name">User</p>
                                        <p class="text-xs text-gray-600" id="user-current-store">No store</p>
                                    </div>
                                    <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                
                            </div>

                            <!-- Login Button (shown when not authenticated) -->
                            <button id="login-button" onclick="openAuthModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-semibold transition-colors">
                                Sign In
                            </button>

                        </div>
                    </div>
                    
                    <!-- Version Number (positioned below user dropdown in header) -->
                    <div class="text-xs text-gray-600 dark:text-gray-400 bg-transparent pr-4">
                        Version 1.9.1
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="glass-strong rounded-2xl shadow-xl p-2">
            <div class="flex space-x-2">
                <button onclick="showSection('temperature')" id="temp-tab" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors">
                    üå°Ô∏è Temperature Log
                </button>
                <button onclick="showSection('equipment')" id="equipment-tab" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900">
                    ‚öôÔ∏è Equipment
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Store Selector & Management -->
        <div class="mb-8">
            <div class="glass-strong rounded-3xl shadow-2xl p-8 card-hover floating">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Select Store Location</h2>
                    <button onclick="openAddStoreModal()" class="glow-button text-white px-6 py-3 rounded-2xl font-semibold flex items-center space-x-2">
                        <span>‚ûï</span>
                        <span>Add Store</span>
                    </button>
                </div>
                
                <div class="relative" style="z-index: 1000;">
                    <div class="w-full glass rounded-2xl shadow-lg p-6 flex items-center justify-between card-hover border border-white/30">
                        <button onclick="toggleDropdown()" class="flex items-center space-x-4 flex-1 text-left">
                            <div class="bg-gradient-to-r from-green-600 to-green-700 p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                                <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <p class="font-bold text-gray-900 text-lg" id="selected-store-name">Loading stores...</p>
                                <p class="text-sm text-gray-600" id="selected-store-address"></p>
                            </div>
                        </button>
                        <div class="flex items-center space-x-2">
                            <button id="edit-current-store-btn" onclick="editCurrentStore(event)" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" style="display: none;" title="Edit Store">
                                <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="toggleDropdown()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Select Store">
                                <svg class="h-5 w-5 text-gray-400 transition-transform duration-200" id="dropdown-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Temperature Logging -->
        <div class="mb-8" id="temperature-section" style="display: none;">
            <div class="glass-strong rounded-3xl shadow-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                            <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Temperature Logging</h2>
                            <p class="text-sm text-gray-600" id="selected-store-temperature">Log temperatures for equipment</p>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="toggleBulkMode()" id="bulk-mode-btn" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            üìù Bulk Mode
                        </button>
                        <button onclick="openTemperatureHistory()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            üìä History
                        </button>
                    </div>
                </div>
                
                <div id="temperature-list" class="space-y-4">
                    <!-- Temperature logging will be populated here -->
                </div>
                
                <div id="bulk-actions" class="hidden mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-blue-900">üî• Bulk Temperature Entry</h3>
                        <div class="flex space-x-2">
                            <button onclick="saveBulkTemperatures()" class="glow-button text-white px-4 py-2 rounded-lg font-semibold">
                                üíæ Save All
                            </button>
                            <button onclick="clearBulkTemperatures()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                üóëÔ∏è Clear
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-blue-700 mb-4">Enter temperatures for all equipment, then save all at once</p>
                </div>
            </div>
        </div>

        <!-- Equipment Management -->
        <div class="mb-8" id="equipment-section" style="display: none;">
            <div class="glass-strong rounded-3xl shadow-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="p-2 rounded-lg" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                            <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Equipment Management</h2>
                            <p class="text-sm text-gray-600" id="selected-store-equipment">Select a store to manage equipment</p>
                        </div>
                    </div>
                    <button onclick="openEquipmentModal('add')" class="glow-button text-white px-6 py-3 rounded-2xl font-semibold flex items-center space-x-2">
                        <span>‚ûï</span>
                        <span>Add Equipment</span>
                    </button>
                </div>
                
                <div id="equipment-list" class="space-y-4">
                    <!-- Equipment will be populated here -->
                </div>
            </div>
        </div>


        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(58, 109, 55);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Stores</p>
                        <p class="text-2xl font-semibold text-gray-900" id="total-stores">0</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(76, 135, 72);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Equipment</p>
                        <p class="text-2xl font-semibold text-gray-900" id="equipment-count">--</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(34, 197, 94);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">In Range</p>
                        <p class="text-2xl font-semibold text-gray-900" id="in-range-count">--</p>
                    </div>
                </div>
            </div>
            <div class="glass-strong rounded-2xl shadow-xl p-6 card-hover floating">
                <div class="flex items-center">
                    <svg class="h-10 w-10" style="color: rgb(239, 68, 68);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L2.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Alerts</p>
                        <p class="text-2xl font-semibold text-gray-900" id="alert-count">--</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Success Status -->
        <div class="mt-8 glass-strong rounded-2xl shadow-xl p-6 border border-green-200/50">
            <h3 class="text-2xl font-bold mb-4 flex items-center" style="color: rgb(58, 109, 55);">
                <span class="p-2 rounded-lg mr-3" style="background: linear-gradient(135deg, rgb(58, 109, 55), rgb(46, 87, 44));">
                    ‚úÖ
                </span>
                Success!
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="status-list">
                <div class="flex items-center p-3 bg-green-50/80 rounded-lg">
                    <span class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: rgb(58, 109, 55);"></span>
                    <span class="font-medium">Modern glass morphism design</span>
                </div>
                <div class="flex items-center p-3 bg-green-50/80 rounded-lg">
                    <span class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: rgb(58, 109, 55);"></span>
                    <span class="font-medium">Connecting to database...</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Store Modal -->
    <div id="store-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="modal-title">Add New Store</h3>
                    <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        ‚úï
                    </button>
                </div>
                
                <form onsubmit="saveStore(event)" class="space-y-4">
                    <input type="hidden" id="store-id">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Store Name</label>
                        <input type="text" id="store-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="store-address" required rows="3"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="store-phone"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Manager</label>
                        <input type="text" id="store-manager"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                            Save Store
                        </button>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Equipment Modal -->
    <div id="equipment-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-lg w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="equipment-modal-title">Add Equipment</h3>
                    <button onclick="closeEquipmentModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        ‚úï
                    </button>
                </div>
                
                <form onsubmit="saveEquipment(event)" class="space-y-4">
                    <input type="hidden" id="equipment-id">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Name</label>
                        <input type="text" id="equipment-name" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Walk-in Freezer #1">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Type</label>
                        <select id="equipment-type" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select type...</option>
                            <option value="freezer">Freezer</option>
                            <option value="cooler">Cooler</option>
                            <option value="walk_in_freezer">Walk-in Freezer</option>
                            <option value="walk_in_cooler">Walk-in Cooler</option>
                            <option value="prep_cooler">Prep Cooler</option>
                            <option value="pizza_cooler">Pizza Cooler</option>
                            <option value="reach_in">Reach-in Unit</option>
                            <option value="hot_holding">Hot Holding</option>
                            <option value="oven">Oven</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Min Temp (¬∞F)</label>
                            <input type="number" id="equipment-min-temp" required step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="32">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Temp (¬∞F)</label>
                            <input type="number" id="equipment-max-temp" required step="0.1"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="40">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" id="equipment-location"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="e.g., Kitchen Back Wall">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Equipment Photo (Optional)</label>
                        <div class="flex space-x-2 mb-2">
                            <input type="file" id="equipment-photo" accept="image/*" capture="environment"
                                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   onchange="handlePhotoUpload(event)">
                            <button type="button" onclick="openCamera()" class="glow-button text-white px-4 py-3 rounded-lg font-semibold">
                                üì∑
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Upload a photo or use camera to capture equipment image</p>
                        <div id="photo-preview" class="mt-2 hidden">
                            <img id="preview-image" class="w-16 h-16 rounded-lg object-cover" src="" alt="Preview">
                            <button type="button" onclick="removePhoto()" class="ml-2 text-red-500 text-sm">Remove</button>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                            Save Equipment
                        </button>
                        <button type="button" onclick="closeEquipmentModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900" id="auth-modal-title">Welcome to TempTracker Pro</h3>
                    <button onclick="closeAuthModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Login Form -->
                <div id="login-form">
                    <form onsubmit="handleLogin(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="login-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="login-password" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your password">
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Sign In
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-4 text-center">
                        <button onclick="showResetForm()" class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            Forgot your password?
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <p class="text-sm text-gray-600">
                            Don't have an account? 
                            <button onclick="showSignupForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign up</button>
                        </p>
                    </div>
                </div>
                
                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <form onsubmit="handleSignup(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="signup-name" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your full name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="signup-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="signup-password" required minlength="6"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Create a password (min 6 characters)">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Store Location</label>
                            <select id="signup-store" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Select your primary store</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">You can switch between stores after signing in</p>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Create Account
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            Already have an account? 
                            <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign in</button>
                        </p>
                    </div>
                </div>
                
                <!-- Password Reset Form -->
                <div id="reset-form" class="hidden">
                    <form onsubmit="handlePasswordReset(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="reset-email" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="Enter your email address">
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-start">
                                <svg class="h-5 w-5 text-blue-600 mt-0.5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="text-sm font-medium text-blue-800">Password Reset Instructions</h3>
                                    <p class="text-sm text-blue-700 mt-1">
                                        We'll send you a secure link to reset your password. Check your email inbox and follow the instructions.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="submit" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                Send Reset Link
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            Remember your password? 
                            <button onclick="showLoginForm()" class="text-blue-600 hover:text-blue-700 font-medium">Sign in</button>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Admin Settings Modal -->
    <div id="admin-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4" style="z-index: 999999;">
        <div class="glass-strong rounded-3xl shadow-2xl max-w-2xl w-full border border-white/40 floating max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">üîß Admin Settings</h3>
                    <button onclick="closeAdminModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        ‚úï
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- Store Management Permissions -->
                    <div class="border-b pb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Store Management Permissions</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Add New Stores</p>
                                    <p class="text-sm text-gray-500">Allow creating new store locations</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_add_admin" class="mr-2" onchange="updatePermission('store_add')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_add_users" class="mr-2" onchange="updatePermission('store_add')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Edit Stores</p>
                                    <p class="text-sm text-gray-500">Allow modifying existing store details</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_edit_admin" class="mr-2" onchange="updatePermission('store_edit')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_edit_users" class="mr-2" onchange="updatePermission('store_edit')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Delete Stores</p>
                                    <p class="text-sm text-gray-500">Allow removing stores from system</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_delete_admin" class="mr-2" onchange="updatePermission('store_delete')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_delete_users" class="mr-2" onchange="updatePermission('store_delete')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Reorder Stores</p>
                                    <p class="text-sm text-gray-500">Allow drag-and-drop reordering of stores</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_reorder_admin" class="mr-2" onchange="updatePermission('store_reorder')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="store_reorder_users" class="mr-2" onchange="updatePermission('store_reorder')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equipment Management Permissions -->
                    <div class="pb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Equipment Management Permissions</h4>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Add Equipment</p>
                                    <p class="text-sm text-gray-500">Allow creating new equipment items</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_add_admin" class="mr-2" onchange="updatePermission('equipment_add')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_add_users" class="mr-2" onchange="updatePermission('equipment_add')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Edit Equipment</p>
                                    <p class="text-sm text-gray-500">Allow modifying equipment details</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_edit_admin" class="mr-2" onchange="updatePermission('equipment_edit')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_edit_users" class="mr-2" onchange="updatePermission('equipment_edit')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Delete Equipment</p>
                                    <p class="text-sm text-gray-500">Allow removing equipment from system</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_delete_admin" class="mr-2" onchange="updatePermission('equipment_delete')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_delete_users" class="mr-2" onchange="updatePermission('equipment_delete')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-700">Reorder Equipment</p>
                                    <p class="text-sm text-gray-500">Allow drag-and-drop reordering of equipment</p>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_reorder_admin" class="mr-2" onchange="updatePermission('equipment_reorder')">
                                        <span class="text-sm">Admin</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="equipment_reorder_users" class="mr-2" onchange="updatePermission('equipment_reorder')">
                                        <span class="text-sm">All Users</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Temperature Log Modal and History Modal will be inserted here dynamically -->

    <script>
        // Initialize Supabase
        const supabaseUrl = 'https://cacalfugowmeitmlwnjw.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhY2FsZnVnb3dtZWl0bWx3bmp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMjIxNTEsImV4cCI6MjA2ODg5ODE1MX0.JU72z7PFNcRe1Old3OqYT24BH2q_zpoY0OkpQoLMmyY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Data arrays - will be populated from Supabase
        let stores = [];
        let equipment = [];
        let temperatureLogs = [];
        let userProfiles = [];
        
        let selectedStore = null;
        let currentEquipmentPhoto = null;
        let currentUser = null;
        let userProfile = null;

        // Authentication Functions
        async function checkAuthState() {
            try {
                // Check for password reset in URL
                const urlParams = new URLSearchParams(window.location.search);
                const accessToken = urlParams.get('access_token');
                const refreshToken = urlParams.get('refresh_token');
                const type = urlParams.get('type');
                
                if (type === 'recovery' && accessToken && refreshToken) {
                    console.log('üîÑ Processing password reset...');
                    await handlePasswordResetCallback(accessToken, refreshToken);
                    return;
                }
                
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session?.user) {
                    currentUser = session.user;
                    await loadUserProfile();
                    await loadUserPermissions();
                    updateAuthUI(true);
                    await loadDefaultStore();
                } else {
                    updateAuthUI(false);
                    openAuthModal();
                }
            } catch (error) {
                console.error('Error checking auth state:', error);
                updateAuthUI(false);
                openAuthModal();
            }
        }

        async function loadUserProfile() {
            try {
                console.log('üîÑ Loading user profile for:', currentUser?.email);
                
                if (!currentUser) {
                    console.log('‚ùå No current user to load profile for');
                    return;
                }

                // First try to get the profile
                const { data: profileData, error: profileError } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError) {
                    console.log('Profile not found, creating new profile...');
                    // If profile doesn't exist, create it
                    const { data: newProfile, error: createError } = await supabase
                        .from('user_profiles')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                            active: true
                        })
                        .select()
                        .single();
                    
                    if (createError) {
                        console.error('Error creating profile:', createError);
                        // Continue with basic user data even if profile creation fails
                        userProfile = {
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User',
                            active: true
                        };
                    } else {
                        userProfile = newProfile;
                        console.log('‚úÖ Profile created:', userProfile);
                    }
                } else {
                    userProfile = profileData;
                    console.log('‚úÖ Profile loaded:', userProfile);
                }
                
                // If user has a default store, load it
                if (userProfile?.default_store_id) {
                    console.log('Loading default store:', userProfile.default_store_id);
                    const { data: storeData, error: storeError } = await supabase
                        .from('stores')
                        .select('*')
                        .eq('id', userProfile.default_store_id)
                        .single();
                    
                    if (!storeError && storeData) {
                        userProfile.default_store = storeData;
                        console.log('‚úÖ Default store loaded:', storeData.name);
                    }
                }
                
                // Always update display after profile loading
                updateUserDisplay();
                
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Even on error, try to update display with basic user data
                userProfile = {
                    id: currentUser?.id,
                    email: currentUser?.email,
                    full_name: currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'User',
                    active: true
                };
                updateUserDisplay();
                showNotification('Using basic profile info due to loading error', 'warning');
            }
        }

        async function loadDefaultStore() {
            console.log('üè™ Loading default store for user profile:', userProfile);
            console.log('User profile default_store_id:', userProfile?.default_store_id);
            console.log('User profile default_store object:', userProfile?.default_store);
            
            // First, ensure stores are loaded
            await initStores();
            
            if (userProfile?.default_store) {
                console.log('‚úÖ Using cached default store:', userProfile.default_store.name);
                selectStore(userProfile.default_store);
            } else if (userProfile?.default_store_id) {
                console.log('üîç Finding default store by ID:', userProfile.default_store_id);
                // Find the store in the loaded stores array
                const defaultStore = stores.find(store => store.id === userProfile.default_store_id);
                if (defaultStore) {
                    console.log('‚úÖ Found default store:', defaultStore.name);
                    selectStore(defaultStore);
                    // Also cache it in the profile for future use
                    userProfile.default_store = defaultStore;
                } else {
                    console.log('‚ùå Default store ID not found in stores list');
                    console.log('Available stores:', stores.map(s => ({ id: s.id, name: s.name })));
                }
            } else {
                console.log('No default store set, user will need to select one');
            }
            
            // Update user display after store selection
            updateUserDisplay();
        }

        function updateAuthUI(isAuthenticated) {
            const loginButton = document.getElementById('login-button');
            const userMenuContainer = document.getElementById('user-menu-container');
            
            if (isAuthenticated) {
                loginButton.style.display = 'none';
                userMenuContainer.style.display = 'block';
            } else {
                loginButton.style.display = 'block';
                userMenuContainer.style.display = 'none';
            }
        }

        function updateUserDisplay() {
            console.log('Updating user display with profile:', userProfile);
            console.log('Current user:', currentUser);
            console.log('Selected store:', selectedStore);
            
            if (!currentUser) {
                console.log('No current user available for display');
                return;
            }
            
            // Use userProfile if available, otherwise fallback to currentUser data
            const fullName = userProfile?.full_name || 
                             currentUser?.user_metadata?.full_name || 
                             currentUser?.email?.split('@')[0] || 'User';
                             
            const email = userProfile?.email || currentUser?.email || '';
            
            const initials = fullName
                .split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2) || '?';
            
            // Update all user display elements
            const userInitialsElement = document.getElementById('user-initials');
            const userDisplayNameElement = document.getElementById('user-display-name');
            const userCurrentStoreElement = document.getElementById('user-current-store');
            const dropdownUserNameElement = document.getElementById('dropdown-user-name');
            const dropdownUserEmailElement = document.getElementById('dropdown-user-email');
            
            if (userInitialsElement) userInitialsElement.textContent = initials;
            if (userDisplayNameElement) userDisplayNameElement.textContent = fullName;
            if (userCurrentStoreElement) userCurrentStoreElement.textContent = selectedStore?.name || 'No store selected';
            if (dropdownUserNameElement) dropdownUserNameElement.textContent = fullName;
            if (dropdownUserEmailElement) dropdownUserEmailElement.textContent = email;
            
            console.log('‚úÖ User display updated:', { fullName, email, store: selectedStore?.name });
        }

        // Auth Modal Functions
        function openAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            showLoginForm();
            populateStoreOptions();
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Welcome Back';
        }

        function showSignupForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('reset-form').classList.add('hidden');
            document.getElementById('auth-modal-title').textContent = 'Create Account';
        }

        function showResetForm() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('reset-form').classList.remove('hidden');
            document.getElementById('auth-modal-title').textContent = 'Reset Password';
        }

        async function populateStoreOptions() {
            const select = document.getElementById('signup-store');
            select.innerHTML = '<option value="">Select your primary store</option>';
            
            stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                select.appendChild(option);
            });
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                updateStatus('Signing in...');
                console.log('üîÑ Attempting login for:', email);
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    console.error('Supabase auth error:', error);
                    
                    // Handle specific error cases
                    if (error.message.includes('Email not confirmed')) {
                        updateStatus('‚ùå Email not verified');
                        showNotification('Please check your email and click the verification link before signing in', 'warning');
                        return;
                    } else if (error.message.includes('Invalid login credentials')) {
                        updateStatus('‚ùå Invalid credentials');
                        showNotification('Invalid email or password. Please check your credentials and try again.', 'error');
                        return;
                    }
                    
                    throw error;
                }
                
                console.log('‚úÖ Login successful for user:', data.user.email);
                
                currentUser = data.user;
                await loadUserProfile();
                await loadUserPermissions();
                updateAuthUI(true);
                await loadDefaultStore();
                closeAuthModal();
                
                updateStatus('‚úÖ Successfully signed in');
                showNotification(`Welcome back, ${userProfile?.full_name || 'User'}!`, 'success');
                
            } catch (error) {
                console.error('Login error:', error);
                updateStatus('‚ùå Sign in failed');
                showNotification('Login failed: ' + (error.message || 'Unknown error'), 'error');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const defaultStoreId = document.getElementById('signup-store').value;
            
            try {
                updateStatus('Creating account...');
                console.log('üîÑ Creating account for:', email, 'with default store:', defaultStoreId);
                
                // Step 1: Create Supabase auth user
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            default_store_id: defaultStoreId || null
                        }
                    }
                });
                
                if (error) {
                    console.error('Signup error:', error);
                    throw error;
                }
                
                console.log('‚úÖ Supabase user created:', data.user?.email);
                
                // Step 2: Handle post-signup profile setup
                if (data.user) {
                    // Wait briefly for auth session to establish
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    console.log('üîÑ Setting up user profile and store access...');
                    
                    // Update profile with default store (trigger should have created basic profile)
                    if (defaultStoreId) {
                        const { error: profileUpdateError } = await supabase
                            .from('user_profiles')
                            .update({ 
                                default_store_id: defaultStoreId,
                                full_name: name
                            })
                            .eq('id', data.user.id);
                        
                        if (profileUpdateError) {
                            console.error('Error updating user profile:', profileUpdateError);
                        } else {
                            console.log('‚úÖ User profile updated with default store');
                        }
                        
                        // Create store access entry
                        const { error: accessError } = await supabase
                            .from('user_store_access')
                            .upsert({
                                user_id: data.user.id,
                                store_id: defaultStoreId,
                                access_level: 'employee',
                                active: true
                            }, {
                                onConflict: 'user_id,store_id'
                            });
                        
                        if (accessError) {
                            console.error('Error creating user store access:', accessError);
                        } else {
                            console.log('‚úÖ User store access created successfully');
                        }
                    }
                    
                    // Step 3: Initialize user session
                    currentUser = data.user;
                    await loadUserProfile();
                    updateAuthUI(true);
                    await loadDefaultStore();
                    closeAuthModal();
                    
                    updateStatus('‚úÖ Account created successfully');
                    showNotification(`Welcome to TempTracker Pro, ${name}!`, 'success');
                } else {
                    showNotification('Please check your email to verify your account', 'success');
                }
                
            } catch (error) {
                console.error('Signup error:', error);
                updateStatus('‚ùå Account creation failed');
                showNotification('Error creating account: ' + error.message, 'error');
            }
        }

        async function handlePasswordReset(event) {
            event.preventDefault();
            
            const email = document.getElementById('reset-email').value;
            
            try {
                updateStatus('Sending reset link...');
                
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/reset-password'
                });
                
                if (error) throw error;
                
                updateStatus('‚úÖ Reset link sent');
                showNotification(`Password reset link sent to ${email}. Check your email!`, 'success');
                
                // Show success message and switch back to login
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
                
            } catch (error) {
                console.error('Password reset error:', error);
                updateStatus('‚ùå Failed to send reset link');
                showNotification('Error sending reset link: ' + error.message, 'error');
            }
        }

        async function handlePasswordResetCallback(accessToken, refreshToken) {
            try {
                // Set the session with the tokens from the URL
                const { data, error } = await supabase.auth.setSession({
                    access_token: accessToken,
                    refresh_token: refreshToken
                });
                
                if (error) throw error;
                
                // Prompt user for new password
                const newPassword = prompt('Please enter your new password (minimum 6 characters):');
                
                if (!newPassword) {
                    showNotification('Password reset cancelled', 'warning');
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }
                
                // Update the password
                const { error: updateError } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (updateError) throw updateError;
                
                // Clean up the URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                showNotification('‚úÖ Password updated successfully!', 'success');
                
                // Set the current user and continue with normal login flow
                currentUser = data.user;
                await loadUserProfile();
                updateAuthUI(true);
                await loadDefaultStore();
                
            } catch (error) {
                console.error('Password reset callback error:', error);
                showNotification('Error resetting password: ' + error.message, 'error');
                
                // Clean up the URL and show login
                window.history.replaceState({}, document.title, window.location.pathname);
                updateAuthUI(false);
                openAuthModal();
            }
        }

        // Admin Modal Functions
        async function openAdminSettings() {
            if (!isCurrentUserAdmin()) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            // Load current permissions and populate checkboxes
            const { data: permissions, error } = await supabase
                .from('global_permissions')
                .select('*');
            
            if (!error && permissions) {
                permissions.forEach(perm => {
                    const adminCheckbox = document.getElementById(`${perm.permission_name}_admin`);
                    const usersCheckbox = document.getElementById(`${perm.permission_name}_users`);
                    
                    if (adminCheckbox) adminCheckbox.checked = perm.enabled_for_admin;
                    if (usersCheckbox) usersCheckbox.checked = perm.enabled_for_users;
                });
            }
            
            document.getElementById('admin-modal').classList.remove('hidden');
        }
        
        function closeAdminModal() {
            document.getElementById('admin-modal').classList.add('hidden');
        }
        
        async function updatePermission(permissionName) {
            const adminCheckbox = document.getElementById(`${permissionName}_admin`);
            const usersCheckbox = document.getElementById(`${permissionName}_users`);
            
            if (!adminCheckbox || !usersCheckbox) return;
            
            await updateGlobalPermission(
                permissionName,
                adminCheckbox.checked,
                usersCheckbox.checked
            );
        }
        
        async function handleLogout() {
            try {
                updateStatus('Signing out...');
                
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                userProfile = null;
                selectedStore = null;
                
                updateAuthUI(false);
                
                // Hide main sections
                document.getElementById('temperature-section').style.display = 'none';
                document.getElementById('equipment-section').style.display = 'none';
                
                // Reset store display
                document.getElementById('selected-store-name').textContent = 'Select a store location';
                document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                
                updateStatus('‚úÖ Signed out successfully');
                showNotification('You have been signed out', 'success');
                
                // Show login modal
                openAuthModal();
                
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Error signing out', 'error');
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            const button = document.querySelector('#user-menu-container button');
            
            if (dropdown.classList.contains('hidden')) {
                // Position dropdown relative to button
                const buttonRect = button.getBoundingClientRect();
                dropdown.style.top = (buttonRect.bottom + 8) + 'px';
                dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function showProfile() {
            // TODO: Implement profile management modal
            showNotification('Profile management coming soon!', 'info');
            document.getElementById('user-dropdown').classList.add('hidden');
        }

        // Manual refresh function for debugging
        async function refreshUserProfile() {
            console.log('Manually refreshing user profile...');
            if (currentUser) {
                await loadUserProfile();
                if (userProfile?.default_store_id && !selectedStore) {
                    await loadDefaultStore();
                }
                updateUserDisplay();
                showNotification('Profile refreshed', 'success');
            }
        }

        // Debug function to check authentication status
        async function debugAuth() {
            console.log('=== AUTH DEBUG INFO ===');
            console.log('Current User:', currentUser);
            console.log('User Profile:', userProfile);
            console.log('Selected Store:', selectedStore);
            console.log('Available Stores:', stores);
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                console.log('Supabase Session:', session);
                
                if (session?.user) {
                    console.log('Session User ID:', session.user.id);
                    console.log('Session User Email:', session.user.email);
                    console.log('Email Confirmed:', session.user.email_confirmed_at);
                    
                    // Check user profile in database
                    const { data: profile, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    console.log('Database Profile:', profile);
                    if (profileError) console.log('Profile Error:', profileError);
                    
                    // Check user store access
                    const { data: storeAccess, error: accessError } = await supabase
                        .from('user_store_access')
                        .select('*, stores(*)')
                        .eq('user_id', session.user.id);
                    
                    console.log('Store Access:', storeAccess);
                    if (accessError) console.log('Store Access Error:', accessError);
                }
            } catch (error) {
                console.log('Debug Error:', error);
            }
            
            console.log('=== END DEBUG INFO ===');
        }

        // Fix function to manually set default store
        async function fixDefaultStore(storeId) {
            if (!currentUser) {
                console.log('‚ùå No current user');
                return;
            }
            
            try {
                console.log('üîß Setting default store to:', storeId);
                
                // Update user profile with new default store
                const { error } = await supabase
                    .from('user_profiles')
                    .update({ default_store_id: storeId })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // Reload profile and stores
                await loadUserProfile();
                await loadDefaultStore();
                
                console.log('‚úÖ Default store updated successfully');
                showNotification('Default store updated!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error updating default store:', error);
                showNotification('Error updating default store', 'error');
            }
        }

        // Time function removed - no longer displaying current time
        
        // Permission Management Functions
        let userPermissions = {};
        
        // Check if current user is admin
        function isCurrentUserAdmin() {
            return userProfile?.is_admin === true || userProfile?.role === 'admin';
        }
        
        // Load all permissions for current user
        async function loadUserPermissions() {
            try {
                // Load global permissions
                const { data: globalPerms, error } = await supabase
                    .from('global_permissions')
                    .select('*');
                
                if (error) throw error;
                
                // Build permissions object
                userPermissions = {};
                globalPerms.forEach(perm => {
                    // If user is admin, use admin permissions, otherwise use user permissions
                    if (isCurrentUserAdmin()) {
                        userPermissions[perm.permission_name] = perm.enabled_for_admin;
                    } else {
                        userPermissions[perm.permission_name] = perm.enabled_for_users;
                    }
                });
                
                console.log('‚úÖ Permissions loaded:', userPermissions);
                
                // After loading permissions, refresh UI
                refreshUIPermissions();
                
            } catch (error) {
                console.error('Error loading permissions:', error);
                // Default to allowing all permissions on error
                userPermissions = {
                    store_add: true,
                    store_edit: true,
                    store_delete: true,
                    store_reorder: true,
                    equipment_add: true,
                    equipment_edit: true,
                    equipment_delete: true,
                    equipment_reorder: true
                };
            }
        }
        
        // Check if current user has permission
        function checkPermission(permissionName) {
            // Always allow for admins if not explicitly disabled
            if (isCurrentUserAdmin() && userPermissions[permissionName] !== false) {
                return true;
            }
            return userPermissions[permissionName] === true;
        }
        
        // Update global permission setting (admin only)
        async function updateGlobalPermission(permissionName, enabledForAdmin, enabledForUsers) {
            if (!isCurrentUserAdmin()) {
                console.error('Only admins can update permissions');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('global_permissions')
                    .update({
                        enabled_for_admin: enabledForAdmin,
                        enabled_for_users: enabledForUsers,
                        updated_at: new Date()
                    })
                    .eq('permission_name', permissionName);
                
                if (error) throw error;
                
                console.log('‚úÖ Permission updated:', permissionName);
                
                // Reload permissions and refresh UI
                await loadUserPermissions();
                
            } catch (error) {
                console.error('Error updating permission:', error);
                showNotification('Error updating permission: ' + error.message, 'error');
            }
        }
        
        // Refresh all UI elements based on permissions
        function refreshUIPermissions() {
            updateStoreManagementUI();
            updateEquipmentManagementUI();
            updateAdminMenuVisibility();
        }
        
        // Update store-related UI elements
        function updateStoreManagementUI() {
            // Add Store button
            const addStoreBtn = document.querySelector('[onclick="openAddStoreModal()"]');
            if (addStoreBtn) {
                addStoreBtn.style.display = checkPermission('store_add') ? 'inline-flex' : 'none';
            }
            
            // Edit Store buttons
            document.querySelectorAll('[onclick*="editStore"]').forEach(btn => {
                btn.style.display = checkPermission('store_edit') ? 'inline-block' : 'none';
            });
            
            // Delete Store buttons
            document.querySelectorAll('[onclick*="deleteStore"]').forEach(btn => {
                btn.style.display = checkPermission('store_delete') ? 'inline-block' : 'none';
            });
            
            // Store drag handles
            document.querySelectorAll('.store-item .drag-handle, .store-item [title="Drag to reorder"]').forEach(handle => {
                handle.style.display = checkPermission('store_reorder') ? 'block' : 'none';
            });
        }
        
        // Update equipment-related UI elements
        function updateEquipmentManagementUI() {
            // Add Equipment button
            const addEquipmentBtn = document.querySelector('[onclick*="openEquipmentModal(\'add\'"]');
            if (addEquipmentBtn) {
                addEquipmentBtn.style.display = checkPermission('equipment_add') ? 'inline-flex' : 'none';
            }
            
            // Edit Equipment buttons
            document.querySelectorAll('[onclick*="openEquipmentModal(\'edit\'"]').forEach(btn => {
                btn.style.display = checkPermission('equipment_edit') ? 'inline-block' : 'none';
            });
            
            // Delete Equipment buttons
            document.querySelectorAll('[onclick*="deleteEquipment"]').forEach(btn => {
                btn.style.display = checkPermission('equipment_delete') ? 'inline-block' : 'none';
            });
            
            // Equipment drag handles
            document.querySelectorAll('[data-index] [title="Drag to reorder"]').forEach(handle => {
                handle.style.display = checkPermission('equipment_reorder') ? 'block' : 'none';
            });
        }
        
        // Update admin menu visibility
        function updateAdminMenuVisibility() {
            const adminDropdownItem = document.getElementById('admin-dropdown-item');
            if (adminDropdownItem) {
                if (isCurrentUserAdmin()) {
                    adminDropdownItem.classList.remove('hidden');
                    adminDropdownItem.classList.add('flex');
                } else {
                    adminDropdownItem.classList.add('hidden');
                    adminDropdownItem.classList.remove('flex');
                }
            }
        }

        // Initialize stores - Load from Supabase
        async function initStores() {
            try {
                updateStatus('Loading stores from database...');
                
                const { data, error } = await supabase
                    .from('stores')
                    .select('*')
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                stores = data || [];
                updateStoreCount();
                
                // Set default "Select a store" state instead of auto-selecting first store
                document.getElementById('selected-store-name').textContent = 'Select a store location';
                document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                document.getElementById('edit-current-store-btn').style.display = 'none';
                
                renderStoreDropdown();
                updateStatus('‚úÖ Stores loaded successfully from database');
            } catch (error) {
                console.error('Error loading stores:', error);
                updateStatus('‚ùå Error loading stores: ' + error.message);
            }
        }

        // Load equipment from Supabase
        async function loadEquipmentFromDB(storeId) {
            try {
                const { data, error } = await supabase
                    .from('equipment')
                    .select('*')
                    .eq('store_id', storeId)
                    .eq('active', true)
                    .order('name');

                if (error) throw error;

                const storeEquipment = data || [];
                equipment = equipment.filter(eq => eq.store_id !== storeId).concat(storeEquipment);
                return storeEquipment;
            } catch (error) {
                console.error('Error loading equipment:', error);
                updateStatus('‚ùå Error loading equipment: ' + error.message);
                return [];
            }
        }

        // Load temperature logs from Supabase
        async function loadTemperatureLogsFromDB(storeId, fromDate = null, toDate = null) {
            try {
                let query = supabase
                    .from('temperature_logs')
                    .select(`
                        *,
                        equipment:equipment_id (
                            id,
                            name,
                            min_temp,
                            max_temp,
                            type
                        ),
                        user_profiles:logged_by_user_id (
                            id,
                            full_name,
                            email
                        )
                    `)
                    .eq('store_id', storeId)
                    .order('logged_at', { ascending: false });

                if (fromDate && toDate) {
                    query = query.gte('logged_at', fromDate).lte('logged_at', toDate);
                }

                const { data, error } = await query.limit(100);

                if (error) throw error;

                const logs = data || [];
                temperatureLogs = temperatureLogs.filter(log => log.store_id !== storeId).concat(logs);
                return logs;
            } catch (error) {
                console.error('Error loading temperature logs:', error);
                updateStatus('‚ùå Error loading temperature logs: ' + error.message);
                return [];
            }
        }

        // Load user profiles for export functions
        async function loadUserProfiles() {
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('id, full_name, email');

                if (error) throw error;

                userProfiles = data || [];
                console.log('‚úÖ Loaded user profiles:', userProfiles.length);
                return userProfiles;
            } catch (error) {
                console.error('Error loading user profiles:', error);
                userProfiles = [];
                return [];
            }
        }

        // Update store count
        function updateStoreCount() {
            document.getElementById('total-stores').textContent = stores.length;
        }

        // Select store
        function selectStore(store) {
            selectedStore = store;
            document.getElementById('selected-store-name').textContent = store.name;
            document.getElementById('selected-store-address').textContent = store.address;
            
            // Show edit button when store is selected
            document.getElementById('edit-current-store-btn').style.display = 'block';
            
            const dropdown = document.getElementById('store-dropdown');
            dropdown.classList.add('hidden');
            renderStoreDropdown();
            
            // Update user display if authenticated
            if (currentUser) {
                updateUserDisplay();
            }
            
            // Show temperature and equipment sections
            showTemperatureSection();
            showEquipmentSection();
            loadEquipmentForStore(store.id);
            loadTemperatureData(store.id);
            showSection('temperature'); // Default to temperature tab
        }

        // Show sections
        function showEquipmentSection() {
            document.getElementById('equipment-section').style.display = 'block';
            document.getElementById('selected-store-equipment').textContent = `Managing equipment for ${selectedStore.name}`;
        }
        
        function showTemperatureSection() {
            document.getElementById('temperature-section').style.display = 'block';
            document.getElementById('selected-store-temperature').textContent = `Logging temperatures for ${selectedStore.name}`;
        }

        // Load equipment for selected store from Supabase
        async function loadEquipmentForStore(storeId) {
            try {
                updateStatus('Loading equipment...');
                const storeEquipment = await loadEquipmentFromDB(storeId);
                renderEquipmentList(storeEquipment);
                
                // Update equipment count in stats
                try {
                    document.getElementById('equipment-count').textContent = storeEquipment.length;
                } catch (error) {
                    console.log('Could not update equipment count in stats:', error);
                }
                
                updateStatus('‚úÖ Equipment loaded successfully');
            } catch (error) {
                console.error('Error in loadEquipmentForStore:', error);
                updateStatus('‚ùå Error loading equipment');
            }
        }

        // Render equipment list
        function renderEquipmentList(equipmentList) {
            const container = document.getElementById('equipment-list');
            
            if (equipmentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path>
                        </svg>
                        <p>No equipment found for this store</p>
                        <p class="text-sm mt-1">Click "Add Equipment" to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = equipmentList.map((eq, index) => `
                <div class="glass rounded-xl p-4 flex items-center justify-between card-hover transition-all duration-300" 
                     draggable="true" 
                     data-index="${index}"
                     ondragstart="handleEquipmentDragStart(event)"
                     ondragover="handleEquipmentDragOver(event)"
                     ondrop="handleEquipmentDrop(event)"
                     ondragend="handleEquipmentDragEnd(event)">
                    <div class="flex items-center space-x-4">
                        <div class="cursor-grab active:cursor-grabbing p-1 hover:bg-gray-100 rounded-lg transition-colors" title="Drag to reorder">
                            <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        <div class="p-2 rounded-lg ${eq.photo ? 'p-0' : ''}" style="background: ${eq.photo ? 'transparent' : `linear-gradient(135deg, ${getEquipmentColor(eq.type)})`};">
                            ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-lg object-cover">` : getEquipmentIcon(eq.type)}
                        </div>
                        <div>
                            <h3 class="font-bold text-gray-900">${eq.name}</h3>
                            <p class="text-sm text-gray-600">${formatEquipmentType(eq.type)} ‚Ä¢ ${eq.location || 'No location set'}</p>
                            <p class="text-xs text-gray-500">Target: ${eq.min_temp}¬∞F to ${eq.max_temp}¬∞F</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="openEquipmentModal('edit', '${eq.id}')" class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Edit Equipment">
                            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteEquipment('${eq.id}')" class="p-2 hover:bg-red-100 rounded-lg transition-colors" title="Delete Equipment">
                            <svg class="h-4 w-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Equipment helper functions
        function getEquipmentColor(type) {
            const colors = {
                freezer: 'rgb(59, 130, 246), rgb(37, 99, 235)',
                cooler: 'rgb(16, 185, 129), rgb(5, 150, 105)',
                walk_in_freezer: 'rgb(139, 92, 246), rgb(124, 58, 237)',
                walk_in_cooler: 'rgb(34, 197, 94), rgb(22, 163, 74)',
                prep_cooler: 'rgb(168, 85, 247), rgb(147, 51, 234)',
                pizza_cooler: 'rgb(245, 101, 101), rgb(239, 68, 68)',
                reach_in: 'rgb(251, 146, 60), rgb(249, 115, 22)',
                hot_holding: 'rgb(248, 113, 113), rgb(239, 68, 68)',
                oven: 'rgb(251, 113, 133), rgb(244, 63, 94)',
                other: 'rgb(107, 114, 128), rgb(75, 85, 99)'
            };
            return colors[type] || colors.other;
        }

        function getEquipmentIcon(type) {
            const icons = {
                freezer: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>',
                cooler: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path></svg>',
                walk_in_freezer: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>',
                walk_in_cooler: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path></svg>',
                oven: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"></path></svg>',
                other: '<svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 00-2 2v2a2 2 0 002 2m0 0h14m-14 0a2 2 0 002 2v2a2 2 0 01-2 2"></path></svg>'
            };
            return icons[type] || icons.other;
        }

        function formatEquipmentType(type) {
            const types = {
                freezer: 'Freezer',
                cooler: 'Cooler',
                walk_in_freezer: 'Walk-in Freezer',
                walk_in_cooler: 'Walk-in Cooler',
                prep_cooler: 'Prep Cooler',
                pizza_cooler: 'Pizza Cooler',
                reach_in: 'Reach-in Unit',
                hot_holding: 'Hot Holding',
                oven: 'Oven',
                other: 'Other'
            };
            return types[type] || type;
        }

        // Equipment modal functions
        function openEquipmentModal(mode, equipmentId = null) {
            if (!selectedStore) {
                showNotification('Please select a store first', 'error');
                return;
            }

            const modal = document.getElementById('equipment-modal');
            const title = document.getElementById('equipment-modal-title');
            const form = modal.querySelector('form');
            
            if (mode === 'add') {
                title.textContent = 'Add Equipment';
                form.reset();
                document.getElementById('equipment-id').value = '';
                // Clear photo preview
                document.getElementById('photo-preview').classList.add('hidden');
                currentEquipmentPhoto = null;
            } else if (mode === 'edit' && equipmentId) {
                const eq = equipment.find(e => e.id === equipmentId);
                if (eq) {
                    title.textContent = 'Edit Equipment';
                    document.getElementById('equipment-id').value = eq.id;
                    document.getElementById('equipment-name').value = eq.name;
                    document.getElementById('equipment-type').value = eq.type;
                    document.getElementById('equipment-min-temp').value = eq.min_temp;
                    document.getElementById('equipment-max-temp').value = eq.max_temp;
                    document.getElementById('equipment-location').value = eq.location || '';
                    
                    // Handle photo preview for editing
                    if (eq.photo) {
                        currentEquipmentPhoto = eq.photo;
                        document.getElementById('preview-image').src = eq.photo;
                        document.getElementById('photo-preview').classList.remove('hidden');
                    } else {
                        document.getElementById('photo-preview').classList.add('hidden');
                        currentEquipmentPhoto = null;
                    }
                }
            }
            
            modal.classList.remove('hidden');
            // Prevent background scrolling
            document.body.classList.add('modal-open');
        }

        function closeEquipmentModal() {
            console.log('üö™ Closing equipment modal...');
            const modal = document.getElementById('equipment-modal');
            modal.classList.add('hidden');
            
            // Reset photo preview
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('equipment-photo').value = '';
            currentEquipmentPhoto = null;
            
            // Re-enable background scrolling
            document.body.classList.remove('modal-open');
            
            console.log('‚úÖ Equipment modal closed');
        }

        // This function is now handled directly in the onclick
        // function editEquipment(equipmentId) {
        //     openEquipmentModal('edit', equipmentId);
        // }

        async function deleteEquipment(equipmentId) {
            const equipmentItem = equipment.find(e => e.id === equipmentId);
            if (!equipmentItem) {
                showNotification('Equipment not found', 'error');
                return;
            }

            // Create styled delete confirmation modal
            const deleteModal = document.createElement('div');
            deleteModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            deleteModal.style.zIndex = '9999999';
            deleteModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-5xl mb-4">üóëÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Equipment?</h3>
                        <p class="text-gray-600">"${equipmentItem.name}"</p>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start space-x-3">
                            <div class="text-red-600 text-xl">‚ö†Ô∏è</div>
                            <div class="flex-1">
                                <p class="text-sm text-red-800 font-medium mb-1">This action cannot be undone!</p>
                                <p class="text-sm text-red-700">All temperature logs for this equipment will also be deleted.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-6 bg-gray-50 rounded-lg p-3">
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-600">Type:</span>
                            <span class="text-gray-900">${formatEquipmentType(equipmentItem.type)}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-600">Location:</span>
                            <span class="text-gray-900">${equipmentItem.location || 'Not specified'}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="font-medium text-gray-600">Temp Range:</span>
                            <span class="text-gray-900">${equipmentItem.min_temp}¬∞F - ${equipmentItem.max_temp}¬∞F</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEquipmentDeleteModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmDeleteEquipment('${equipmentId}')" 
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
                            Delete Equipment
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            document.body.classList.add('modal-open');
        }

        window.closeEquipmentDeleteModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmDeleteEquipment = async function(equipmentId) {
            try {
                updateStatus('Deleting equipment...');

                // Soft delete equipment (set active = false)
                const { error } = await supabase
                    .from('equipment')
                    .update({ active: false })
                    .eq('id', equipmentId);

                if (error) throw error;

                // Remove from local equipment array
                const index = equipment.findIndex(e => e.id === equipmentId);
                if (index !== -1) {
                    equipment.splice(index, 1);
                }

                await loadEquipmentForStore(selectedStore.id);
                
                // Also reload temperature data to sync the lists
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('‚úÖ Equipment deleted successfully');
                showNotification('Equipment deleted successfully! ‚úÖ', 'success');
                
                closeEquipmentDeleteModal();

            } catch (error) {
                console.error('Error deleting equipment:', error);
                updateStatus('‚ùå Error deleting equipment: ' + error.message);
                showNotification('Error deleting equipment: ' + error.message, 'error');
            }
        };

        async function saveEquipment(event) {
            event.preventDefault();
            
            console.log('üîß Saving equipment...');
            
            // Get and disable the save button with loading state
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = `
                <div class="flex items-center justify-center space-x-2">
                    <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    <span>Saving...</span>
                </div>
            `;
            
            const equipmentId = document.getElementById('equipment-id').value;
            const equipmentData = {
                store_id: selectedStore.id,
                name: document.getElementById('equipment-name').value,
                type: document.getElementById('equipment-type').value,
                min_temp: parseFloat(document.getElementById('equipment-min-temp').value),
                max_temp: parseFloat(document.getElementById('equipment-max-temp').value),
                location: document.getElementById('equipment-location').value,
                photo: currentEquipmentPhoto,
                active: true
            };
            
            console.log('üìä Equipment data:', equipmentData);
            
            try {
                updateStatus('Saving equipment...');
                
                if (equipmentId) {
                    // Update existing equipment
                    const { data, error } = await supabase
                        .from('equipment')
                        .update(equipmentData)
                        .eq('id', equipmentId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local equipment array
                    const index = equipment.findIndex(e => e.id === equipmentId);
                    if (index !== -1) {
                        equipment[index] = data;
                    }
                    
                    console.log('‚úèÔ∏è Updated existing equipment in database');
                    showNotification('Equipment updated successfully! ‚úÖ', 'success');
                } else {
                    // Add new equipment
                    const { data, error } = await supabase
                        .from('equipment')
                        .insert(equipmentData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Add to local equipment array
                    equipment.push(data);
                    console.log('‚ûï Added new equipment to database');
                    showNotification('Equipment added successfully! ‚úÖ', 'success');
                }
                
                // Reset the photo variable for next use
                currentEquipmentPhoto = null;
                
                // Reload equipment for current store
                await loadEquipmentForStore(selectedStore.id);
                
                // Also reload temperature data to sync the lists
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('‚úÖ Equipment saved successfully');
                
                // Reset button state
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
                
                console.log('üö™ Calling closeEquipmentModal...');
                closeEquipmentModal();
                console.log('‚úÖ Save equipment complete');
                
            } catch (error) {
                console.error('Error saving equipment:', error);
                updateStatus('‚ùå Error saving equipment: ' + error.message);
                showNotification('Error saving equipment: ' + error.message, 'error');
                
                // Reset button state on error
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonText;
            }
        }

        // Toggle dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('store-dropdown');
            const chevron = document.getElementById('dropdown-chevron');
            
            if (dropdown.classList.contains('hidden')) {
                // Position the dropdown relative to the store selector button
                const storeButton = document.querySelector('[onclick="toggleDropdown()"]').closest('.w-full');
                const rect = storeButton.getBoundingClientRect();
                
                dropdown.style.top = (rect.bottom + 12) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.style.width = rect.width + 'px';
                
                dropdown.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                dropdown.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // Render store dropdown with drag-and-drop
        function renderStoreDropdown() {
            console.log('Rendering dropdown with stores:', stores);
            const storeList = document.getElementById('store-list');
            
            // Sort stores by display_order, fallback to name
            const sortedStores = [...stores].sort((a, b) => {
                if (a.display_order !== undefined && b.display_order !== undefined) {
                    return a.display_order - b.display_order;
                }
                return a.name.localeCompare(b.name);
            });
            
            storeList.innerHTML = sortedStores.map((store, index) => `
                <div class="store-item flex items-center justify-between p-4 hover:bg-green-50 transition-colors border-b border-gray-200/50 last:border-b-0 cursor-move" 
                     draggable="true" 
                     data-store-id="${store.id}" 
                     data-index="${index}"
                     ondragstart="handleStoreDragStart(event)"
                     ondragover="handleStoreDragOver(event)"
                     ondrop="handleStoreDrop(event)"
                     ondragend="handleStoreDragEnd(event)">
                    <div class="flex items-center flex-1">
                        <div class="drag-handle mr-3 text-gray-400 hover:text-gray-600" title="Drag to reorder">
                            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                            </svg>
                        </div>
                        <button onclick="selectStore(${JSON.stringify(store).replace(/"/g, '&quot;')})" 
                                class="flex-1 text-left ${selectedStore?.id === store.id ? 'font-bold' : 'text-gray-900'}" style="${selectedStore?.id === store.id ? 'color: rgb(58, 109, 55);' : ''}">
                            <p class="font-bold">${store.name}</p>
                            <p class="text-sm text-gray-600">${store.address}</p>
                            ${store.manager ? `<p class="text-xs text-gray-500 mt-1">Manager: ${store.manager}</p>` : ''}
                        </button>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="editStore('${store.id}')" class="p-2 hover:bg-gray-200 rounded-lg transition-colors" title="Edit Store">
                            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteStore('${store.id}')" class="p-2 hover:bg-red-100 rounded-lg transition-colors" title="Delete Store">
                            <svg class="h-4 w-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal functions
        function openAddStoreModal() {
            // Close dropdown first
            document.getElementById('store-dropdown').classList.add('hidden');
            document.getElementById('dropdown-chevron').style.transform = 'rotate(0deg)';
            
            // Open modal
            document.getElementById('modal-title').textContent = 'Add New Store';
            document.getElementById('store-id').value = '';
            document.getElementById('store-name').value = '';
            document.getElementById('store-address').value = '';
            document.getElementById('store-phone').value = '';
            document.getElementById('store-manager').value = '';
            document.getElementById('store-modal').classList.remove('hidden');
            
            // Prevent background scrolling
            document.body.classList.add('modal-open');
        }

        function editStore(storeId) {
            // Close dropdown first
            document.getElementById('store-dropdown').classList.add('hidden');
            document.getElementById('dropdown-chevron').style.transform = 'rotate(0deg)';
            
            const store = stores.find(s => s.id === storeId);
            if (store) {
                document.getElementById('modal-title').textContent = 'Edit Store';
                document.getElementById('store-id').value = store.id;
                document.getElementById('store-name').value = store.name;
                document.getElementById('store-address').value = store.address;
                document.getElementById('store-phone').value = store.phone || '';
                document.getElementById('store-manager').value = store.manager || '';
                document.getElementById('store-modal').classList.remove('hidden');
                
                // Prevent background scrolling
                document.body.classList.add('modal-open');
            }
        }

        // Delete store with confirmation
        async function deleteStore(storeId) {
            // Close dropdown first
            document.getElementById('store-dropdown').classList.add('hidden');
            document.getElementById('dropdown-chevron').style.transform = 'rotate(0deg)';
            
            const store = stores.find(s => s.id === storeId);
            if (!store) {
                showNotification('Store not found', 'error');
                return;
            }

            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete "${store.name}"?\n\nThis action cannot be undone and will also delete all associated equipment and temperature logs.`);
            
            if (!confirmed) {
                return;
            }

            try {
                updateStatus('Deleting store...');

                // First, soft delete the store (set active = false)
                const { error } = await supabase
                    .from('stores')
                    .update({ active: false })
                    .eq('id', storeId);

                if (error) throw error;

                // Remove from local stores array
                stores = stores.filter(s => s.id !== storeId);
                updateStoreCount();

                // If this was the selected store, reset selection
                if (selectedStore && selectedStore.id === storeId) {
                    selectedStore = null;
                    document.getElementById('selected-store-name').textContent = 'Select a store location';
                    document.getElementById('selected-store-address').textContent = 'Choose from the dropdown below';
                    document.getElementById('edit-current-store-btn').style.display = 'none';
                    
                    // Hide temperature and equipment sections
                    document.getElementById('temperature-section').style.display = 'none';
                    document.getElementById('equipment-section').style.display = 'none';
                }

                renderStoreDropdown();
                updateStatus('‚úÖ Store deleted successfully');
                showNotification('Store deleted successfully!', 'success');

            } catch (error) {
                console.error('Error deleting store:', error);
                updateStatus('‚ùå Error deleting store: ' + error.message);
                showNotification('Error deleting store: ' + error.message, 'error');
            }
        }

        function editCurrentStore(event) {
            event.stopPropagation();
            if (selectedStore) {
                editStore(selectedStore.id);
            }
        }

        function closeModal() {
            document.getElementById('store-modal').classList.add('hidden');
            // Re-enable background scrolling
            document.body.classList.remove('modal-open');
        }

        async function saveStore(event) {
            event.preventDefault();
            
            const storeId = document.getElementById('store-id').value;
            const storeData = {
                name: document.getElementById('store-name').value,
                address: document.getElementById('store-address').value,
                phone: document.getElementById('store-phone').value || null,
                manager: document.getElementById('store-manager').value || null,
                active: true
            };
            
            console.log('Saving store:', storeData);
            
            try {
                updateStatus('Saving store...');
                
                if (storeId) {
                    // Update existing store
                    const { data, error } = await supabase
                        .from('stores')
                        .update(storeData)
                        .eq('id', storeId)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local stores array
                    const index = stores.findIndex(s => s.id === storeId);
                    if (index !== -1) {
                        stores[index] = data;
                        if (selectedStore && selectedStore.id === storeId) {
                            selectStore(data);
                        }
                    }
                    
                    showNotification('Store updated successfully! ‚úÖ', 'success');
                } else {
                    // Add new store
                    const { data, error } = await supabase
                        .from('stores')
                        .insert(storeData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Add to local stores array
                    stores.push(data);
                    stores.sort((a, b) => a.name.localeCompare(b.name));
                    
                    showNotification('Store added successfully! ‚úÖ', 'success');
                }
                
                updateStoreCount();
                renderStoreDropdown();
                closeModal();
                updateStatus('‚úÖ Store saved successfully');
                
                console.log('Total stores now:', stores.length);
                console.log('All stores:', stores);
                
            } catch (error) {
                console.error('Error saving store:', error);
                updateStatus('‚ùå Error saving store: ' + error.message);
                showNotification('Error saving store: ' + error.message, 'error');
            }
        }
        function updateStatus(message) {
            const statusList = document.getElementById('status-list');
            const secondItem = statusList.children[1];
            if (secondItem) {
                secondItem.innerHTML = `
                    <span class="w-4 h-4 rounded-full mr-3 flex-shrink-0" style="background-color: rgb(58, 109, 55);"></span>
                    <span class="font-medium">${message}</span>
                `;
            }
        }
        // Dark mode functionality
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            
            // Update icon
            const themeIcon = document.getElementById('theme-icon');
            if (isDark) {
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            } else {
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            }
            
            // Save preference
            localStorage.setItem('darkMode', isDark);
        }

        // Load saved dark mode preference
        function loadDarkModePreference() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark');
                const themeIcon = document.getElementById('theme-icon');
                themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
            }
        }

        // Photo handling functions
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentEquipmentPhoto = e.target.result;
                    document.getElementById('preview-image').src = e.target.result;
                    document.getElementById('photo-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }
        
        function removePhoto() {
            currentEquipmentPhoto = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('equipment-photo').value = '';
        }
        
        async function openCamera() {
            try {
                // Check if we're on mobile or have camera access
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment', // Use back camera
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    
                    // Create camera modal
                    showCameraModal(stream);
                } else {
                    // Fallback to file input with camera capture
                    const fileInput = document.getElementById('equipment-photo');
                    fileInput.click();
                }
            } catch (error) {
                console.error('Camera access denied:', error);
                showNotification('Camera access denied. Using file picker instead.', 'error');
                // Fallback to file input
                const fileInput = document.getElementById('equipment-photo');
                fileInput.click();
            }
        }
        
        function showCameraModal(stream) {
            // Create camera modal HTML
            const cameraModal = document.createElement('div');
            cameraModal.id = 'camera-modal';
            cameraModal.className = 'fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-4';
            cameraModal.style.zIndex = '999999';
            
            cameraModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold text-gray-900">Take Photo</h3>
                            <button onclick="closeCameraModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                                ‚úï
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <video id="camera-video" class="w-full rounded-lg" autoplay playsinline></video>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="capturePhoto()" class="flex-1 glow-button text-white py-3 px-4 rounded-2xl font-semibold">
                                üì∑ Capture
                            </button>
                            <button onclick="closeCameraModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(cameraModal);
            
            // Start video stream
            const video = document.getElementById('camera-video');
            video.srcObject = stream;
            
            // Store stream reference for cleanup
            window.currentCameraStream = stream;
        }
        
        function capturePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            context.drawImage(video, 0, 0);
            
            // Convert to base64
            const photoData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Set as current photo
            currentEquipmentPhoto = photoData;
            document.getElementById('preview-image').src = photoData;
            document.getElementById('photo-preview').classList.remove('hidden');
            
            // Close camera modal
            closeCameraModal();
            
            showNotification('Photo captured successfully! üì∑', 'success');
        }
        
        window.closeCameraModal = function() {
            const modal = document.getElementById('camera-modal');
            if (modal) {
                // Stop camera stream
                if (window.currentCameraStream) {
                    window.currentCameraStream.getTracks().forEach(track => track.stop());
                    window.currentCameraStream = null;
                }
                modal.remove();
            }
        }
        
        window.capturePhoto = capturePhoto;

        // Section management
        let currentSection = 'temperature';
        let bulkModeActive = false;
        let bulkTemperatures = {};
        
        function showSection(section) {
            currentSection = section;
            
            // Hide all sections
            document.getElementById('temperature-section').style.display = 'none';
            document.getElementById('equipment-section').style.display = 'none';
            
            // Show selected section
            if (section === 'temperature' && selectedStore) {
                document.getElementById('temperature-section').style.display = 'block';
            } else if (section === 'equipment' && selectedStore) {
                document.getElementById('equipment-section').style.display = 'block';
            }
            
            // Update tab styles
            document.getElementById('temp-tab').className = section === 'temperature' 
                ? 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-white glow-button'
                : 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900';
                
            document.getElementById('equipment-tab').className = section === 'equipment'
                ? 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-white glow-button'
                : 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900';
        }
        
        // Temperature logging functions
        async function loadTemperatureData(storeId) {
            try {
                updateStatus('Loading temperature data...');
                const storeEquipment = equipment.filter(eq => eq.store_id === storeId);
                
                // If no equipment loaded yet, load it first
                if (storeEquipment.length === 0) {
                    await loadEquipmentFromDB(storeId);
                    const refreshedEquipment = equipment.filter(eq => eq.store_id === storeId);
                    renderTemperatureList(refreshedEquipment);
                } else {
                    renderTemperatureList(storeEquipment);
                }
                
                updateTemperatureStats(storeId);
                updateStatus('‚úÖ Temperature data loaded');
            } catch (error) {
                console.error('Error loading temperature data:', error);
                updateStatus('‚ùå Error loading temperature data');
            }
        }
        
        function renderTemperatureList(equipmentList) {
            const container = document.getElementById('temperature-list');
            
            if (equipmentList.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="h-12 w-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>No equipment found for temperature logging</p>
                        <p class="text-sm mt-1">Add equipment first to start logging temperatures</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = equipmentList.map(eq => {
                const lastLog = getLastTemperature(eq.id);
                const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
                const statusIcon = getStatusIcon(status);
                const statusColor = getStatusColor(status);
                
                const glowClass = getStatusGlowClass(status);
                
                return `
                    <div class="glass rounded-xl p-4 flex items-center justify-between card-hover ${glowClass} transition-all duration-300">
                        <div class="flex items-center space-x-4">
                            <div class="p-2 rounded-lg ${eq.photo ? 'p-0' : ''}" style="background: ${eq.photo ? 'transparent' : `linear-gradient(135deg, ${getEquipmentColor(eq.type)})`};">
                                ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-lg object-cover">` : getEquipmentIcon(eq.type)}
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-900">${eq.name}</h3>
                                <p class="text-sm text-gray-600">${formatEquipmentType(eq.type)} ‚Ä¢ ${eq.location || 'No location set'}</p>
                                <p class="text-xs text-gray-500">Target: ${eq.min_temp}¬∞F to ${eq.max_temp}¬∞F</p>
                                ${lastLog ? `<p class="text-xs text-gray-400 mt-1">Last: ${lastLog.temperature}¬∞F (${formatTimeAgo(lastLog.logged_at)})</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            <div class="text-center">
                                <div class="text-3xl mb-1">${statusIcon}</div>
                                <div class="text-xs font-medium" style="color: ${statusColor};">Status</div>
                            </div>
                            ${bulkModeActive ? `
                                <input type="number" 
                                       id="temp-${eq.id}" 
                                       placeholder="Temp"
                                       step="0.1"
                                       class="w-20 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center"
                                       onchange="updateBulkTemperature('${eq.id}', this.value)">
                            ` : `
                                <button onclick="openTemperatureModal('${eq.id}')" class="glow-button text-white px-4 py-2 rounded-lg font-semibold">
                                    üå°Ô∏è Log
                                </button>
                            `}
                        </div>
                    </div>
                `;   
            }).join('');
        }
        
        function getLastTemperature(equipmentId) {
            const logs = temperatureLogs.filter(log => log.equipment_id === equipmentId)
                                      .sort((a, b) => new Date(b.logged_at) - new Date(a.logged_at));
            return logs[0] || null;
        }
        
        function getTemperatureStatus(temperature, minTemp, maxTemp) {
            if (!temperature && temperature !== 0) return 'unknown';
            
            // Red (Critical): 3+ degrees below min OR 3+ degrees above max
            if (temperature <= minTemp - 3 || temperature >= maxTemp + 3) return 'critical';
            
            // Yellow (Warning): 1-2 degrees below min OR 1-2 degrees above max
            if ((temperature >= minTemp - 2 && temperature < minTemp) || 
                (temperature > maxTemp && temperature <= maxTemp + 2)) return 'warning';
            
            // Green (Good): Within range
            if (temperature >= minTemp && temperature <= maxTemp) return 'good';
            
            // Default to critical for anything else
            return 'critical';
        }
        
        function getStatusIcon(status) {
            const icons = {
                good: '‚úÖ',
                warning: '‚ö†Ô∏è',
                critical: 'üö®',
                unknown: '‚ùì'
            };
            return icons[status] || '‚ùì';
        }
        
        function getStatusColor(status) {
            const colors = {
                good: 'rgb(34, 197, 94)',
                warning: 'rgb(251, 191, 36)',
                critical: 'rgb(239, 68, 68)',
                unknown: 'rgb(156, 163, 175)'
            };
            return colors[status] || 'rgb(156, 163, 175)';
        }
        
        function getStatusGlowClass(status) {
            const classes = {
                good: 'status-glow-good',
                warning: 'status-glow-warning', 
                critical: 'status-glow-critical',
                unknown: 'status-glow-unknown'
            };
            return classes[status] || 'status-glow-unknown';
        }
        
        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            if (diffHours > 0) return `${diffHours}h ago`;
            if (diffMins > 0) return `${diffMins}m ago`;
            return 'Just now';
        }
        
        function updateTemperatureStats(storeId) {
            const storeEquipment = equipment.filter(eq => eq.store_id === storeId);
            let inRange = 0, alerts = 0;
            
            storeEquipment.forEach(eq => {
                const lastLog = getLastTemperature(eq.id);
                const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
                
                if (status === 'good') inRange++;
                if (status === 'critical' || status === 'warning') alerts++;
            });
            
            document.getElementById('in-range-count').textContent = inRange;
            document.getElementById('alert-count').textContent = alerts;
        }
        
        // Bulk mode functions
        function toggleBulkMode() {
            bulkModeActive = !bulkModeActive;
            const btn = document.getElementById('bulk-mode-btn');
            const bulkActions = document.getElementById('bulk-actions');
            
            if (bulkModeActive) {
                btn.textContent = '‚úÖ Exit Bulk';
                btn.className = 'px-6 py-3 glow-button text-white rounded-lg font-semibold';
                bulkActions.classList.remove('hidden');
            } else {
                btn.textContent = 'üìù Bulk Mode';
                btn.className = 'px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium';
                bulkActions.classList.add('hidden');
                bulkTemperatures = {};
            }
            
            // Re-render temperature list
            if (selectedStore) {
                loadTemperatureData(selectedStore.id);
            }
        }
        
        function updateBulkTemperature(equipmentId, temperature) {
            if (temperature && !isNaN(temperature)) {
                bulkTemperatures[equipmentId] = parseFloat(temperature);
            } else {
                delete bulkTemperatures[equipmentId];
            }
        }
        
        async function saveBulkTemperatures() {
            const entries = Object.keys(bulkTemperatures);
            if (entries.length === 0) {
                showNotification('No temperatures entered!', 'warning');
                return;
            }
            
            console.log('üîÑ Saving bulk temperatures:', entries.length, 'entries');
            let successCount = 0;
            
            // Save each temperature to Supabase
            for (const equipmentId of entries) {
                const temperature = bulkTemperatures[equipmentId];
                
                try {
                    const tempLogData = {
                        equipment_id: equipmentId,
                        store_id: selectedStore.id,
                        temperature: temperature,
                        logged_at: new Date().toISOString(),
                        logged_by_user_id: currentUser?.id
                    };
                    
                    console.log('üíæ Saving temperature log to Supabase:', tempLogData);
                    
                    const { data, error } = await supabase
                        .from('temperature_logs')
                        .insert(tempLogData)
                        .select();
                    
                    if (error) {
                        console.error('Error saving temperature log:', error);
                        showNotification(`Error saving temperature: ${error.message}`, 'error');
                    } else {
                        console.log('‚úÖ Temperature log saved successfully:', data);
                        successCount++;
                        
                        // Add to local array for immediate display
                        if (data && data[0]) {
                            temperatureLogs.push(data[0]);
                        }
                    }
                } catch (error) {
                    console.error('Error in bulk temperature save:', error);
                    showNotification(`Error saving temperature: ${error.message}`, 'error');
                }
            }
            
            // Clear bulk data and exit bulk mode
            bulkTemperatures = {};
            toggleBulkMode();
            
            // Refresh display
            await loadTemperatureData(selectedStore.id);
            
            if (successCount === entries.length) {
                showNotification(`‚úÖ Saved ${successCount} temperature readings to Supabase! üå°Ô∏è`, 'success');
            } else {
                showNotification(`‚ö†Ô∏è Saved ${successCount} of ${entries.length} temperatures`, 'warning');
            }
        }
        
        function clearBulkTemperatures() {
            bulkTemperatures = {};
            // Clear all input fields
            const inputs = document.querySelectorAll('[id^="temp-"]');
            inputs.forEach(input => input.value = '');
            showNotification('Bulk temperatures cleared', 'warning');
        }
        
        function openTemperatureModal(equipmentId) {
            const eq = equipment.find(e => e.id === equipmentId);
            if (!eq) return;
            
            const lastLog = getLastTemperature(equipmentId);
            const status = getTemperatureStatus(lastLog?.temperature, eq.min_temp, eq.max_temp);
            const statusIcon = getStatusIcon(status);
            const statusColor = getStatusColor(status);
            
            // Create temperature modal HTML
            const tempModal = document.createElement('div');
            tempModal.id = 'temp-log-modal';
            tempModal.className = 'fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4';
            tempModal.style.zIndex = '999999';
            
            tempModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-md w-full border border-white/40 floating">
                    <div class="p-8">
                        <div class="text-center mb-6">
                            <div class="p-3 rounded-full mx-auto mb-4 w-16 h-16 flex items-center justify-center" style="background: linear-gradient(135deg, ${getEquipmentColor(eq.type)});">
                                ${eq.photo ? `<img src="${eq.photo}" alt="${eq.name}" class="w-12 h-12 rounded-full object-cover">` : getEquipmentIcon(eq.type)}
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">üå°Ô∏è Log Temperature</h3>
                            <p class="text-lg font-semibold text-gray-800">${eq.name}</p>
                            <p class="text-sm text-gray-600">${formatEquipmentType(eq.type)} ‚Ä¢ ${eq.location || 'No location set'}</p>
                        </div>
                        
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">TARGET RANGE</p>
                                    <p class="text-lg font-bold" style="color: rgb(58, 109, 55);">${eq.min_temp}¬∞F - ${eq.max_temp}¬∞F</p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">LAST READING</p>
                                    <div class="flex items-center justify-center space-x-2">
                                        <span class="text-lg font-bold" style="color: ${statusColor};">
                                            ${lastLog ? lastLog.temperature + '¬∞F' : 'None'}
                                        </span>
                                        <span class="text-xl">${statusIcon}</span>
                                    </div>
                                    ${lastLog ? `<p class="text-xs text-gray-400 mt-1">${formatTimeAgo(lastLog.logged_at)}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <form onsubmit="saveTemperatureLog(event, '${equipmentId}')" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-3 text-center">Enter Current Temperature</label>
                                <div class="relative">
                                    <input type="number" 
                                           id="temp-input" 
                                           step="0.1" 
                                           required 
                                           autofocus
                                           class="w-full px-6 py-4 text-3xl font-bold text-center border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-blue-500/20 focus:border-blue-500 transition-all"
                                           placeholder="0.0">
                                    <span class="absolute right-6 top-1/2 transform -translate-y-1/2 text-2xl font-bold text-gray-400">¬∞F</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="flex-1 glow-button text-white py-4 px-6 rounded-2xl font-bold text-lg">
                                    üíæ Save Temperature
                                </button>
                                <button type="button" onclick="closeTempLogModal()" class="px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-2xl hover:bg-gray-50 transition-colors font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(tempModal);
            document.body.classList.add('modal-open');
            
            // Focus on input after a brief delay
            setTimeout(() => {
                const input = document.getElementById('temp-input');
                if (input) input.focus();
            }, 100);
        }
        
        window.closeTempLogModal = function() {
            const modal = document.getElementById('temp-log-modal');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        }
        
        window.saveTemperatureLog = async function(event, equipmentId) {
            event.preventDefault();
            
            const temperature = parseFloat(document.getElementById('temp-input').value);
            const eq = equipment.find(e => e.id === equipmentId);
            
            if (isNaN(temperature)) {
                showNotification('Please enter a valid temperature', 'error');
                return;
            }
            
            // Validation: reasonable temperature range
            if (temperature < -50 || temperature > 200) {
                if (!confirm(`Temperature ${temperature}¬∞F seems unusual. Are you sure this is correct?`)) {
                    return;
                }
            }

            try {
                updateStatus('Logging temperature...');

                const tempLogData = {
                    equipment_id: equipmentId,
                    store_id: selectedStore.id,
                    temperature: temperature,
                    logged_at: new Date().toISOString(),
                    logged_by_user_id: currentUser?.id
                };

                // Save to Supabase
                console.log('Attempting to save temperature log:', tempLogData);
                
                const { data, error } = await supabase
                    .from('temperature_logs')
                    .insert(tempLogData)
                    .select()
                    .single();

                if (error) {
                    console.error('Supabase temperature_logs insert error:', error);
                    console.error('Error details:', JSON.stringify(error, null, 2));
                    throw error;
                }

                // Add to local temperatureLogs array
                temperatureLogs.push(data);
                
                // Reload temperature data
                await loadTemperatureData(selectedStore.id);
                
                updateStatus('‚úÖ Temperature logged successfully');
                showNotification(`Temperature ${temperature}¬∞F logged successfully! üå°Ô∏è`, 'success');
                closeTempLogModal();

            } catch (error) {
                console.error('Error logging temperature:', error);
                updateStatus('‚ùå Error logging temperature: ' + error.message);
                showNotification('Error logging temperature: ' + error.message, 'error');
            }
        }
        
        function openTemperatureHistory() {
            if (!selectedStore) return;
            
            // Create temperature history modal
            const historyModal = document.createElement('div');
            historyModal.id = 'temp-history-modal';
            historyModal.className = 'fixed inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center p-4';
            historyModal.style.zIndex = '999999';
            
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            historyModal.innerHTML = `
                <div class="glass-strong rounded-3xl shadow-2xl max-w-6xl w-full h-[90vh] border border-white/40 floating flex flex-col">
                    <!-- Header - Compact on mobile -->
                    <div class="p-3 md:p-6 flex-shrink-0 border-b border-gray-200">
                        <div class="flex items-center justify-between mb-2 md:mb-4">
                            <div>
                                <h3 class="text-xl md:text-3xl font-bold text-gray-900 mb-1 md:mb-2">üìä Temp Reports</h3>
                                <p class="text-sm md:text-lg font-medium text-gray-600">${selectedStore.name}</p>
                            </div>
                            <button onclick="closeTempHistoryModal()" class="p-2 md:p-3 hover:bg-gray-100 rounded-xl transition-colors">
                                <svg class="h-5 w-5 md:h-6 md:w-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Tab Navigation - Smaller on mobile -->
                        <div class="flex space-x-1 md:space-x-2">
                            <button onclick="switchTempTab('summary')" id="summary-tab" class="flex-1 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-colors glow-button text-white text-sm md:text-base">
                                <span class="md:hidden">üìà Summary</span>
                                <span class="hidden md:inline">üìà Summary & Charts</span>
                            </button>
                            <button onclick="switchTempTab('details')" id="details-tab" class="flex-1 px-3 py-2 md:px-6 md:py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100 text-sm md:text-base">
                                <span class="md:hidden">üìù Details</span>
                                <span class="hidden md:inline">üìù Log Details</span>
                            </button>
                        </div>
                    </div>
                        
                    <!-- Date Range Selector (Shared) -->
                    <div class="p-4 md:p-6 flex-shrink-0 bg-gray-50 border-b border-gray-200">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div class="flex flex-col md:flex-row md:items-center gap-3 md:space-x-4">
                                <div class="flex-1 min-w-0">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                                    <input type="date" id="from-date" value="${weekAgo.toISOString().split('T')[0]}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                                    <input type="date" id="to-date" value="${today.toISOString().split('T')[0]}" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div class="md:pt-6">
                                    <button onclick="refreshTempHistory()" class="glow-button text-white px-4 py-2 rounded-lg font-semibold w-full md:w-auto">
                                        <span class="md:hidden">üîÑ</span>
                                        <span class="hidden md:inline">üîÑ Refresh</span>
                                    </button>
                                </div>
                            </div>
                            <div class="flex flex-row md:flex-row gap-2">
                                <button onclick="exportTempHistory('pdf')" class="flex-1 md:flex-none px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-semibold text-sm">
                                    <span class="md:hidden">üìÑ</span>
                                    <span class="hidden md:inline">üìÑ Export PDF</span>
                                </button>
                                <button onclick="exportTempHistory('excel')" class="flex-1 md:flex-none px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-sm">
                                    <span class="md:hidden">üìà</span>
                                    <span class="hidden md:inline">üìà Export Excel</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content Container -->
                    <div class="flex-1 overflow-hidden">
                        
                        <!-- Summary Tab Content -->
                        <div id="summary-content" class="flex-1 overflow-y-auto">
                            <div class="p-4 md:p-6">
                                <!-- Temperature Chart - Scrollable on mobile -->
                                <div class="mb-3">
                                    <div class="bg-white rounded-xl p-3 md:p-6 border border-gray-200 shadow-sm">
                                        <h4 class="text-base md:text-xl font-bold text-gray-900 mb-2 md:mb-4">üìà Temperature Trends</h4>
                                        <div id="temperature-chart" class="max-h-36 md:h-56 overflow-y-auto flex items-start justify-center text-gray-500">
                                            <div class="text-center w-full">
                                                <svg class="h-8 w-8 md:h-16 md:w-16 mx-auto mb-2 md:mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                                </svg>
                                                <p class="text-xs md:text-base">Temperature chart will be displayed here</p>
                                                <p class="text-xs mt-1">Select date range and click Refresh</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Summary Statistics - Mobile optimized -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                                    <div class="bg-green-50 p-3 md:p-4 rounded-xl border border-green-200">
                                        <div class="text-center">
                                            <div class="text-xl md:text-2xl mb-1 md:mb-2">‚úÖ</div>
                                            <div class="text-xl md:text-2xl font-bold text-green-600" id="summary-good">--</div>
                                            <div class="text-xs md:text-sm text-green-700 font-medium">In Range</div>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 md:p-4 rounded-xl border border-yellow-200">
                                        <div class="text-center">
                                            <div class="text-xl md:text-2xl mb-1 md:mb-2">‚ö†Ô∏è</div>
                                            <div class="text-xl md:text-2xl font-bold text-yellow-600" id="summary-warning">--</div>
                                            <div class="text-xs md:text-sm text-yellow-700 font-medium">Warnings</div>
                                        </div>
                                    </div>
                                    <div class="bg-red-50 p-3 md:p-4 rounded-xl border border-red-200">
                                        <div class="text-center">
                                            <div class="text-xl md:text-2xl mb-1 md:mb-2">üö®</div>
                                            <div class="text-xl md:text-2xl font-bold text-red-600" id="summary-critical">--</div>
                                            <div class="text-xs md:text-sm text-red-700 font-medium">Critical</div>
                                        </div>
                                    </div>
                                    <div class="bg-blue-50 p-3 md:p-4 rounded-xl border border-blue-200">
                                        <div class="text-center">
                                            <div class="text-xl md:text-2xl mb-1 md:mb-2">üìä</div>
                                            <div class="text-xl md:text-2xl font-bold text-blue-600" id="summary-total">--</div>
                                            <div class="text-xs md:text-sm text-blue-700 font-medium">Total Logs</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Details Tab Content -->
                        <div id="details-content" class="hidden flex-1 flex flex-col min-h-0">
                            <div class="p-3 md:p-4 border-b border-gray-200 flex-shrink-0 bg-white">
                                <h4 class="text-lg md:text-xl font-bold text-gray-900">üìù Temperature Log Details</h4>
                                <p class="text-sm text-gray-600 mt-1">Complete list of all temperature readings</p>
                            </div>
                            <div id="temp-log-table" class="flex-1 bg-white overflow-auto" style="max-height: calc(90vh - 160px); min-height: 300px;">
                                <div class="text-center text-gray-500 py-8 md:py-12">
                                    <svg class="h-12 w-12 md:h-16 md:w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                    </svg>
                                    <p class="text-base md:text-lg font-medium">Select date range and click Refresh</p>
                                    <p class="text-sm mt-2">Temperature log details will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            document.body.appendChild(historyModal);
            document.body.classList.add('modal-open');
            
            // Auto-load data for initial date range
            setTimeout(() => refreshTempHistory(), 100);
        }
        
        let currentTempTab = 'summary';
        
        window.switchTempTab = function(tab) {
            currentTempTab = tab;
            
            // Hide all tab contents
            document.getElementById('summary-content').classList.toggle('hidden', tab !== 'summary');
            document.getElementById('details-content').classList.toggle('hidden', tab !== 'details');
            
            // Update tab styles
            const summaryTab = document.getElementById('summary-tab');
            const detailsTab = document.getElementById('details-tab');
            
            if (tab === 'summary') {
                summaryTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors glow-button text-white';
                detailsTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100';
            } else {
                summaryTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors text-gray-600 hover:text-gray-900 bg-gray-100';
                detailsTab.className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-colors glow-button text-white';
            }
        }
        
        window.closeTempHistoryModal = function() {
            const modal = document.getElementById('temp-history-modal');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        }
        
        window.refreshTempHistory = async function() {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select both from and to dates', 'warning');
                return;
            }
            
            try {
                updateStatus('Loading temperature history...');
                
                const from = new Date(fromDate);
                const to = new Date(toDate + 'T23:59:59');
                
                // Load fresh data from Supabase for the date range
                const filteredLogs = await loadTemperatureLogsFromDB(
                    selectedStore.id, 
                    from.toISOString(), 
                    to.toISOString()
                );
                
                // Update summary statistics
                updateTempSummaryStats(filteredLogs);
                
                // Update table
                updateTempLogTable(filteredLogs);
                
                // Update chart (simplified text-based for now)
                updateTempChart(filteredLogs);
                
                updateStatus('‚úÖ Temperature history refreshed');
                showNotification('Temperature history updated!', 'success');
            } catch (error) {
                console.error('Error refreshing temperature history:', error);
                updateStatus('‚ùå Error refreshing temperature history');
                showNotification('Error loading temperature history', 'error');
            }
        }
        
        function updateTempSummaryStats(logs) {
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    if (status === 'good') good++;
                    else if (status === 'warning') warning++;
                    else if (status === 'critical') critical++;
                }
            });
            
            document.getElementById('summary-good').textContent = good;
            document.getElementById('summary-warning').textContent = warning;
            document.getElementById('summary-critical').textContent = critical;
            document.getElementById('summary-total').textContent = logs.length;
        }
        
        function updateTempLogTable(logs) {
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            const container = document.getElementById('temp-log-table');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="p-4">
                        <div class="text-center text-gray-500 py-12">
                            <svg class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <p class="text-lg font-medium">No temperature logs found</p>
                            <p class="text-sm mt-2">Try selecting a different date range</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            let tableHtml = `
                <div style="overflow: auto; width: 100%; height: 100%; padding-bottom: 40px;">
                    <table class="w-full" style="min-width: 800px; margin-bottom: 24px;">
                        <thead class="bg-gray-100 sticky top-0 z-10">
                            <tr>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 200px;">Equipment</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 100px;">Temperature</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 120px;">Status</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 180px;">Date & Time</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 120px;">Logged By</th>
                                <th class="px-3 md:px-6 py-3 md:py-4 text-left text-xs md:text-sm font-bold text-gray-800 border-b-2 border-gray-200" style="min-width: 100px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
            `;
            
            logs.forEach((log, index) => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    const statusIcon = getStatusIcon(status);
                    const statusColor = getStatusColor(status);
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    const isLastRow = index === logs.length - 1;
                    
                    tableHtml += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div>
                                    <div class="font-semibold text-gray-900 text-sm md:text-base">${eq.name}</div>
                                    <div class="text-xs md:text-sm text-gray-600">${formatEquipmentType(eq.type)}</div>
                                    <div class="text-xs text-gray-500">Range: ${eq.min_temp}¬∞F - ${eq.max_temp}¬∞F</div>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <span class="text-base md:text-lg font-bold">${log.temperature}¬∞F</span>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="flex items-center space-x-1 md:space-x-2">
                                    <span class="text-lg md:text-xl">${statusIcon}</span>
                                    <span class="font-medium text-xs md:text-sm" style="color: ${statusColor};">${statusText}</span>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="text-xs md:text-sm">
                                    <div class="font-medium">${new Date(log.logged_at).toLocaleDateString()}</div>
                                    <div class="text-gray-600">${new Date(log.logged_at).toLocaleTimeString()}</div>
                                </div>
                            </td>
                            <td class="px-2 md:px-4 py-2 md:py-3 text-xs md:text-sm text-gray-600 ${isLastRow ? 'pb-8' : ''}">${log.user_profiles?.full_name || 'Unknown User'}</td>
                            <td class="px-2 md:px-4 py-2 md:py-3 ${isLastRow ? 'pb-8' : ''}">
                                <div class="flex space-x-1">
                                    <button onclick="editTemperatureLog('${log.id}')" class="text-blue-600 hover:text-blue-800 text-xs md:text-sm px-2 py-1 rounded hover:bg-blue-50 transition-colors" title="Edit Temperature">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="deleteTemperatureLog('${log.id}')" class="text-red-600 hover:text-red-800 text-xs md:text-sm px-2 py-1 rounded hover:bg-red-50 transition-colors" title="Delete Temperature">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }
        
        function updateTempChart(logs) {
            const container = document.getElementById('temperature-chart');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        <svg class="h-16 w-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <p>No data available for chart</p>
                    </div>
                `;
                return;
            }
            
            // Simple text-based chart summary
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let chartData = {};
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    if (!chartData[eq.name]) {
                        chartData[eq.name] = { temps: [], dates: [], status: [] };
                    }
                    chartData[eq.name].temps.push(log.temperature);
                    chartData[eq.name].dates.push(new Date(log.logged_at));
                    chartData[eq.name].status.push(getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp));
                }
            });
            
            let chartHtml = '<div class="space-y-4">';
            
            Object.entries(chartData).forEach(([equipmentName, data]) => {
                const avgTemp = (data.temps.reduce((a, b) => a + b, 0) / data.temps.length).toFixed(1);
                const minTemp = Math.min(...data.temps);
                const maxTemp = Math.max(...data.temps);
                const goodCount = data.status.filter(s => s === 'good').length;
                const warningCount = data.status.filter(s => s === 'warning').length;
                const criticalCount = data.status.filter(s => s === 'critical').length;
                
                chartHtml += `
                    <div class="p-4 border border-gray-200 rounded-lg">
                        <h5 class="font-bold text-gray-900 mb-2">${equipmentName}</h5>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-blue-600">${avgTemp}¬∞F</div>
                                <div class="text-gray-500">Average</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-gray-600">${minTemp}¬∞F - ${maxTemp}¬∞F</div>
                                <div class="text-gray-500">Range</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-green-600">${goodCount}</div>
                                <div class="text-gray-500">Good</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-yellow-600">${warningCount}</div>
                                <div class="text-gray-500">Warning</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-red-600">${criticalCount}</div>
                                <div class="text-gray-500">Critical</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            chartHtml += '</div>';
            container.innerHTML = chartHtml;
        }
        
        window.exportTempHistory = async function(format) {
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;
            
            if (!fromDate || !toDate) {
                showNotification('Please select date range first', 'warning');
                return;
            }
            
            try {
                showNotification(`Generating ${format.toUpperCase()} export...`, 'success');
                
                // Load user profiles for export (needed for "Logged By" column)
                await loadUserProfiles();
                
                // Load data for export
                const from = new Date(fromDate);
                const to = new Date(toDate + 'T23:59:59');
                const logs = await loadTemperatureLogsFromDB(
                    selectedStore.id, 
                    from.toISOString(), 
                    to.toISOString()
                );
                
                if (logs.length === 0) {
                    showNotification('No data to export for selected date range', 'warning');
                    return;
                }
                
                // Call appropriate export function
                if (format === 'pdf') {
                    await exportToPDF(logs, fromDate, toDate);
                } else if (format === 'excel') {
                    await exportToExcel(logs, fromDate, toDate);
                }
                
                showNotification(`${format.toUpperCase()} export completed successfully!`, 'success');
            } catch (error) {
                console.error(`Error exporting ${format}:`, error);
                showNotification(`Error generating ${format.toUpperCase()} export`, 'error');
            }
        }
        
        async function exportToPDF(logs, fromDate, toDate) {
            console.log('üìÑ Starting PDF export...', { logsCount: logs.length, fromDate, toDate });
            
            if (!window.jspdf) {
                throw new Error('jsPDF library not loaded');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add header
            doc.setFontSize(20);
            doc.text('Temperature Report', 14, 22);
            
            doc.setFontSize(12);
            doc.text(`Store: ${selectedStore.name}`, 14, 32);
            doc.text(`Date Range: ${fromDate} to ${toDate}`, 14, 40);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 48);
            
            // Calculate statistics
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            logs.forEach(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                if (eq) {
                    const status = getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp);
                    if (status === 'good') good++;
                    else if (status === 'warning') warning++;
                    else if (status === 'critical') critical++;
                }
            });
            
            // Add summary statistics
            doc.setFontSize(14);
            doc.text('Summary Statistics', 14, 62);
            doc.setFontSize(11);
            doc.text(`Total Logs: ${logs.length}`, 14, 72);
            doc.text(`Good: ${good}`, 14, 80);
            doc.text(`Warning: ${warning}`, 14, 88);
            doc.text(`Critical: ${critical}`, 14, 96);
            
            // Prepare table data
            const tableData = logs.map(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                const logDate = new Date(log.logged_at);
                const user = userProfiles.find(u => u.id === log.logged_by_user_id);
                const status = eq ? getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp) : 'unknown';
                const statusText = status === 'good' ? 'Good' : status === 'warning' ? 'Warning' : status === 'critical' ? 'Critical' : 'Unknown';
                
                return [
                    logDate.toLocaleDateString(),
                    logDate.toLocaleTimeString(),
                    eq ? eq.name : 'Unknown',
                    `${log.temperature}¬∞F`,
                    statusText,
                    user ? user.full_name : 'Unknown'
                ];
            });
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Time', 'Equipment', 'Temperature', 'Status', 'Logged By']],
                body: tableData,
                startY: 106,
                styles: { fontSize: 9 },
                headStyles: { fillColor: [58, 109, 55] },
                alternateRowStyles: { fillColor: [245, 245, 245] }
            });
            
            // Save the PDF
            const filename = `Temperature_Report_${selectedStore.name}_${fromDate}_to_${toDate}.pdf`.replace(/\s+/g, '_');
            doc.save(filename);
        }
        
        async function exportToExcel(logs, fromDate, toDate) {
            console.log('üìà Starting Excel export...', { logsCount: logs.length, fromDate, toDate });
            
            if (!window.XLSX) {
                throw new Error('XLSX library not loaded');
            }
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Calculate statistics
            const storeEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
            let good = 0, warning = 0, critical = 0;
            
            const enrichedLogs = logs.map(log => {
                const eq = storeEquipment.find(e => e.id === log.equipment_id);
                const user = userProfiles.find(u => u.id === log.logged_by_user_id);
                const status = eq ? getTemperatureStatus(log.temperature, eq.min_temp, eq.max_temp) : 'unknown';
                
                if (status === 'good') good++;
                else if (status === 'warning') warning++;
                else if (status === 'critical') critical++;
                
                return {
                    'Date': new Date(log.logged_at).toLocaleDateString(),
                    'Time': new Date(log.logged_at).toLocaleTimeString(),
                    'Equipment': eq ? eq.name : 'Unknown',
                    'Type': eq ? eq.type : 'Unknown',
                    'Location': eq ? eq.location : 'Unknown',
                    'Temperature': log.temperature,
                    'Min Temp': eq ? eq.min_temp : '',
                    'Max Temp': eq ? eq.max_temp : '',
                    'Status': status.charAt(0).toUpperCase() + status.slice(1),
                    'Logged By': user ? user.full_name : 'Unknown'
                };
            });
            
            // Create summary sheet
            const summaryData = [
                ['Temperature Report Summary'],
                [],
                ['Store:', selectedStore.name],
                ['Date Range:', `${fromDate} to ${toDate}`],
                ['Generated:', new Date().toLocaleString()],
                [],
                ['Statistics'],
                ['Total Logs:', logs.length],
                ['Good:', good],
                ['Warning:', warning],
                ['Critical:', critical],
                [],
                ['Percentage Breakdown'],
                ['Good %:', logs.length > 0 ? ((good/logs.length)*100).toFixed(1) + '%' : '0%'],
                ['Warning %:', logs.length > 0 ? ((warning/logs.length)*100).toFixed(1) + '%' : '0%'],
                ['Critical %:', logs.length > 0 ? ((critical/logs.length)*100).toFixed(1) + '%' : '0%']
            ];
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Summary');
            
            // Create data sheet
            const ws_data = XLSX.utils.json_to_sheet(enrichedLogs);
            
            // Set column widths
            const colWidths = [
                {wch: 12}, // Date
                {wch: 10}, // Time
                {wch: 20}, // Equipment
                {wch: 12}, // Type
                {wch: 15}, // Location
                {wch: 12}, // Temperature
                {wch: 10}, // Min Temp
                {wch: 10}, // Max Temp
                {wch: 10}, // Status
                {wch: 20}  // Logged By
            ];
            ws_data['!cols'] = colWidths;
            
            XLSX.utils.book_append_sheet(wb, ws_data, 'Temperature Logs');
            
            // Save the Excel file
            const filename = `Temperature_Report_${selectedStore.name}_${fromDate}_to_${toDate}.xlsx`.replace(/\s+/g, '_');
            XLSX.writeFile(wb, filename);
        }

        // Store drag-and-drop variables
        let draggedStoreElement = null;
        let draggedStoreIndex = -1;

        // Store drag-and-drop handlers
        window.handleStoreDragStart = function(event) {
            draggedStoreElement = event.target;
            draggedStoreIndex = parseInt(event.target.dataset.index);
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        };

        window.handleStoreDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropTarget = event.target.closest('.store-item');
            if (dropTarget && dropTarget !== draggedStoreElement) {
                // Add visual indicator
                dropTarget.style.borderTop = '3px solid rgb(58, 109, 55)';
            }
        };

        window.handleStoreDrop = function(event) {
            event.preventDefault();
            
            const dropTarget = event.target.closest('.store-item');
            if (dropTarget && dropTarget !== draggedStoreElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                
                // Reorder stores array
                const draggedStore = stores[draggedStoreIndex];
                stores.splice(draggedStoreIndex, 1);
                stores.splice(dropIndex, 0, draggedStore);
                
                // Update display_order values
                stores.forEach((store, index) => {
                    store.display_order = index;
                });
                
                // Save new order to database
                saveStoreOrder();
                
                // Re-render dropdown
                renderStoreDropdown();
            }
            
            // Clean up visual indicators
            document.querySelectorAll('.store-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        window.handleStoreDragEnd = function(event) {
            event.target.style.opacity = '';
            draggedStoreElement = null;
            draggedStoreIndex = -1;
            
            // Clean up visual indicators
            document.querySelectorAll('.store-item').forEach(item => {
                item.style.borderTop = '';
            });
        };

        // Equipment drag-and-drop variables
        let draggedEquipmentElement = null;
        let draggedEquipmentIndex = -1;

        // Equipment drag-and-drop handlers
        window.handleEquipmentDragStart = function(event) {
            draggedEquipmentElement = event.target;
            draggedEquipmentIndex = parseInt(event.target.dataset.index);
            event.target.style.opacity = '0.5';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        };

        window.handleEquipmentDragOver = function(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const dropTarget = event.target.closest('[data-index]');
            if (dropTarget && dropTarget !== draggedEquipmentElement) {
                dropTarget.style.borderTop = '3px solid rgb(58, 109, 55)';
            }
        };

        window.handleEquipmentDrop = function(event) {
            event.preventDefault();
            
            const dropTarget = event.target.closest('[data-index]');
            if (dropTarget && dropTarget !== draggedEquipmentElement) {
                const dropIndex = parseInt(dropTarget.dataset.index);
                
                // Get current equipment for the selected store
                const currentEquipment = equipment.filter(eq => eq.store_id === selectedStore.id);
                const draggedEquipment = currentEquipment[draggedEquipmentIndex];
                
                // Reorder equipment array
                currentEquipment.splice(draggedEquipmentIndex, 1);
                currentEquipment.splice(dropIndex, 0, draggedEquipment);
                
                // Update display_order values
                currentEquipment.forEach((eq, index) => {
                    eq.display_order = index;
                });
                
                // Update the main equipment array
                equipment = equipment.filter(eq => eq.store_id !== selectedStore.id).concat(currentEquipment);
                
                // Save new order to database
                saveEquipmentOrder(currentEquipment);
                
                // Re-render equipment list
                renderEquipmentList(currentEquipment);
            }
        };

        window.handleEquipmentDragEnd = function(event) {
            event.target.style.opacity = '';
            draggedEquipmentElement = null;
            draggedEquipmentIndex = -1;
            
            // Clean up visual indicators
            document.querySelectorAll('[data-index]').forEach(item => {
                item.style.borderTop = '';
            });
        };

        // Save store order to database
        async function saveStoreOrder() {
            try {
                const updates = stores.map(store => ({
                    id: store.id,
                    display_order: store.display_order
                }));
                
                for (const update of updates) {
                    const { error } = await supabase
                        .from('stores')
                        .update({ display_order: update.display_order })
                        .eq('id', update.id);
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('Error saving store order:', error);
                showNotification('‚ùå Error saving store order: ' + error.message, 'error');
            }
        }

        // Save equipment order to database
        async function saveEquipmentOrder(equipmentList) {
            try {
                for (const eq of equipmentList) {
                    const { error } = await supabase
                        .from('equipment')
                        .update({ display_order: eq.display_order })
                        .eq('id', eq.id);
                    
                    if (error) throw error;
                }
                
            } catch (error) {
                console.error('Error saving equipment order:', error);
                showNotification('‚ùå Error saving equipment order: ' + error.message, 'error');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('store-dropdown');
            const storeSelector = event.target.closest('[onclick="toggleDropdown()"]');
            
            // If clicked outside the dropdown and not on the toggle button, close dropdown
            if (!dropdown.contains(event.target) && !storeSelector && !dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                document.getElementById('dropdown-chevron').style.transform = 'rotate(0deg)';
            }
        });

        // Close dropdown when scrolling
        document.addEventListener('scroll', function(event) {
            const dropdown = document.getElementById('store-dropdown');
            if (!dropdown.classList.contains('hidden')) {
                dropdown.classList.add('hidden');
                document.getElementById('dropdown-chevron').style.transform = 'rotate(0deg)';
            }
        });

        // Close user dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userDropdown = document.getElementById('user-dropdown');
            const userMenuContainer = document.getElementById('user-menu-container');
            
            // If clicked outside the dropdown and not on the toggle button, close dropdown
            if (userDropdown && !userDropdown.classList.contains('hidden') && 
                !userDropdown.contains(event.target) && !userMenuContainer.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Close user dropdown when scrolling
        document.addEventListener('scroll', function(event) {
            const userDropdown = document.getElementById('user-dropdown');
            if (userDropdown && !userDropdown.classList.contains('hidden')) {
                userDropdown.classList.add('hidden');
            }
        });

        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üå°Ô∏è TempTracker Pro v1.9.1 loaded successfully!');
            loadDarkModePreference();
            
            // Load stores first (needed for signup form)
            await initStores();
            
            // Check authentication state
            await checkAuthState();
        });

        // Temperature log edit/delete functions
        window.editTemperatureLog = async function(logId) {
            const log = temperatureLogs.find(l => l.id === logId);
            if (!log) {
                showNotification('Temperature log not found', 'error');
                return;
            }

            // Create styled edit modal
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            editModal.style.zIndex = '9999999';
            editModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-3">‚úèÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-900">Edit Temperature</h3>
                        <p class="text-gray-600 mt-2">${log.equipment?.name || 'Equipment'}</p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Temperature (¬∞F)</label>
                        <input type="number" id="edit-temp-input" step="0.1" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-semibold"
                               value="${log.temperature}" placeholder="Enter temperature">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEditModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmEditTemperature('${logId}')" 
                                class="flex-1 px-4 py-3 glow-button text-white rounded-lg font-semibold">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editModal);
            document.body.classList.add('modal-open');
            
            // Focus the input
            setTimeout(() => {
                const input = document.getElementById('edit-temp-input');
                input.focus();
                input.select();
            }, 100);
        };

        window.closeEditModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmEditTemperature = async function(logId) {
            const input = document.getElementById('edit-temp-input');
            const tempValue = parseFloat(input.value);
            
            if (isNaN(tempValue)) {
                showNotification('Please enter a valid temperature', 'error');
                return;
            }

            try {
                console.log('üîÑ Updating temperature log:', logId, 'to', tempValue);
                
                const { error } = await supabase
                    .from('temperature_logs')
                    .update({ temperature: tempValue })
                    .eq('id', logId);

                if (error) {
                    console.error('Error updating temperature log:', error);
                    showNotification('Error updating temperature: ' + error.message, 'error');
                    return;
                }

                console.log('‚úÖ Temperature log updated successfully');
                showNotification('Temperature updated successfully! üå°Ô∏è', 'success');
                
                closeEditModal();
                
                // Refresh the temperature history and main temperature data
                await window.refreshTempHistory();
                if (selectedStore) {
                    await loadTemperatureData(selectedStore.id);
                }
                
            } catch (error) {
                console.error('Error updating temperature log:', error);
                showNotification('Error updating temperature: ' + error.message, 'error');
            }
        };

        window.deleteTemperatureLog = async function(logId) {
            const log = temperatureLogs.find(l => l.id === logId);
            if (!log) {
                showNotification('Temperature log not found', 'error');
                return;
            }

            const equipmentName = log.equipment?.name || 'Unknown Equipment';
            const logDate = new Date(log.logged_at).toLocaleDateString();
            const logTime = new Date(log.logged_at).toLocaleTimeString();
            
            // Create styled delete confirmation modal
            const deleteModal = document.createElement('div');
            deleteModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4';
            deleteModal.style.zIndex = '9999999';
            deleteModal.innerHTML = `
                <div class="glass-strong rounded-2xl shadow-2xl max-w-md w-full p-6 border border-white/40">
                    <div class="text-center mb-6">
                        <div class="text-4xl mb-3">üóëÔ∏è</div>
                        <h3 class="text-xl font-bold text-gray-900">Delete Temperature Log?</h3>
                        <p class="text-gray-600 mt-2">This action cannot be undone</p>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6 space-y-2">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Equipment:</span>
                            <span class="text-gray-900">${equipmentName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Temperature:</span>
                            <span class="text-gray-900 font-semibold">${log.temperature}¬∞F</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Date:</span>
                            <span class="text-gray-900">${logDate}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-700">Time:</span>
                            <span class="text-gray-900">${logTime}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeDeleteModal()" 
                                class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                            Cancel
                        </button>
                        <button onclick="confirmDeleteTemperature('${logId}')" 
                                class="flex-1 px-4 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors">
                            Delete Log
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(deleteModal);
            document.body.classList.add('modal-open');
        };

        window.closeDeleteModal = function() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                document.body.classList.remove('modal-open');
                modal.remove();
            }
        };

        window.confirmDeleteTemperature = async function(logId) {
            try {
                console.log('üîÑ Deleting temperature log:', logId);
                
                const { error } = await supabase
                    .from('temperature_logs')
                    .delete()
                    .eq('id', logId);

                if (error) {
                    console.error('Error deleting temperature log:', error);
                    showNotification('Error deleting temperature: ' + error.message, 'error');
                    return;
                }

                console.log('‚úÖ Temperature log deleted successfully');
                showNotification('Temperature log deleted successfully! üóëÔ∏è', 'success');
                
                closeDeleteModal();
                
                // Refresh the temperature history and main temperature data
                await window.refreshTempHistory();
                if (selectedStore) {
                    await loadTemperatureData(selectedStore.id);
                }
                
            } catch (error) {
                console.error('Error deleting temperature log:', error);
                showNotification('Error deleting temperature: ' + error.message, 'error');
            }
        };
    </script>
    <!-- Store Dropdown Portal - Outside all stacking contexts -->
    <div id="store-dropdown" class="hidden fixed dropdown-bg rounded-2xl shadow-2xl max-h-64 overflow-y-auto" style="z-index: 999999999 !important; position: fixed !important; width: 400px;">
        <div id="store-list">
            <!-- Stores will be populated here -->
        </div>
    </div>

    <!-- User Dropdown Portal - Outside all stacking contexts -->
    <div id="user-dropdown" class="hidden fixed w-64 bg-white rounded-lg shadow-lg border border-gray-200" style="z-index: 999999999 !important; position: fixed !important;">
        <div class="p-4 border-b border-gray-100">
            <p class="font-semibold text-gray-900" id="dropdown-user-name">User Name</p>
            <p class="text-sm text-gray-600" id="dropdown-user-email">user@email.com</p>
        </div>
        <div class="py-2">
            <button onclick="showProfile()" class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/50">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                Profile Settings
            </button>
            <button id="admin-dropdown-item" onclick="openAdminSettings(); toggleUserMenu();" class="hidden items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700/50">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Admin Settings
            </button>
            <button onclick="handleLogout()" class="flex items-center w-full px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                <svg class="h-4 w-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                Sign Out
            </button>
        </div>
        <div class="px-4 py-2 border-t border-gray-100">
            <p class="text-xs text-gray-500 text-center">v1.9.1</p>
        </div>
    </div>

</body>
</html>